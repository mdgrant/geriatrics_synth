---
title: "TIVA versus Inhaled Anesthesia"
editor: source
toc-title: "**TIVA versus Inhaled Anesthesia**"
toc-location: "left"
toc-depth: 4
toc_float: 
  collapsed: false
tbl-cap-location: "top"
format: html
execute: 
  cache: false
page-layout: full
css: styles.css
tables:
      style: Table
      caption:
        pre: "Table "
        sep: " -- "
bibliography: "bib/kq4.bib"
csl: jama.csl
link-citations: false
nocite: '@*'
---

```{r read_data}
#| include: false
source("code/load_data.R")

study_char_dat <- data_kq(study_char_dat, kq4_refid) |> 
  mutate(
  surgs = ifelse(str_count(surgs, "\\|") > 3 | str_detect(surgs, "Various"), "Various", surgs))

study_arm_dat <- data_kq(study_arm_dat, kq4_refid) |> 
  mutate(arm = ifelse(arm_kq4_iv_inhale == "tiva", "TIVA", "Inhaled"))

contin_dat <- data_kq(contin_dat, kq4_refid) |> 
  left_join(study_arm_dat |> select(refid, arm_id, arm), by = c("refid", "arm_id")) |> 
  relocate(arm, .after = arm_id)

likert_dat <- data_kq(likert_dat, kq4_refid) |> 
  left_join(study_arm_dat |> select(refid, arm_id, arm), by = c("refid", "arm_id")) |> 
  relocate(arm, .after = arm_id)

# VARIABLE: delirium_inc_prop <lgl> [dichot_dat] reported incidence proportion
# VARIABLE: neurocog_inc_prop <lgl> [dichot_dat] reported incidence proportion
# VARIABLE: delirium_day_max <num> [dichot_dat] max of daily 
# VARIABLE: neurocog_day_max <num> [dichot_dat] max of daily 

dichot_dat <- data_kq(dichot_dat, kq4_refid) |>
  mutate(
    delirium_inc_prop = !is.na(delitotal_n), 
    delirium_day_max = pmax(delirium_n1, delirium_n2, delirium_n3, delilast_n, na.rm = TRUE),
    delitotal_n = ifelse(is.na(delitotal_n), delirium_day_max, delitotal_n),
  ) |> 
  relocate(delirium_day_max, .after = delitotal_n) |> 
  left_join(study_arm_dat |> select(refid, arm_id, arm), by = c("refid", "arm_id")) |> 
  relocate(arm, .after = arm_id)
  
# rob_dat <- data_kq(rob_dat, kq4_refid) 
```

## Updates
::: {.callout-important collapse="true"}
### 2024-03-05

| Date       | Modification                                                                                                                                                                    |
|:-----------|:--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 2024-03-05 | 11 studies (7 RCTs and 4 retrospective cohort studies added from updated search. |
|            | Updated relevant analyses, tables, and evidence summaries (GRADE) as appropriate.|
|            | Revised complications meta-analyses and corrected error when adjusted odds ratios from non-randomized studies were incorporated (propensity, multivariable). Resulted in some small numerical differences, but are now consistent with published results from individual studies.|
|            | Hypotension and bradycardia separated from other cardiac complications. |
|            | Included additional detail pertaining to meta-analysis methods where appropriate.|
|2024-03-07  | Added [summaries of study and patient characteristics](summary_kq4.html) to appendix.| 


```{r}
#| tbl-cap: Overview of changes to primary outcomes following search update.
#| html-table-processing: none
tiva_inhaled_dat <- readxl::read_excel("data/balance_tables_2023-09-14_mac_mg.xlsx", sheet = "TIVAInhaled", range = "A4:R21")[, c(2:4, 10, 12, 13, 15:18)] |>
  remove_empty(which = "cols") |>
  clean_names() |>
  mutate(
    across(everything(), ~ replace(.x, is.na(.x), "")),
    estimate_95_percent_ci = ifelse(estimate_95_percent_ci == "See Appendix", "See Below", estimate_95_percent_ci)
  )

tiva_inhaled_dat |>
  gt(id = "one") |>
  cols_label(
    outcome = "Outcome",
    rct = "RCT",
    nrsi = "NRSI",
    grade = "GRADE",
    measure = "Effect",
    estimate_95_percent_ci = "Est (CI)",
    rct_new = "New RCT",
    nrsi_new = "New NRSI",
    prior_est = "Old Est (CI)",
    grade_change = "GRADE Δ"
  ) |>
  cols_width(
    outcome ~ px(215),
    rct ~ px(50),
    nrsi ~ px(50),
    grade ~ px(95),
    measure ~ px(75),
    estimate_95_percent_ci ~ px(120),
    rct_new ~ px(45),
    nrsi_new ~ px(50),
    prior_est ~ px(120),
    grade_change ~ px(105),
  ) |>
  gt_theme_mg() |>
  tab_style(style = cell_text(size = "12px"), locations = cells_body(columns = everything())) |> 
  tab_style(style = cell_text(size = "11px"), locations = cells_column_labels(columns = everything())) |> 
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(rct, nrsi, rct_new, nrsi_new))) |>
  tab_style(style = list(cell_text(color = riskdiff_color)), locations = cells_body(columns = c(estimate_95_percent_ci , measure, prior_est), rows = str_detect(measure, "RD"))) |>
  tab_footnote("RCT: randomized controlled trial; NRSI: non-randomized study of intervention; GRADE: Grading of Recommendations Assessment, Development and Evaluation; Est: effect estimate; CI: confidence interval; RR: risk ratio; MD: mean difference; RD: risk difference.") |>
  tab_footnote("Corrected model fitting parameter.", locations = cells_body(columns = prior_est, rows = outcome == "Mortality (in-hospital and 30-day)")) |>
  tab_footnote("Risk ratio.", locations = cells_body(columns = prior_est, rows = nrsi == 7))

```

```{r}
#| tbl-cap: Overview of changes to adverse events following search update.
#| html-table-processing: none
tiva_inhaled_dat <- readxl::read_excel("data/balance_tables_2023-09-14_mac_mg.xlsx", sheet = "TIVAInhaled", range = "A24:R43")[, c(2:4, 10, 12, 13, 15:18)] |>
  remove_empty(which = "cols") |>
  clean_names() |>
  mutate(
    across(everything(), ~ replace(.x, is.na(.x), "")),
    estimate_95_percent_ci = ifelse(estimate_95_percent_ci == "See Appendix", "See Below", estimate_95_percent_ci)
    ) 

tiva_inhaled_dat |>
  gt(id = "one") |>
  cols_label(
    outcome = "Outcome",
    rct = "RCT",
    nrsi = "NRSI",
    grade = "GRADE",
    measure = "Effect",
    estimate_95_percent_ci = "Est (CI)",
    rct_new = "New RCT",
    nrsi_new = "New NRSI",
    prior_est = "Old Est (CI)",
    grade_change = "GRADE Δ"
  ) |>
  cols_width(
    outcome ~ px(215),
    rct ~ px(50),
    nrsi ~ px(50),
    grade ~ px(95),
    measure ~ px(75),
    estimate_95_percent_ci ~ px(120),
    rct_new ~ px(45),
    nrsi_new ~ px(50),
    prior_est ~ px(120),
    grade_change ~ px(105),
  ) |>
  gt_theme_mg() |>
  tab_style(style = cell_text(size = "12px"), locations = cells_body(columns = everything())) |> 
  tab_style(style = cell_text(size = "11px"), locations = cells_column_labels(columns = everything())) |> 
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(rct, nrsi, rct_new, nrsi_new))) |>
  tab_style(style = list(cell_text(color = riskdiff_color)), locations = cells_body(columns = c(estimate_95_percent_ci, measure, prior_est), rows = str_detect(measure, "RD"))) |>
  tab_footnote("RCT: randomized controlled trial; NRSI: non-randomized study of intervention; GRADE: Grading of Recommendations Assessment, Development and Evaluation; Est: effect estimate; CI: confidence interval; RR: risk ratio; OR: odds ratio; RD: risk difference.")

```

:::

## Key Question

Among older patients undergoing surgery with general anesthesia, does the use of intravenous agents for maintenance of anesthesia improve postoperative outcomes compared with inhaled agents?


## Balance Tables

<caption_mg> Benefits, harms, and strength of evidence (GRADE) for TIVA versus inhalation anesthesia. </caption_mg>

```{r reg_gen_balance}
kq4_balance_main("include") |> 
  text_replace("See Appendix", "See below", locations = cells_body()) 
  # text_replace("See Appendix", "See Appendix", locations = cells_body())
```

<caption_mg> Included complications and strength of evidence (GRADE) for TIVA versus inhalation anesthesia. </caption_mg>

```{r reg_gen_complications}
kq4_complications()
```

## Outcome Importance

<caption_mg> `r table_ref()` Rankings of the 5 most important outcomes (11 respondents). </caption_mg>

```{r outcome_priority}
#| include: true
#| eval: true
outcome_dat <- rankings("KQ4")
outcome_tab(outcome_dat, 11)
```

## Outcomes Reported

<caption_mg> `r table_ref()` Dichotomous or count outcomes. </caption_mg>

```{r dichot_outcome_freq}
# CODE: reporting frequency tabulation
dichot_freq_fun(dichot_dat, "ADL: activities of daily living; NCR: neurocognitive recovery; POCD: postoperative neurocognitive disorder; QoR: quality of recovery; ")
```

<caption_mg> `r table_ref()` Continuous outcomes. </caption_mg>

```{r cont_outcome_freq}
contin_freq_fun(contin_dat)
```

<caption_mg> `r table_ref()` Likert or ordinal outcomes. </caption_mg>

```{r likert_outcome_freq}
likert_freq_fun(likert_dat, "ADL: activities of daily living; NCR: neurocognitive recovery; POCD: postoperative neurocognitive disorder; QoR: quality of recovery; ")
```

## **Included Studies**

See [Appendix](summary_kq4.html) for detailed summary study and patient characteristics including primary outcomes.

<caption_mg> `r table_ref()` Number of studies by design. </caption_mg>

```{r studies_design}
# CODE: study design table — design and number; no duplicate studies for kq4
study_char_dat |>
  arrange(year) |> 
  group_by(linked_references_all_refid) |> # count 1 for multiple pubs from single study
  slice(1) |> 
  ungroup() |> 
  # select(refid, study, linked_references_all_refid, design_f_lab) |> # to check studies > 1 report
  select(refid, study, design_f_lab) |>
  group_by(design_f_lab, .drop = TRUE) |>
  summarise(total = n()) |>
  adorn_totals("row") |>
  gt(id = "one") |>
  cols_label(design_f_lab = "Design", total = "Studies") |>
  cols_width(
    # design_f_lab ~ px(200),
    design_f_lab ~ "1.8in",
    total ~ ".5in"
  ) |>
  gt_theme_mg() |> 
  tab_style(
    style = list(
      cell_fill(color = "#E4F3FE"),
      cell_text(weight = "bold"),
      cell_borders(sides = c("top", "bottom"), color = "#9A9EA1", style = "solid", weight = px(1.3))
    ),
    locations = cells_body(
      rows = design_f_lab == "Total"
    )
  ) |> 
  tab_style(
    style = list(
      cell_text(align = "left")),
      locations = cells_body(
        columns = design_f_lab
      )
    ) 
  # tab_footnote("Studies with multiple publications counted only once (applied to 1 trial with 2 publications).")
```

### Design, centers, country, and surgery

<caption_mg> `r table_ref()` Study design, enrollment, centers, country, and surgery (see [References](#references) for citations). </caption_mg>

```{r included_studies_table}
#| echo: false
included_dat <- study_char_dat |>
  mutate(study_l = study_l_w_linked) |>
  select(refid, starts_with("design"), study_l, year, n_enroll, n_analyze, centers, country, non_vh_hdi) |>
  left_join(surgs |> select(refid, surgs), by = "refid") |>
  mutate(
    design_f_lab = as.character(design_f_lab),
    # surgs = factor(surgs, levels = c("GI/Abdominal", "Cardiac", "Ortho", "Ent", "Ophtho", "Thoracic", "GI/Abdominal|Ortho|Ent", "General|Spine|Thoracic|Urol", "General|Thoracic|Urol", "Headneck", "Spine", "Urol", "Vasc", "Various"))
  ) |>
  arrange(design_f, surgs, study_l) |>
  select(refid, design_f_lab, study_l, centers, n_enroll, country, surgs, non_vh_hdi)

included_dat |>
  group_by(design_f_lab) |> 
  gt(id = "one") |>
  cols_label(
    refid = "ID",
    study_l = "Study",
    n_enroll = "Enrolled",
    country = "Country",
    centers = "Centers",
    surgs = "Surgery"
   ) |>
  cols_hide(c(non_vh_hdi, design_f_lab)) |>
    fmt_markdown(columns = c(study_l)) |> 
  cols_width(
    refid ~ px(60),
    study_l ~ px(165),
    centers ~ px(60),
    n_enroll ~ px(60),
    country ~ px(100),
    surgs ~ px(175)
  ) |> 
  fmt_number(columns = c(n_enroll, centers), use_seps = TRUE, drop_trailing_zeros = TRUE) |>
  # opt_horizontal_padding(scale = 2) |>
  # row_group_order(groups = c("GI/Abdominal", "Cardiac", "Ortho", "Ent", "Ophtho", "Thoracic", "GI/Abdominal|Ortho|Ent", "General|Spine|Thoracic|Urol", "General|Thoracic|Urol", "Headneck", "Spine", "Urol", "Various")) |>
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c("refid"))) |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(surgs))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(surgs))) |>
  opt_footnote_marks(marks = "letters") |> 
  tab_footnote(footnote = md("Described as various or more than 4 different types of surgery."), locations = cells_body(columns = surgs, surgs == "Various")) |>
  tab_footnote(footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."), 
               locations = cells_column_labels(columns = country)) |>
  tab_footnote(footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."), 
               locations = cells_body(columns = country, rows = !is.na(non_vh_hdi))) |>
  # tab_footnote(footnote = "Studies examining drugs not directly relevant to recommendations but potentially relevant to the evidence space (eg, a connected network) were included.",  locations = cells_row_groups(groups = )) |> 
  tab_footnote("GI: gastrointestinal; Ortho: orthopedic; Ent: ear, nose, and throat; Neuro: neurological; Oralmax: oral maxillofacial; Vasc: vascular.") |> 
  tab_footnote("National national administrative claims database.", locations = cells_body(columns = centers, rows = refid == 383), placement = "right") 

```

### Country Summary

<caption_mg> `r table_ref()` Summary of studies by country where conducted. </caption_mg>

```{r country}
study_char_dat |>
  mutate(linked_references = ifelse(is.na(linked_references), refid, linked_references)) |> 
  slice(1, .by = linked_references) |>
  select(country) |>
  tbl_summary(
    sort = everything() ~ "frequency",
    label = list(country ~ "Country")
  ) |>
  modify_header(label ~ "") |> 
  as_gt(id = "one") |> 
  gt_theme_mg()

```

## **Comparators**

```{r tiva_inh_tab}
tiva_inh_tab <- study_arm_dat |>
  select(refid, refid_c, arm_id, study, design_f_lab, year, arm_n, arm, asa_ps_incl, kq4_desflurane, kq4_halothane, kq4_isoflurane, kq4_sevoflurane, kq4_inhale_other, kq4_fentanyl, kq4_propofol, kq4_remifent, kq4_sufentanil, kq4_thiopentone, kq4_tiva_other, kq4_control_desc) |>
  left_join(study_char_dat |> select(refid, study_l, surg_ortho_tka, surg_ortho_tha, surg_ortho_hipfx, surg_ortho_other, surg_list, surgs, surgs_noabbr_f), by = "refid") |>
  left_join(ortho_proc |> select(refid, ortho), by = c("refid")) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |>
  left_join(table_mn_med |> select(refid, arm_id, pre_mmse), by = c("refid", "arm_id")) |>
  rename_with(~ str_replace(.x, "kq4_", "")) |>
  mutate(
    across(desflurane:inhale_other, ~ notna_to_x(.x, symbol = "\U2713")),
    across(fentanyl:tiva_other, ~ notna_to_x(.x, symbol = "\U25CF")),
    remifent = ifelse(str_detect(control_desc, "remifent") & arm == "Inhaled", "\U25CB", remifent),
    propofol = ifelse(str_detect(control_desc, "propofol") & arm == "Inhaled", "\U25CB", propofol),
    fentanyl = ifelse(str_detect(control_desc, "fentanyl") & arm == "Inhaled", "\U25CB", fentanyl),
    sufentanil = ifelse(str_detect(control_desc, "sufentanil") & arm == "Inhaled", "\U25CB", sufentanil),
    remifentanil = ifelse(str_detect(control_desc, "remifentanil") & arm == "Inhaled", "\U25CB", sufentanil),
    thiopentone = ifelse(str_detect(control_desc, "thiopentone") & arm == "Inhaled", "\U25CB", thiopentone),
    surgs = str_replace(surgs, "Ent", "ENT"),
    surgs_design = paste0(surgs, " - ", design_f_lab) 
    # surgs = str_replace(surgs, " Other", ""),
    # surgs = str_replace(surgs, "Ortho ", "Ortho — "),
    # surgs = str_replace(surgs, "\\s{1}$", "")
  ) |>
  select(refid, surgs_design, arm_id, study, study_l, arm_n, arm, asa_ps_incl, age_table, pre_mmse, surgs, surgs_noabbr_f, year, ortho, desflurane:tiva_other) |>
  arrange(surgs, year, study, arm) 
```

#### Randomized

<caption_mg> `r table_ref()` Selected characteristics of randomized clinical trials. </caption_mg>

```{r tiva_inh_rct_gt}
#| eval: true
tiva_inh_tab |>
  # randomized or nrsi
  filter(str_detect(surgs_design, "Random")) |> 
  remove_empty(which = "cols") |> 
  # tabyl(surgs_noabbr_f) |> arrange(desc(percent)) |> pull(surgs_noabbr_f) |> toString()
  # filter(!str_detect(surgs_design, "Random"))
  mutate(
    study_l = ifelse(row_number() > 1, "", study_l), 
    asa_ps_incl = ifelse(row_number() > 1, "", asa_ps_incl),
    .by = study) |>
  mutate(
    arm_n = ifelse(refid == 221, "NR", arm_n),
    asa_ps_incl = ifelse(asa_ps_incl == "NR", "", asa_ps_incl)) |> 
  group_by(surgs_noabbr_f) |>
  gt(id = "one") |>
  row_group_order(groups =  c("Gastrointestinal/Abdominal", "Various", "Thoracic", "Ophthalmologic", "Otolaryngological", "Orthopedic", "Cardiac", "Urologic", "Head & Neck", "Vascular", "Spine")) |>
  cols_hide(c(refid, arm_id, study, year, ortho, surgs_design, surgs)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = "N ",
    arm              = "Comparator",
    asa_ps_incl      = "PS",
    age_table        = "    Age",
    pre_mmse         = "MMSE",
    desflurane       = "Des",
    # halothane        = "Hal",
    isoflurane       = "Iso",
    sevoflurane      = "Sev",
    # inhale_other     = "Oth",
    fentanyl         = "Fen",
    propofol         = "Pro",
    remifent         = "Rem",
    sufentanil       = "Suf",
    tiva_other       = "Oth"
  ) |>
  tab_spanner(label = "Inhaled", columns = c(desflurane:sevoflurane), level = 1) |>
  tab_spanner(label = "ASA", columns = c(asa_ps_incl), level = 1) |>
  tab_spanner(label = "TIVA", columns = c(fentanyl:tiva_other), level = 1) |>
  fmt_markdown(columns = c(study_l, age_table, pre_mmse)) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",", columns = arm_n) |>
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(65),
    arm ~ px(80),
    asa_ps_incl ~ px(60),
    age_table ~ px(100),
    pre_mmse ~ px(100),
    desflurane ~ px(40),
    isoflurane ~ px(40),
    sevoflurane ~ px(40),
    # inhale_other ~ px(40),
    fentanyl ~ px(40),
    propofol ~ px(40),
    remifent ~ px(40),
    sufentanil ~ px(40),
    tiva_other ~ px(40)
  ) |> 
  tab_style(style = cell_text(align = "center", font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |>
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(arm_n:tiva_other), rows = str_detect(arm, "TIVA"))) |> 
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(asa_ps_incl))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(desflurane:tiva_other))) |> 
  tab_footnote(md("TIVA: total intravenous anesthesia; NR: not reported; ASA PS: ASA Physical Status; MMSE: Mini-Mental State Exam; Des: desflurane; Iso: isoflurane; Sev: sevoflurane; Fen: fentanyl; Pro: propofol; Rem: remifentanil; Suf: sufentanil; Oth: other.")) |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table, pre_mmse))) |> 
  tab_footnote("Not reported if none specified.", locations = cells_column_labels(columns = asa_ps_incl)) |> 
  tab_footnote("Thimylal.", locations = cells_body(columns = tiva_other, rows = study == "Nishikawa 2007a" & arm_id == 2)) |> 
  tab_footnote("Induction with sevoflurane; either inhalant used.", locations = cells_body(columns = c(isoflurane, sevoflurane), rows = study == "Forsmo 2016" & arm_id == 1)) |> 
  tab_footnote("Diazepam.", locations = cells_body(columns = arm, rows = study == "Salonia 2006" & arm_id == 2)) |>
  tab_footnote("Induction with sevoflurane.", locations = cells_body(columns = sevoflurane, rows = study == "Luntz 2004" & arm_id == 1)) |> 
  tab_footnote("Induction with sevoflurane.", locations = cells_body(columns = sevoflurane, rows = study == "Goins 2018" & arm_id == 1)) 
```

#### Nonrandomized

<caption_mg> `r table_ref()` Selected characteristics of nonrandomized studies. </caption_mg> 

```{r tiva_inh_nrsi_gt}
#| eval: true
tiva_inh_tab |>
  # randomized or nrsi
  filter(!str_detect(surgs_design, "Random")) |> 
  # remove_empty(which = "cols") |> 
  # tabyl(surgs_design) |> arrange(desc(percent)) |> pull(surgs_design) |> toString()
  mutate(
    study_l = ifelse(row_number() > 1, "", study_l), 
    asa_ps_incl = ifelse(row_number() > 1, "", asa_ps_incl),
    .by = study) |>
  mutate(
    arm_n = ifelse(refid == 221, "NR", arm_n),
    asa_ps_incl = ifelse(asa_ps_incl == "NR", "", asa_ps_incl)) |> 
  group_by(surgs_design) |>
  gt(id = "one") |>
  row_group_order(groups =  c("Cardiac - Retrospective Cohort", "Various - Retrospective Cohort", "GI/Abdominal - Retrospective Cohort", "General|Spine|Thoracic|Urol - Prospective Cohort", "General|Thoracic|Urol - Prospective Cohort", "Ortho - Prospective Cohort", "Ortho - Retrospective Cohort", "Thoracic - Retrospective Cohort")) |>
  cols_hide(c(refid, arm_id, study, year, ortho, surgs, surgs_noabbr_f, halothane, thiopentone, inhale_other, tiva_other)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = "N ",
    arm              = "Comparator",
    asa_ps_incl      = "PS",
    age_table        = "    Age",
    pre_mmse         = "MMSE",
    desflurane       = "Des",
    isoflurane       = "Iso",
    sevoflurane      = "Sev",
    # inhale_other     = "Oth",
    fentanyl         = "Fen",
    propofol         = "Pro",
    remifent         = "Rem",
    sufentanil       = "Suf",
    # tiva_other       = "Oth"
  ) |>
  tab_spanner(label = "Inhaled", columns = c(desflurane:inhale_other), level = 1) |>
  tab_spanner(label = "ASA", columns = c(asa_ps_incl), level = 1) |>
  tab_spanner(label = "TIVA", columns = c(fentanyl:tiva_other), level = 1) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",") |> 
  fmt_markdown(columns = c(study_l, age_table, pre_mmse)) |>
  # fmt_number(VARIABLE, decimals = 0) |>
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(65),
    arm ~ px(80),
    asa_ps_incl ~ px(60),
    age_table ~ px(100),
    pre_mmse ~ px(100),
    desflurane ~ px(40),
    isoflurane ~ px(40),
    sevoflurane ~ px(40),
    # inhale_other ~ px(40),
    fentanyl ~ px(40),
    propofol ~ px(40),
    remifent ~ px(40),
    sufentanil ~ px(40),
    # tiva_other ~ px(40)
  ) |> 
  tab_style(style = cell_text(align = "center", font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |>
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(arm_n:sufentanil), rows = str_detect(arm, "TIVA"))) |> 
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(asa_ps_incl))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(desflurane:sevoflurane))) |> 
  tab_footnote(md("TIVA: total intravenous anesthesia; NR: not reported; ASA PS: ASA Physical Status; MMSE: Mini-Mental State Exam; Des: desflurane; Iso: isoflurane; Sev: sevoflurane; Fen: fentanyl; Pro: propofol; Rem: remifentanil; Suf: sufentanil.")) |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table, pre_mmse))) |> 
  tab_footnote("Either of the two inhalent agents used.", locations = cells_body(columns = c(desflurane, sevoflurane), rows = study %in% c("Koo 2016", "Cho 2021", "Goins 2018") & arm_id == 1)) |> 
  # tab_footnote("As needed.", locations = cells_body(columns = c(remifent), rows = study == "Cho 2021" & arm_id == 1)) 
  tab_footnote("Any agent used.", locations = cells_body(columns = c(desflurane, sevoflurane, isoflurane) , rows = study == "Yoshimura 2022" & arm_id == 1)) |> 
  tab_footnote("Agent used not specified.", locations = cells_body(columns = c(desflurane, sevoflurane, isoflurane) , rows = study == "Park 2020" & arm_id == 1)) |> 
  tab_footnote("End-stage renal disease patients.", locations = cells_body(columns = c(study_l), rows = study == "Cho 2021" & arm_id == 1))

```

<a id="delirium-incidence-alt"></a>

## **Delirium Incidence**

```{r delirium_meta_dat}
delirium_meta_dat <- dichot_dat |>
  mutate(arm_n = ifelse(!is.na(deli_update_arm_n), deli_update_arm_n, arm_n)) |> # 2023-05-12 none to be updated
  filter(!is.na(delitotal_est) | !is.na(delilast_est) | !is.na(delirium_disch_est) | !is.na(delitotal_n)) |>
  left_join(study_char_dat |> select(refid, country), by = "refid") |>
  left_join(surgs |> select(refid, surgs_single_f), by = c("refid")) |>
  rename(surg_f = surgs_single_f) |>
  select(refid, refid_c, arm_id, arm_n, year, study, study_l, design_f_lab, country, surg_f, arm, delitotal_time:delitotal_95high, deli_update_arm_n, delirium_inc_prop) |>
  arrange(design_f_lab, refid_c, arm_id)

delirium_rr_ref <- delirium_meta_dat |>
   select(refid, refid_c, arm_id, delitotal_n, arm_n) |>
   arrange(refid_c, arm_id) |>
   rename(ref_deli_n = delitotal_n, ref_arm_n = arm_n) |>
   group_by(refid_c) |>
   mutate(
     ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
     ref_deli_n = ifelse(row_number() > 1, NA, ref_deli_n)
   ) |>
   fill(ref_arm_n, ref_deli_n) |>
   mutate(
     ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
     ref_deli_n = ifelse(row_number() == 1, NA, ref_deli_n)
   ) |>
   select(-refid)

delirium_meta_dat <- delirium_meta_dat |>
  remove_empty(which = "cols") |>
  left_join(delirium_rr_ref, by = c("refid_c", "arm_id")) |>
  mutate(
    calc_percent = delitotal_n / arm_n * 100,
    n_percent = n_per_fun(delitotal_n, arm_n, 1),
    rr_ci = ifelse(!is.na(ref_arm_n), rr_ci_fun(delitotal_n, arm_n, ref_deli_n, ref_arm_n), "—"),
    or_ci = ifelse(!is.na(ref_arm_n), or_ci_fun(delitotal_n, arm_n, ref_deli_n, ref_arm_n), "—"),
    ln_or = ifelse(!is.na(ref_arm_n), or_ln_te_fun(delitotal_n, arm_n, ref_deli_n, ref_arm_n), NA),
    ln_se_or = ifelse(!is.na(ref_arm_n), or_ln_se_fun(delitotal_n, arm_n, ref_deli_n, ref_arm_n), NA),
    # if reported adjusted or use
    or_ci = ifelse(!is.na(delitotal_est), format_est_ci_fun(delitotal_est, delitotal_95low, delitotal_95high), or_ci),
    ln_or = ifelse(!is.na(delitotal_est), log(delitotal_est), ln_or),
    ln_se_or = ifelse(!is.na(delitotal_est), se_ln_ci_fun(delitotal_95low, delitotal_95high), ln_se_or),
    effect = ifelse(!str_detect(design_f_lab, "Rand") & arm_id == 2, paste0("<u>", or_ci, "</u>"), rr_ci)) |> 
  relocate(calc_percent, .after = delitotal_perc) |>
  unite(compare_groups, c(surg_f, design_f_lab), sep = " – ", remove = FALSE) |> 
  left_join(delirium_scale_dichot |> select(!study), by = c("refid", "arm_id")) |>
  left_join(table_mn_med |> select(refid, arm_id, pre_mmse), by = c("refid", "arm_id")) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |>
  relocate(pre_mmse, .before = delirium_scale) |>
  relocate(age_table, .after = arm_n) |>
  select(year, refid, refid_c, design_f_lab, compare_groups, study, study_l, arm_id, arm_n, arm, age_table, pre_mmse, delirium_scale_primary, delitotal_time, delirium_inc_prop, n_percent, delitotal_n, calc_percent, effect, rr_ci, or_ci, ln_or, ln_se_or)

```

<caption_mg> `r table_ref()` Delirium incidence and days of ascertainment during hospitalization. </caption_mg>

```{r delirium_gt}
# no use of daily max est
delirium_meta_dat |>
  # tabyl(compare_groups) |> pull(compare_groups) |> toString()
  arrange(year, study, arm_id) |>
  mutate(
    delitotal_time = ifelse(delitotal_time == 999, "Stay", as.character(delitotal_time)),
    study_l = ifelse(row_number() > 1, "", study_l),
    delitotal_time = ifelse(row_number() > 1, "", delitotal_time),
    delirium_scale_primary = ifelse(row_number() > 1, "", delirium_scale_primary),
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(calc_percent, "#A93226"),
      .default = bar_prop(calc_percent, "#969696")
    ),
    .by = study_l
  ) |>
  group_by(compare_groups) |>
  gt(id = "one") |>
  row_group_order(groups = c("GI/Abd – Randomized Clinical Trial", "Ortho – Randomized Clinical Trial", "Various – Randomized Clinical Trial", "Cardiac – Retrospective Cohort", "Various – Prospective Cohort", "Various – Retrospective Cohort")) |>
  cols_hide(c(year, refid, refid_c, design_f_lab, arm_id, study, design_f_lab, age_table, pre_mmse, calc_percent, rr_ci:ln_se_or, delirium_inc_prop, delitotal_n)) |>
  cols_label(
    study_l = "Study",
    arm_n = " N",
    # age_table = "  Age",
    arm = "Arm",
    # pre_mmse = md("  MMSE<br/>  (preop)"),
    delirium_scale_primary = "Scale",
    delitotal_time = "Day(s)",
    n_percent = "N (%)",
    bar = "0 – 100%",
    effect = md("RR <u>OR</U> (95% CI)")
  ) |>
  tab_spanner(label = "Incidence Proportion", columns = c(n_percent, bar)) |>
  fmt_markdown(columns = c(study_l, bar, effect)) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",") |> 
  sub_values(columns = effect, rows = study %in% c("Nishikawa 2004", "Tanaka 2017"), pattern = ".*", replacement = "") |> # 0 events in an arm 
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(70),
    # age_table ~ px(100),
    arm ~ px(70),
    # pre_mmse ~ px(95),
    delirium_scale_primary ~ px(105),
    delitotal_time ~ px(55),
    n_percent ~ px(90),
    bar ~ px(100),
    effect ~ px(140)
  ) |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(study, arm, delirium_scale_primary))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(arm_n, delitotal_time, effect))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_column_labels(columns = c(n_percent, effect))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_body(columns = c(n_percent))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(arm, delirium_scale_primary, bar))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(delitotal_time, effect))) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n:n_percent), rows = str_detect(arm, "TIVA"))) |>
  tab_footnote("RR: risk ratio; OR: odds ratio; DRS: Delirium Rating Scale; CAM: Confusion Assessment Method; KNDSS: Korean Nursing Delirium Screening Scale; NS: not specified.") |>
  # tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table, pre_mmse))) |>
  tab_footnote("Day(s) over which incidence proportion assessed. Stay indicates duration of hospitalization.", locations = cells_column_labels(columns = delitotal_time)) |> 
  tab_footnote("Adjusted from multivariable model.", locations = cells_body(columns = effect, rows = study %in% c("Goins 2018", "Chang 2022") & arm_id == 2)) |> 
  tab_footnote("Calculated crude odds ratio.", locations = cells_body(columns = effect, rows = study %in% c("Huang 2023b", "Deiner 2014") & arm_id == 2)) |> 
  tab_footnote("Propensity score matched.", locations = cells_body(columns = effect, rows = study == "Yoshimura 2022" & arm_id == 2)) |>
  tab_footnote("Or new antipsychotic prescription.", locations = cells_body(columns = delirium_scale_primary, rows = study == "Yoshimura 2022" & arm_id == 1)) 

```

### *Pooled*

#### Randomized

<caption_mg> `r figure_ref()` Delirium incidence (randomized clinical trials). </caption_mg> 

```{r delirium_meta_rct_nrsi_dat}
delirium_all_meta_dat <- delirium_meta_dat |> 
  rename(n = delitotal_n) |> 
  select(refid, year, study, design_f_lab, arm, n, arm_n) 

pairs_dat <- pairwise(
  treat = arm,
  event = n,
  n = arm_n,
  studlab = study,
  data = delirium_all_meta_dat,
  sm = "RR",
  keep.all.comparisons = TRUE
)

pairwise_dat <- pairs_dat |>
  select(refid, studlab, treat1, treat2, event1, n1, event2, n2, year, design_f_lab, year) |>
  mutate(
    treat2 = "TIVA",
    treat1 = "Inhaled"
  ) |>
  rename(study = studlab)

delirium_rct_meta_dat <- pairwise_dat |> 
  filter(str_detect(design_f_lab, "Rand")) |>
  left_join(rob2_meta_dat, by = "refid") |> 
  select(-design_f_lab) |> 
  arrange(year, study)

delirium_nsri_meta_dat <- pairwise_dat |> 
  filter(!str_detect(design_f_lab, "Rand")) |> 
  left_join(delirium_meta_dat |> slice(2, .by = refid) |> select(refid, ln_or, ln_se_or), by = "refid") |> 
  left_join(robinsi_meta_dat, by = "refid") |> 
  select(-design_f_lab) |> 
  arrange(year, study)

rm(delirium_all_meta_dat)

delirium_meta_rct <- metabin(event2, n2, event1, n1,
  data = delirium_rct_meta_dat,
  studlab = study,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  method.random.ci = "HK",
  method.predict = "HK",
  prediction = TRUE,
  allstudies = TRUE,
)

delirium_meta_rct_rd <- update(delirium_meta_rct, sm = "RD")

```

```{r delirium_meta_rct}
#| include: false

png("assets/kq4_delirium_meta_rct.png", width = 9.95, height = 4.0, units = "in", res = 300)
forest(delirium_meta_rct,
  allstudies = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "Overall"),
  rightlabs = c("RR", "(95% CI)", "D1", "D2", "D3", "D4", "D5", "All"),
  just.addcols.right = "right",
  digits.TE = 3,
  digits.tau2 = 2,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  # xlim = c(0.05, 20),
  xlab = "Favors: TIVA                             Inhaled",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  xlim = c(0.2, 4)
)
dev.off()

```
![](assets/kq4_delirium_meta_rct.png){fig.align="left" width="73%"}

<foot_mg> RR: risk ratio; D1: bias arising from the randomization process; D2: bias due to deviations from intended interventions; D3: bias due to missing outcome data; D4: bias in measurement of the outcome; D5: bias in selection of the reported result: All: overall risk of bias.<br/> Risk of bias ratings: low +, some concerns ?, high -- . <br/> Continuity correction of 0.5 added to studies with no events in one arm. </foot_mg><br/>

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### Meta-analysis methods detail.

```{r}
#| include: false
temp <- print(delirium_meta_rct) |> 
  str_replace_all("\\n", "<br/> ") |>
  str_remove("<br/> Details on meta-analytical method:<br/> ") |> 
  str_replace_all("tau\\^2", "tau<sup>2</sup>") |> 
  str_replace_all("tau", "&tau;")
```

<foot_mg> `r temp` </foot_mg>
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delirium incidence (randomized clinical trials; risk difference per 100). </caption_mg> <a id="kq4_delirium_risk-diff"></a>

```{r kq4_delirium_meta_forest_rd}
#| echo: false
#| include: false

# get scaled tau
delirium_meta_rct_rd$tau <- delirium_meta_rct_rd$tau * 100

png("assets/kq4_delirium_meta_forest_rd.png", width = 9.88, height = 4.0, units = "in", res = 300)
forest(delirium_meta_rct_rd,
  allstudies = TRUE,
  common = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "Overall"),
  rightlabs = c("RD", "(95% CI)", "D1", "D2", "D3", "D4", "D5", "All"),
  just.addcols.right = "right",
  digits = 1,
  print.tau2 = FALSE,
  print.tau = TRUE,
  digits.tau = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  # sortvar = year,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  xlim = c(-20, 20),
  pscal = 100,
  xlab = "Favors: TIVA                          Inhaled",
  addrows.below.overall = 4,
  fs.test.subgroup = 10,
  fs.hetstat = 10,
)
dev.off()
```
![](assets/kq4_delirium_meta_forest_rd.png){fig.align="left" width="73%"}
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delirium incidence (small study effects). </caption_mg>

```{r kq4_delirium_funnel_limit} 
#| echo: false
#| include: false

delirium_meta_or <- update(delirium_meta_rct, sm = "OR")

png("assets/kq4_delirium_or_funnel.png", width = 8.5, height = 5.5, units = "in", res = 300)
par(mar = c(4, 4, 2, 1))
limit_colors <- c("#AAB7B8", "#D5DBDB", "#F4F6F6")
# text(1.2, 0.05, labels = "Adjusted estimate", col = "darkgray", pos = 3, cex = .9)
par(bty = "n", xaxt = "s", yaxt = "s")
funnel(delirium_meta_or,  pch = 20, contour = c(0.9, 0.95, 0.99), col.contour = limit_colors, studlab = TRUE, pos.studlab = 4, fs.smlab = 6, ff.smlab = "italic")
legend(0.1, 0.02, c("0.1 > p > 0.05", "0.05 > p > 0.01", "< 0.01"), fill = c("#AAB7B8", "#D5DBDB", "#F4F6F6"), bty = "n")
dev.off()

```

![](assets/kq4_delirium_or_funnel.png){width="70%"}
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Control arm/baseline risk (inhaled anesthesia) and risk ratios. </caption_mg> <a id="bubble-plot"></a>
```{r bubble_plot_delirium}
#| echo: false
#| include: false

temp <- bubble_plot_data(delirium_meta_rct) 

fitted_meta <- metafor::rma(yi_meta, vi_meta, mods = ~ control_event_rate, slab = slab, data = temp)

png("assets/kq4_delirium_meta_bubble.png", width = 8, height = 6, units = "in", res = 300)
par(bty = "n", xaxt = "s", yaxt = "s", mar = c(4, 4, 2, 1))
metafor::regplot(fitted_meta,
  xlab = "Inhalation anesthesia event rate (baseline risk)",
  ylab = "RR (risk ratio)", 
  xlim = c(-0.04, 0.5),
    at = log(c(0.2, 0.4, 0.7, 0.94, 2, 4, 8)),
  # predlim = c(0, 0.30),
  atransf = exp,
  labsize = 0.7, 
  predlim = c(0, 0.445),
  las = 1,
  label = TRUE,
  offset = c(0.8),
  lwd = 0.5,
)

plotrix::ablineclip(log(0.94), 0, col = "red", lty = 2, lwd = 0.75, x1 = -.02, x2 = 0.465)
dev.off()

rm(temp, fitted_meta)

```

![](assets/kq4_delirium_meta_bubble.png){width="75%"}

<foot_mg> No suggestion for dependence of risk ratio on baseline risk.</foot_mg> 

:::

<a id="delirium_meta_rct_nrsi"></a>

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delirium incidence summary risk of bias in randomized clinical trials (weighted). </caption_mg>

```{r rob2_summary_delirium, fig.height = 3, out.width = "60%"}
rob_summary_meta_weighted_fun(delirium_meta_rct)
# rob_summary_fun(delirium_meta_dat$refid)
```
:::

#### Nonrandomized 

<caption_mg> `r figure_ref()` Delirium incidence (nonrandomized designs). </caption_mg> 

```{r delirium_meta_nrsi}
delirium_meta_nrsi <- metagen(
  ln_or, ln_se_or,
  data = delirium_nsri_meta_dat,
  sm = "OR",
  backtransf = TRUE
)

# delirium_nsri_meta_dat |> summarise(inhaled_tot = sum(n1), tiva_tot = sum(n2), all_tot = sum(n1 + n2), inhaled_events = sum(event1), tiva_events = sum(event2)) 

```

```{r delirium_meta_nrsi_forest}
#| echo: false
#| include: false

png("assets/kq4_delirium_meta_nrsi.png", width = 10.85, height = 3.2, units = "in", res = 300)
forest(delirium_meta_nrsi,
  allstudies = TRUE,
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "Overall"),
  rightlabs = c("OR", "(95% CI)  ", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "All"),
  leftcols = c("study", "event2", "n2", "event1", "n1"), 
  leftlabs = c("Study", "Events", "TIVA    \n Total", "Events", "Inhaled\n Total"),
  just.addcols.right = "center",
  just.addcols.left = "right",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  big.mark = ",",
  print.pval.Q = FALSE,
  xlim = c(0.1, 10),
  xlab = "Favors: TIVA                             Inhaled",
  addrows.below.overall = 4,
  fs.hetstat = 10,
)
dev.off()

```
![](assets/kq4_delirium_meta_nrsi.png){fig.align="left" width="78%"}

<foot_mg> D1: Bias due to confounding; D2: Bias in selection of participants into the study; D3: Bias in classification of interventions; D4: Bias due to deviations from intended interventions; D5: Bias due to missing data; D6: Bias in measurement of outcomes; D7: Bias in selection of reported results; All: overall risk of bias (ratings: low ++, moderate +, serious -, critical - - ; NI: no information; NA: not applicable). <br/> Note: adjusted odds ratios pooled from Yoshimura 2022 (propensity matching); Goins 2018 and Chang 2022 (multivariable adjustment). </foot_mg>

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### Meta-analysis methods detail.

```{r}
#| include: false  

temp <- print(delirium_meta_nrsi) |> 
  str_replace_all("\\n", "<br/> ") |>
  str_remove("<br/> Details on meta-analytical method:<br/> ") |> 
  str_replace_all("tau\\^2", "tau<sup>2</sup>") |> 
  str_replace_all("tau", "&tau;")

```

<foot_mg> `r temp` </foot_mg>
:::

## **Delayed Neurocognitive Recovery**

```{r dncr_ncd_dat}
#| eval: true

## dncr_dat ------------------------------------------- (2023-04-15 15:55) @----
dncr_dat <- dichot_dat |>
  filter(if_any(c(neurocog_n1, neurocog_n2, neurocog_n3, neurocog_last_n, neurocog_total_n), ~ !is.na(.x))) |>
  # > 30 day exam
  filter(if_any(matches("neurocog.*time.*"), ~ .x <= 30)) |> 
  # select(refid, study, arm_n, neurocog_update_arm_n, neurocog_n1, neurocog_n2, neurocog_n3, neurocog_last_n, neurocog_total_n, matches("neurocog.*time"), contains("neurocog_update_arm")) |>
  mutate(
    across(contains("neurocog_update_arm"), \(x) as.numeric(x)),
    neurocog_n1 = ifelse(neurocog_time1 > 30, NA, neurocog_n1),
    neurocog_n2 = ifelse(neurocog_time2 > 30, NA, neurocog_n2),
    neurocog_n3 = ifelse(neurocog_time3 > 30, NA, neurocog_n3),
    neurocog_last_n = ifelse(neurocog_last_time > 30, NA, neurocog_last_n),
    neurocog_total_n = ifelse(neurocog_total_time > 30, NA, neurocog_total_n),
    neurocog_time1 = ifelse(neurocog_time1 > 30, NA, neurocog_time1),
    neurocog_time2 = ifelse(neurocog_time2 > 30, NA, neurocog_time2),
    neurocog_time3 = ifelse(neurocog_time3 > 30, NA, neurocog_time3),
    neurocog_last_time = ifelse(neurocog_last_time > 30, NA, neurocog_last_time),
    neurocog_total_time = ifelse(neurocog_total_time > 30, NA, neurocog_total_time),
    # select time furthest from surgery
    dncr_time = pmax(neurocog_time1, neurocog_time2, neurocog_time3, neurocog_last_time, neurocog_total_time, na.rm = TRUE),
    # select total corresponding to time
    neurocog_total_n = case_when(
      neurocog_time1 == dncr_time ~ neurocog_n1,
      neurocog_time2 == dncr_time ~ neurocog_n2,
      neurocog_time3 == dncr_time ~ neurocog_n3,
      neurocog_last_time == dncr_time ~ neurocog_last_n,
      neurocog_total_time == dncr_time ~ neurocog_total_n
    ),
    # update arm_n corresponding to time if necessary 2024-02-27 applies ot Konishi2018
    arm_n = case_when(
      !is.na(neurocog_update_arm_n_t1) & neurocog_time1 == dncr_time       ~ neurocog_update_arm_n_t1,
      !is.na(neurocog_update_arm_n_t2) & neurocog_time2 == dncr_time       ~ neurocog_update_arm_n_t2,
      !is.na(neurocog_update_arm_n_t3) & neurocog_time3 == dncr_time       ~ neurocog_update_arm_n_t3,
      !is.na(neurocog_update_arm_n_last) & neurocog_last_time == dncr_time ~ neurocog_update_arm_n_last,
      !is.na(neurocog_update_arm_n)                                        ~ neurocog_update_arm_n, # corresponding to first time
      .default = arm_n
    ),
    neurocog_prop = neurocog_total_n/arm_n,
    neurocog_nper = n_per_fun(neurocog_total_n, arm_n, 1)
  ) |>
  left_join(study_char_dat |> select(refid, country, neuro_threshold), by = "refid") |>
  left_join(surgs |> select(refid, surgs_single_f, surgs_noabbr_f), by = c("refid")) |>
  left_join(table_mn_med |> select(refid, arm_id, pre_mmse), by = c("refid", "arm_id")) |>
  left_join(neurocog_scale_dichot |> select(-study), by = "refid") |> 
  rename(surg_f = surgs_single_f) |>
  arrange(refid_c, arm_id) |> 
  mutate(
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(neurocog_prop * 100, "#A93226"),
      .default = bar_prop(neurocog_prop * 100, "#969696")),
    year = as.numeric(str_extract(study, "\\d{4}")),
    across(c(arm, design_f_lab, surg_f), ~ fct_drop(.x)),
    scale_mmse = ifelse(neurocog_scale == "MMSE", "\U2713", NA),
    scale_moca = ifelse(neurocog_scale == "MoCA", "\U2713", NA),
    scale_fail2 = ifelse(neurocog_scale == "Failed 2", "\U2713", NA),
    scale_ns = ifelse(neurocog_scale == "NS", "\U2713", NA),
  ) |> 
  select(refid, refid_c, year, arm_id, study, study_l, design_f_lab, pre_mmse, country, surg_f, surgs_noabbr_f, arm, pre_mmse, dncr_time, neurocog_total_n, arm_n, arm, neurocog_nper, neurocog_prop, bar, scale_mmse:scale_ns, neuro_threshold, contains("neurocog_update_arm"))

# add referents for rr calculation
dncr_rr_ref <- dncr_dat |>
  select(refid, refid_c, arm_id, neurocog_total_n, arm_n) |>
  arrange(refid_c, arm_id) |>
  rename(ref_neurocog_n = neurocog_total_n, ref_arm_n = arm_n) |>
  group_by(refid_c) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_neurocog_n = ifelse(row_number() > 1, NA, ref_neurocog_n)
  ) |>
  fill(ref_arm_n, ref_neurocog_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_neurocog_n = ifelse(row_number() == 1, NA, ref_neurocog_n)
  ) |>
  select(-refid)

# DATA: neurocog_allarms_meta_dat for subsequent pooling, arms not collapsed
neurocog_allarms_meta_dat <- dncr_dat |> 
  select(refid, study, design_f_lab, year, arm_id, arm, neurocog_total_n, arm_n, dncr_time, surgs_noabbr_f) 

dncr_dat <- dncr_dat |> 
  left_join(dncr_rr_ref, by = c("refid_c", "arm_id")) |> 
  mutate(rr_ci = ifelse(!is.na(ref_arm_n), rr_ci_fun(neurocog_total_n, arm_n, ref_neurocog_n, ref_arm_n), "—")) |> 
  select(refid, year, design_f_lab, surg_f, surgs_noabbr_f, study, study_l, arm_id, arm_n, arm, pre_mmse, scale_mmse:scale_ns, neuro_threshold, dncr_time, neurocog_nper, bar, rr_ci)

rm(dncr_rr_ref)
```

<caption_mg> `r table_ref()` Delayed neurocognitive recovery incidence and ascertainment (randomized and nonrandomized designs). Table includes only studies conducting cognitive testing at day 3 or later.</caption_mg>

```{r dncr_gt}
#| eval: true

# create footnotes for thresholds
footnotes_neuro_threshold <- dncr_dat |>
  select(refid, study, neuro_threshold) |>
  slice(1, .by = refid) |> 
  mutate(
    neuro_threshold = str_replace(neuro_threshold, "≤-", "≥"),
    neuro_threshold = paste0(neuro_threshold, "."),
  ) 
    # footnotes = case_when(
    # !is.na(scale_mmse) ~ paste0("tab_footnote('", neuro_threshold, ".', locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == '", study, "')) |>"),
    # !is.na(scale_dst) ~  paste0("tab_footnote('", neuro_threshold, ".', locations = cells_body(columns = c(scale_dst), rows = arm_id == 1 & study == '", study, "')) |>"),
    # !is.na(scale_moca) ~ paste0("tab_footnote('", neuro_threshold, ".', locations = cells_body(columns = c(scale_moca), rows = arm_id == 1 & study == '", study, "')) |>")
  # ),
  # footnotes = ifelse(row_number() == n(), str_remove(footnotes, ".{2}$"), footnotes)) |>
  # filter(!is.na(footnotes)) |>
  # pull(footnotes) |>
  # noquote()

dncr_dat |>
  arrange(year, study) |>
  filter(dncr_time >= 3) |> 
  mutate(
    design_surg = paste0(as.character(design_f_lab), " — ", as.character(surgs_noabbr_f)),
    # design_surg = str_remove(design_surg, "Randomized Clinical Trial — ")
  ) |>
  # tabyl(design_surg) |> arrange(desc(percent)) |> pull(design_surg) |> toString()
  mutate(
    study_l = ifelse(row_number() > 1, NA, study_l),
    across(scale_mmse:scale_ns, ~ ifelse(row_number() > 1, NA, .x)),
    dncr_time = ifelse(row_number() > 1, NA, dncr_time),
    .by = study
  ) |>
  # tabyl(design_surg) |> arrange(desc(percent))
  group_by(design_surg) |>
  gt(id = "one") |>
  row_group_order(groups = c("Randomized Clinical Trial — Gastrointestinal/Abdominal", "Randomized Clinical Trial — Thoracic", "Randomized Clinical Trial — Spine", "Randomized Clinical Trial — Vascular", "Prospective Cohort — Orthopedic")) |>
  # row_group_order(groups = c("Randomized Clinical Trial — Gastrointestinal/Abdominal", "Randomized Clinical Trial — Thoracic", "Randomized Clinical Trial — Otolaryngological", "Randomized Clinical Trial — Spine", "Randomized Clinical Trial — Various", "Randomized Clinical Trial — Vascular", "Prospective Cohort — Orthopedic")) |> # if not excluding < 3 day ascertainment
  cols_hide(c(refid, year, arm_id, study, design_f_lab, surg_f, neuro_threshold, surgs_noabbr_f)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              = "Comparator",
    pre_mmse         = "MMSE",
    scale_mmse       = "MMSE",
    scale_moca       = "MoCA",
    scale_fail2      = "Multiple",
    scale_ns         = "NS",
    dncr_time        = "Day",
    neurocog_nper    = "N (%)",
    bar              = "0 — 100%",
    rr_ci            = "RR (95% CI)"
  ) |>
  gt_theme_mg() |>
  fmt_markdown(columns = c(study_l, bar, pre_mmse, scale_mmse:scale_ns)) |>
  fmt_number(dncr_time, decimals = 0) |>
  sub_missing(columns = everything(), missing_text = "") |>
  tab_spanner(label = "Instrument", columns = c(scale_mmse:scale_ns), level = 1) |>
  tab_spanner(label = "Delayed Neurocognitive Recovery", columns = c(neurocog_nper:rr_ci), level = 1) |>
  tab_spanner(label = "Preop", columns = c(pre_mmse), level = 1) |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(45),
    arm ~ px(70),
    pre_mmse ~ px(100),
    scale_mmse ~ px(50),
    scale_moca ~ px(50),
    scale_fail2 ~ px(55),
    scale_ns ~ px(50),
    dncr_time ~ px(60),
    neurocog_nper ~ px(90),
    bar ~ px(100),
    rr_ci ~ px(140),
  ) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(study, arm))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(starts_with("scale"), pre_mmse, dncr_time, neurocog_nper, rr_ci))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_column_labels(columns = c(neurocog_nper))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(study, arm))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(starts_with("scale"), dncr_time, rr_ci, pre_mmse))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_body(columns = c(neurocog_nper))) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n:pre_mmse, neurocog_nper), rows = str_detect(arm, "TIVA"))) |>
  tab_footnote("MMSE: Mini-Mental State Exam; MoCA: MoCA: Montreal Cognitive Assessment; NS: not specfied; RR: risk ratio; CI: confidence interval.") |>
  tab_footnote("Failed 2 or more tests.", locations = cells_column_labels(columns = c(scale_fail2))) |>
  tab_footnote("Day of assessment.", locations = cells_column_labels(columns = c(dncr_time))) |>
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(pre_mmse))) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Zhang 2018a")) |>
  tab_footnote("Difference from baseline >20%.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Egawa 2016")) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Tang 2014")) |>
  tab_footnote("Difference from baseline >2 pts.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Qiao 2023")) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Li 2021a")) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Konishi 2018")) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Rohan 2005")) |> 
  tab_footnote(footnote_study(neurocog_scale_dichot, "Geng 2017", "neurocog_footnote"), locations = cells_body(columns = c(scale_fail2), rows = study == "Geng 2017" & arm_id == 1)) |>
  tab_footnote(footnote_study(footnotes_neuro_threshold, "Geng 2017", "neuro_threshold"), locations = cells_body(columns = c(scale_fail2), rows = study == "Geng 2017" & arm_id == 1)) |>
  tab_footnote(footnote_study(footnotes_neuro_threshold, "Liang 2022", "neuro_threshold"), locations = cells_body(columns = c(scale_moca), rows = study == "Liang 2022" & arm_id == 1)) |>
  tab_footnote(footnote_study(footnotes_neuro_threshold, "Zhou 2021", "neuro_threshold"), locations = cells_body(columns = c(scale_mmse), rows = study == "Zhou 2021" & arm_id == 1)) |>
  tab_footnote("Cognitive dysfunction without specified evaluation.", locations = cells_body(columns = c(scale_ns), rows = study == "Lindholm 2013" & arm_id == 1)) 

```

<a id="kq4_dncr_meta"></a> 

### *Pooled*

<foot_mg>    </foot_mg> 

<caption_mg> `r figure_ref()` Delayed neurocognitive recovery assessed at postoperative day 5 or later (randomized clinical trials).  </caption_mg>

```{r dncr_meta_dat}
#| eval: true
neurocog_meta_dat <- neurocog_allarms_meta_dat |>
  filter(dncr_time >= 3) |> # per Fritz
  # filter(dncr_time > 3) |> # per Fritz
  # collapse arms
  mutate(
    neurocog_total_n = case_when(
      study == "Geng 2017" & arm_id == 1 ~ collapse_dichot(neurocog_allarms_meta_dat, "Geng 2017", c(1, 2), neurocog_total_n),
      .default = neurocog_total_n
    ),
    arm_n = case_when(
      study == "Geng 2017" & arm_id == 1 ~ collapse_dichot(neurocog_allarms_meta_dat, "Geng 2017", c(1, 2), arm_n),
      .default = arm_n
    )
  ) |>
  filter(!(study %in% c("Geng 2017") & arm_id %in% c(2))) |>
  left_join(surgs |> select(refid, surgs_single_f), by = c("refid")) 

nma_dncr_dat <- neurocog_meta_dat |>
  mutate(time = ifelse(dncr_time < 3, "at <3 days", "at ≥3 days" )) |> 
  filter(time == "at ≥3 days") |> 
  # select(-dncr_time) |> 
  filter(design_f_lab == "Randomized Clinical Trial") 

pairs_dat <- pairwise(
  treat = arm,
  event = neurocog_total_n,
  n = arm_n,
  studlab = study,
  data = nma_dncr_dat,
  sm = "RR",
  keep.all.comparisons = TRUE
)

```

```{r dncr_meta}
#| eval: true
#| include: false
dncr_meta_dat <- pairs_dat |>
  arrange(year, study) |> 
  left_join(rob2_meta_dat, by = "refid") |>
  select(refid, study, year, event2, n2, event1, n1, D1:Overall, surgs_single_f, dncr_time) |>
  mutate(
    rob = case_when(
      Overall == "+" ~ "Low",
      Overall == "?" ~ "Some Concerns",
      Overall == "–" ~ "High"
    )
  ) |>
  left_join(study_char_dat |> select(refid, country), by = "refid") |> 
  arrange(dncr_time, study) |>
  mutate(dncr_time = paste0("At day ", dncr_time)) 

dncr_tiva_inhaled_meta <- metabin(event2, n2, event1, n1,
  data = dncr_meta_dat,
  studlab = study,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  subgroup = dncr_time,
  print.subgroup.name = FALSE,
  method.random.ci = "HK",
  prediction = TRUE,
  allstudies = TRUE,
  subset = study != "Geng 2017",
  # subgroup = country
)

dncr_tiva_inhaled_meta_rct_rd <- update(dncr_tiva_inhaled_meta, sm = "RD", method = "Inverse", method.tau = "REML")

# summary(plac_meta)

png("assets/kq4_dncr_meta.png", width = 10.67, height = 5.38, units = "in", res = 300) 
forest(dncr_tiva_inhaled_meta,
  allstudies = TRUE,
  common = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "surgs_single_f", "D1", "D2", "D3", "D4", "D5", "Overall"),
  rightlabs = c("RR ", "(95% CI)   ", "Procedure", "D1", "D2", "D3", "D4", "D5", "All"),
  just.addcols.right = "left",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  subgroup = TRUE,
  # print.subgroup.labels = FALSE,
  test.subgroup.common = FALSE,
  test.subgroup.random = FALSE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  xlim = c(0.2, 2),
  xlab = "Favors: TIVA                    Inhaled",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  text.addline2 = risk_diff_meta_rr(dncr_tiva_inhaled_meta, scale = 100)
)  
dev.off()

```
![](assets/kq4_dncr_meta.png){fig.align="left" width="78%"}

<foot_mg> RR: risk ratio; D1: bias arising from the randomization process; D2: bias due to deviations from intended interventions; D3: bias due to missing outcome data; D4: bias in measurement of the outcome; D5: bias in selection of the reported result: All: overall risk of bias.<br/> Risk of bias ratings: low +, some concerns ?, high -- .<br/> 
Four trials conducted in China and one each in Norway (Lindholm 2013) and Japan (Egawa 2016).<br/>
Including Geng 2017 assessments at day 3 — RR 0.66 (95% CI, 0.54–0.81; prediction interval, 0.54–0.91)</foot_mg><br/>

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### Meta-analysis methods detail.

```{r}
#| include: false  

temp <- print(dncr_tiva_inhaled_meta,) |> 
  str_replace_all("\\n", "<br/> ") |>
  str_remove("<br/> Details on meta-analytical method:<br/> ") |> 
  str_replace_all("tau\\^2", "tau<sup>2</sup>") |> 
  str_replace_all("tau", "&tau;")

```

<foot_mg> `r temp` </foot_mg>
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delayed neurocognitive recovery assessed at postoperative day 5 or later (randomized clinical trials; risk difference per 100). </caption_mg> <a id="kq4_delirium_risk-diff"></a>

```{r kq4_dncr_meta_forest_rd}
#| echo: false
#| include: false
png("assets/kq4_dncr_meta_forest_rd.png", width = 9.85, height = 5.65, units = "in", res = 300)
forest(dncr_tiva_inhaled_meta_rct_rd,
  allstudies = TRUE,
  common = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "Overall"),
  rightlabs = c("RD", "(95% CI)", "D1", "D2", "D3", "D4", "D5", "All"),
  just.addcols.right = "right",
  digits = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  # sortvar = year,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  # xlim = c(-20, 20),
  pscal = 100,
  xlab = "Favors: TIVA                          Inhaled",
  addrows.below.overall = 4,
  fs.test.subgroup = 10,
  fs.hetstat = 10
)
dev.off()
```
![](assets/kq4_dncr_meta_forest_rd.png){fig.align="left" width="72%"}
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delayed neurocognitive recovery assessed at postoperative day 5 or later (small study effects). </caption_mg>

```{r kq4_dncr_funnel_limit} 
#| echo: false
#| include: false

dncr_tiva_inhaled_meta_or <- update(dncr_tiva_inhaled_meta , sm = "OR", subgroup = NULL)
# metabias(update(dncr_tiva_inhaled_meta_or, subgroup = NULL), k = 6) 

png("assets/kq4_dncr_or_funnel.png", width = 8.5, height = 5.5, units = "in", res = 300)
par(mar = c(4, 4, 2, 1))
limit_colors <- c("#AAB7B8", "#D5DBDB", "#F4F6F6")
# text(1.2, 0.05, labels = "Adjusted estimate", col = "darkgray", pos = 3, cex = .9)
par(bty = "n", xaxt = "s", yaxt = "s")
funnel(dncr_tiva_inhaled_meta_or,  pch = 20, contour = c(0.9, 0.95, 0.99), col.contour = limit_colors, studlab = TRUE, pos.studlab = 4, fs.smlab = 6, ff.smlab = "italic", xlim = c(0.2185, 2), ylim = c(0.66, 0.0))
legend(0.23, 0.02, c("0.1 > p > 0.05", "0.05 > p > 0.01", "< 0.01"), fill = c("#AAB7B8", "#D5DBDB", "#F4F6F6"), bty = "n")
dev.off()

```

![](assets/kq4_dncr_or_funnel.png){width="75%"}

<foot_mg> Too few studies to test for the presence of small study effects. </foot_mg> 
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delayed neurocognitive recovery summary risk of bias from randomized clinical trials (weighted). </caption_mg>

```{r rob2_summary_dncr, fig.height = 3, out.width = "60%"}
temp <- update(dncr_tiva_inhaled_meta, subgroup = NULL)

add_weights <- tibble(temp$data$refid[temp$data$refid != 16559], temp$w.random / sum(temp$w.random)) |> # exclude Geng 2017
  set_names("refid", "weight")

rob_temp_dat <- rob2_dat |>
  filter(refid %in% temp$data$refid[temp$data$refid != 16559]) |>
  select(refid, Study, D1:Overall) |>
  left_join(add_weights, by = "refid") |>
  rename(Weight = weight) |> 
  select(-refid)
rob_summary(rob_temp_dat, tool = "ROB2", colour = "colourblind", weighted = TRUE)

```
:::

## **Postoperative Neurocognitive Disorder**

<caption_mg> `r table_ref()` Postoperative neurocognitive disorder (cognitive dysfunction after 30 days) and ascertainment (cohort studies). </caption_mg>

```{r ncd_dat}
ncd_dat <- dichot_dat |>
  filter(if_any(c(neurocog_n1, neurocog_n2, neurocog_n3, neurocog_last_n, neurocog_total_n), ~ !is.na(.x))) |>
  # > 30 day exam
  filter(if_any(matches("neurocog.*time.*"), ~ .x > 30)) |>
  mutate(
    across(contains("neurocog_update_arm"), \(x) as.numeric(x)),
    arm_n = ifelse(!is.na(neurocog_update_arm_n), neurocog_update_arm_n, arm_n),
    ncd_time = case_when(
      neurocog_time1 > 30 ~ neurocog_time1,
      neurocog_time2 > 30 ~ neurocog_time2,
      neurocog_time3 > 30 ~ neurocog_time3,
      neurocog_last_time > 30 ~ neurocog_last_time,
      neurocog_total_time > 30 ~ neurocog_total_time,
      .default = NA
    ),
    neurocog_total_n = case_when(
      neurocog_time1 > 30 ~ neurocog_n1,
      neurocog_time2 > 30 ~ neurocog_n2,
      neurocog_time3 > 30 ~ neurocog_n3,
      neurocog_last_time > 30 ~ neurocog_last_n,
      neurocog_total_time > 30 ~ neurocog_total_n
    ),
    # update arm_n corresponding to time if necessary 
    arm_n = case_when(
    !is.na(neurocog_update_arm_n_t1) & neurocog_time1 == ncd_time       ~ neurocog_update_arm_n_t1,
    !is.na(neurocog_update_arm_n_t2) & neurocog_time2 == ncd_time       ~ neurocog_update_arm_n_t2,
    !is.na(neurocog_update_arm_n_t3) & neurocog_time3 == ncd_time       ~ neurocog_update_arm_n_t3,
    !is.na(neurocog_update_arm_n_last) & neurocog_last_time == ncd_time ~ neurocog_update_arm_n_last,
    !is.na(neurocog_update_arm_n)                                       ~ neurocog_update_arm_n, # corresponding to first time
      .default = arm_n
    ),
    neurocog_prop = neurocog_total_n / arm_n,
    neurocog_nper = n_per_fun(neurocog_total_n, arm_n, 1)
  ) |>
  left_join(study_char_dat |> select(refid, country, neuro_threshold), by = "refid") |>
  left_join(surgs |> select(refid, surgs_single_f, surgs_noabbr_f), by = c("refid")) |>
  # left_join(surgs |> select(refid, surgs_single_f), by = c("refid")) |>
  left_join(table_mn_med |> select(refid, arm_id, pre_mmse), by = c("refid", "arm_id")) |>
  left_join(neurocog_scale_dichot |> select(-study), by = "refid") |> 
  rename(surg_f = surgs_single_f) |>
  arrange(refid_c, arm_id) |> #tabyl(neurocog_scale)
  mutate(
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(neurocog_prop * 100, "#A93226"),
      .default = bar_prop(neurocog_prop * 100, "#969696")),
    year = as.numeric(str_extract(study, "\\d{4}")),
    across(c(arm, design_f_lab, surg_f), ~ fct_drop(.x)),
    scale_mmse = ifelse(neurocog_scale == "MMSE", "\U2713", NA),
    scale_moca = ifelse(neurocog_scale == "MoCA", "\U2713", NA),
    scale_fail2 = ifelse(neurocog_scale == "Failed 2", "\U2713", NA),
    scale_ns = ifelse(neurocog_scale == "NS", "\U2713", NA),
    arm_n = ifelse(study == "Konishi 2018" & arm == "TIVA", 161, arm_n),
  ) |> 
  select(refid, year, arm_id, study, study_l, design_f_lab, pre_mmse, country, surg_f, pre_mmse, ncd_time, neurocog_total_n, arm_n, arm, neurocog_nper, neurocog_prop, bar, scale_mmse:scale_ns)


ncd_rr_ref <- ncd_dat |>
  select(refid, arm_id, neurocog_total_n, arm_n) |>
  arrange(refid, arm_id) |>
  rename(ref_neurocog_n = neurocog_total_n, ref_arm_n = arm_n) |>
  group_by(refid) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_neurocog_n = ifelse(row_number() > 1, NA, ref_neurocog_n)
  ) |>
  fill(ref_arm_n, ref_neurocog_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_neurocog_n = ifelse(row_number() == 1, NA, ref_neurocog_n)
  )

ncd_dat <- ncd_dat |>
  left_join(ncd_rr_ref, by = c("refid", "arm_id")) |>
  mutate(rr_ci = ifelse(!is.na(ref_arm_n), rr_ci_fun(neurocog_total_n, arm_n, ref_neurocog_n, ref_arm_n), "—")) |>
  select(refid, year, design_f_lab, study, study_l, arm_id, arm_n, arm, pre_mmse, scale_mmse:scale_ns, ncd_time, neurocog_nper, bar, rr_ci)
```

```{r ncd_gt}
#| eval: true

ncd_dat |>
  arrange(year, study) |>
  mutate(
    study_l = ifelse(row_number() > 1, NA, study_l),
    across(scale_mmse:scale_ns, ~ ifelse(row_number() > 1, NA, .x)),
    ncd_time = ifelse(row_number() > 1, NA, ncd_time),
    .by = study
  ) |>
  group_by(design_f_lab) |>
  gt(id = "one") |>
  row_group_order(groups = c("Prospective Cohort")) |>
  cols_hide(c(refid, year, arm_id, study)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              = "Comparator",
    pre_mmse         = "MMSE",
    scale_mmse       = "MMSE",
    scale_moca       = "MoCA",
    scale_fail2      = "Other",
    scale_ns         = "NS",
    ncd_time         = "Day",
    neurocog_nper    = "N (%)",
    bar              = "0 — 100%",
    rr_ci            = "RR (95% CI)"
  ) |>
  gt_theme_mg() |>
  # fmt_markdown(columns = c(study_l, bar, pre_mmse, scale_mmse:scale__ns)) |>
  fmt_markdown(columns = c(study_l, bar, pre_mmse)) |>
  fmt_number(ncd_time, decimals = 0) |>
  sub_missing(columns = everything(), missing_text = "") |>
  tab_spanner(label = "Instrument", columns = c(scale_mmse:scale_ns), level = 1) |>
  tab_spanner(label = "Neurocognitive Disorder", columns = c(neurocog_nper:rr_ci), level = 1) |>
  tab_spanner(label = "Preop", columns = c(pre_mmse), level = 1) |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(45),
    arm ~ px(70),
    pre_mmse ~ px(100),
    scale_mmse ~ px(50),
    scale_moca ~ px(50),
    scale_fail2 ~ px(55),
    scale_ns ~ px(50),
    ncd_time ~ px(60),
    neurocog_nper ~ px(90),
    bar ~ px(100),
    rr_ci ~ px(140),
  ) |>
  tab_style(style = cell_text(align = "left"), locations = cells_column_labels(columns = c(study, arm))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(starts_with("scale"), pre_mmse, ncd_time, neurocog_nper, rr_ci))) |>
  # tab_style(style = cell_text(align = "right"),       locations = cells_column_labels(columns = c(neurocog_nper))) |>
  tab_style(style = cell_text(align = "left"), locations = cells_body(columns = c(study, arm))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(starts_with("scale"), ncd_time, rr_ci, pre_mmse))) |>
  tab_style(style = cell_text(align = "right"), locations = cells_body(columns = c(neurocog_nper))) |>
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(arm_n:pre_mmse, neurocog_nper), rows = str_detect(arm, "TIVA"))) |>
  tab_footnote("Mini-Mental State Exam; MoCA: Montreal Cognitive Assessment; NS: not stated; RR: risk ratio.") |>
  tab_footnote("Pooled RR 1.10 (95% CI, 0.72–1.68)") |>
  tab_footnote("Day of assessment.", locations = cells_column_labels(columns = c(ncd_time))) |>
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(pre_mmse))) |>
  tab_footnote(footnote_study(neurocog_scale_dichot, "Deiner 2015", "neurocog_footnote"), locations = cells_body(columns = c(scale_fail2), rows = study == "Deiner 2015" & arm_id == 1)) |>
  tab_footnote(footnote_study(neurocog_scale_dichot, "Kadoi 2007", "neurocog_footnote"), locations = cells_body(columns = c(scale_fail2), rows = study == "Kadoi 2007" & arm_id == 1)) |>
  tab_footnote("Failed 2 or more tests.", locations = cells_body(columns = c(scale_fail2), rows = study == "Kadoi 2007" & arm_id == 1)) |>
  tab_footnote(footnote_study(footnotes_neuro_threshold, "Konishi 2018", "neuro_threshold"), locations = cells_body(columns = c(scale_mmse), rows = study == "Konishi 2018" & arm_id == 1))

```

<a id="pnd-meta"></a>

### *Pooled*

<foot_mg>    </foot_mg> 

<caption_mg> `r figure_ref()` Postoperative neurocognitive disorder (nonrandomized designs).  </caption_mg>

```{r ncd_meta}
#| eval: true
#| echo: false
#| include: false

ncd_meta_dat <- ncd_dat |>
  mutate(n = as.numeric(str_extract(neurocog_nper, "\\d{1,2}"))) |>
  select(refid, study, arm, n, arm_n) |>
  pivot_wider(names_from = "arm", values_from = c("n", "arm_n")) |> 
  left_join(robinsi_meta_dat, by = "refid") 

ncd_meta <- metabin(n_TIVA, arm_n_TIVA, n_Inhaled, arm_n_Inhaled,
  data = ncd_meta_dat,
  studlab = study,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  method.random.ci = "classic",
  prediction = FALSE,
  allstudies = TRUE,
) 

ncd_meta_dat |>
  summarise(
    n_TIVA = sum(n_TIVA, na.rm = TRUE),
    arm_n_TIVA = sum(arm_n_TIVA, na.rm = TRUE),
    n_Inhaled = sum(n_Inhaled, na.rm = TRUE),
    arm_n_Inhaled = sum(arm_n_Inhaled, na.rm = TRUE),
    total = arm_n_TIVA + arm_n_Inhaled
  )

png("assets/kq4_ncd_meta.png", width = 10.35, height = 3, units = "in", res = 300) 
forest(ncd_meta,
  allstudies = TRUE,
  common = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "Overall"),
  rightlabs = c("RR", "(95% CI)  ", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "All"),
  just.addcols.right = "left",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  test.subgroup.common = FALSE,
  test.subgroup.random = FALSE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  colgap.forest = "5mm",
  fs.xlab = 11,
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  # xlim = c(0.2, 2),
  xlab = "Favors: TIVA                    Inhaled",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  text.addline2 = risk_diff_meta_rr(meta_select = ncd_meta, scale = 100)
)  
dev.off()

```

![](assets/kq4_ncd_meta.png){fig.align="left" width="76%"}

<foot_mg> D1: Bias due to confounding; D2: Bias in selection of participants into the study; D3: Bias in classification of interventions; D4: Bias due to deviations from intended interventions; D5: Bias due to missing data; D6: Bias in measurement of outcomes; D7: Bias in selection of reported results; All: overall risk of bias (ratings: low ++, moderate +, serious -, critical - - ; NI: no information; NA: not applicable).</foot_mg> 

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### Meta-analysis methods detail.

```{r}
#| include: false  

temp <- print(ncd_meta) |> 
  str_replace_all("\\n", "<br/> ") |>
  str_remove("<br/> Details on meta-analytical method:<br/> ") |> 
  str_replace_all("tau\\^2", "tau<sup>2</sup>") |> 
  str_replace_all("tau", "&tau;")

```

<foot_mg> `r temp` </foot_mg>
:::

## **Physical Function**

No studies
    
## **Complications**

```{r complications_check_to_excel}
#| eval: false

# create excel file to inspect complications
complication_fun <- function(var_prefix) {
  dichot_dat %>%
    filter(if_any(!!paste0(var_prefix, "_per"):!!paste0(var_prefix, "_95high"), ~ !is.na(.x))) |>
    select(refid, study, arm_id, arm, arm_n, comp_update_arm_n, !!paste0(var_prefix, "_n"):!!paste0(var_prefix, "_95high"))
}

# the complications included to be reported
complication_incl <- c("cardiac", "myoinfarct", "hypo", "cardarr", "stroke", "kidneyinj", "asppneum", "atelec", "pulm", "pneum", "pthorax", "airleak", "pulcongest", "pe", "pinfiltrate", "respfail", "intub", "upperair", "vent48")

# complication_all <- c("medical", "surg", "cardiac", "gastro", "neuro", "pulm", "thromb", "infect", "fall", "stroke", "othcomp", "asppneum", "atelec", "bronch", "cardarr", "myoinfarct", "hypo" ssi", "sepsis", "uti", "pneum", "pthorax", "airleak", "pulcongest", "pe", "pinfiltrate", "respfail", "intub", "upperair", "vent48", "kidneyinj", "nerveinj", "clavien1", "clavien2", "clavien3", "clavien4", "clavien5")

adverse_events_dat <- map(complication_incl, complication_fun)

wb <- openxlsx::createWorkbook("kq4_complications")

for (i in 1:19) {
    temp_sheet <- adverse_events_dat[[i]]
    addWorksheet(wb, sheetName = complication_incl[i])
    setColWidths(wb, i, cols = c(1:12), widths = c(rep(19, 12)))
    writeData(wb, sheet = i, temp_sheet)
}

path <- glue::glue("/Users/mgrant/Desktop/temp.xlsx")
saveWorkbook(wb, "/Users/mgrant/Desktop/kq4.xlsx", overwrite = TRUE)
```

<caption_mg> `r table_ref()` Complications --- cardiac, pulmonary, and renal (randomized and nonrandomized designs). </caption_mg>

```{r complications_data}
#| warning: false
#| eval: true

# included complications; note add bradycardia from cardiac subsequently
complication_incl <- c("cardiac", "myoinfarct", "hypo", "cardarr", "stroke", "kidneyinj", "asppneum", "atelec", "pulm", "pneum", "pthorax", "airleak", "pulcongest", "pe", "pinfiltrate", "respfail", "intub", "upperair", "vent48")

complication_fun <- function(var_prefix) {
  dichot_dat %>%
    filter(if_any(!!paste0(var_prefix, "_per"):!!paste0(var_prefix, "_95high"), ~ !is.na(.x))) |>
    select(refid, year, study, arm_id, arm, arm_n, comp_update_arm_n, !!paste0(var_prefix, "_n"):!!paste0(var_prefix, "_95high")) |>
    mutate(complication = var_prefix) |>
    rename_with(~ str_replace(.x, "95", "ci_"), .cols = everything()) |>
    rename_with(~ str_replace(.x, "^.*_", ""), .cols = c(8:15)) |>
    arrange(complication, year, study, arm_id)
}

# adverse event data includes all reported complications in list
adverse_events_dat <- map_df(complication_incl, complication_fun) |>
  mutate(
    arm_n = ifelse(!is.na(comp_update_arm_n), comp_update_arm_n, arm_n),
    calc_per = n / arm_n * 100,
    n_per = n_per_fun(n, arm_n, 1),
    diff = per - calc_per
  ) 

# if RR convert to OR get ln_te ln_se
# if reported OR use ests to get ln_te ln_se
# if neither use estimate
adverse_events_dat <- adverse_events_dat |>
  left_join(cardiac_compl, by = c("refid", "complication")) |>
  left_join(study_char_dat |> select(refid, study_l, surgs_single, design_f_lab), by = "refid") |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |>
  arrange(complication, surgs_single, year, study, arm_id) |> 
  mutate(
    complication = if_else(detail_cardiac == "bradycardia", "bradycardia", complication, missing = complication),
    study_compl = paste0(study, complication),
    ref_arm_n = arm_n,
    ref_n = n
  ) |>
  group_by(study_compl) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_n = ifelse(row_number() > 1, NA, ref_n)
  ) |>
  fill(ref_arm_n, ref_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_n = ifelse(row_number() == 1, NA, ref_n)
  ) |>
  mutate(
    # Luntz 2004 combine inhalation arms; differed in induction
    ref_arm_n = ifelse(study == "Luntz 2004" & arm_id == 3, 64, ref_arm_n),
    ref_n = ifelse(study == "Luntz 2004" & arm_id == 3, 5, ref_n),
    ref_arm_n = ifelse(study == "Luntz 2004" & arm_id == 2, NA, ref_arm_n),
    ref_n = ifelse(study == "Luntz 2004" & arm_id == 2, NA, ref_n),
    rd_ci = ifelse(!is.na(ref_n), rd_per_ci_fun(n, arm_n, ref_n, ref_arm_n, digits = 2), "—"),
    or_ci = ifelse(!is.na(ref_n) & n != 0 & ref_arm_n != 0, or_ci_fun(n, arm_n, ref_n, ref_arm_n, digits = 2), "—"), # not if any Os
    or_ci = ifelse(!is.na(est), paste0(digit2(est), " (", digit2(low), "—", digit2(high), ")"), or_ci), 
    rr_ci = ifelse(!is.na(ref_n) & n != 0 & ref_arm_n != 0, rr_ci_fun(n, arm_n, ref_n, ref_arm_n, digits = 2), "—"), # not if any Os
    # or_ci = ifelse(!is.na(ref_n), or_ci_fun(n, arm_n, ref_n, ref_arm_n, digits = 2), "—"),
    or_ln_te = ifelse(!is.na(ref_n), or_ln_te_fun(n, arm_n, ref_n, ref_arm_n), NA),
    or_ln_se_te = ifelse(!is.na(ref_n), or_ln_se_fun(n, arm_n, ref_n, ref_arm_n), NA),
    or_ln_te = ifelse(!is.na(effect), log(est), or_ln_te),
    or_ln_se_te = ifelse(!is.na(effect), se_ln_ci_fun(low, high), or_ln_se_te),    
    bar = case_when(
      str_detect(arm, "Inhaled") ~ bar_prop(calc_per, "#969696"),
      .default = bar_prop(calc_per, "#A93226"))) |>
  ungroup() |>
  select(refid, year, arm_id, study, study_l, study_compl, arm_n, arm, n, age_table, surgs_single, n_per, bar, rd_ci, rr_ci, or_ci, or_ln_te, or_ln_se_te, complication, design_f_lab, effect:high, detail_cardiac) 

# adverse_events_dat |> filter(!is.na(detail_cardiac)) |> select(study, detail_cardiac) |> distinct()

# for summary table
# temp <- adverse_events_dat |>
#   group_by(refid, arm_id) |> 
#   # filter(!str_detect(design_f_lab, "Rand")) |>
#   slice(1) |>
#   ungroup() |>
#   summarise(total = sum(arm_n, na.rm = TRUE))
# 
# length(unique(temp$refid))

# temp <- adverse_events_dat |>
#   # filter(!str_detect(design_f_lab, "Random")) |>
#   mutate(
#     effect = ifelse(is.na(est), "OR", effect),
#     est = case_when(
#       !is.na(effect) & !is.na(est) & !is.na(low + high) ~ paste0(est, " (", sprintf("%.2f", low), ", ", sprintf("%.2f", high), ")"),
#       is.na(est) & effect == "OR" ~ or_ci),
#     # est = ifelse(is.na(est), or_ci, est),
#     # effect = ifelse(est == "—", NA, effect),
#     # # est = ifelse(!is.na(low) & effect != "RD", paste0(est, " (", sprintf("%.2f", low), ", ", sprintf("%.2f", high), ")"), est)
#   ) |>
#   mutate(effect = ifelse(est == "—", NA, effect)) |>
#   select(refid, study,  arm_n, arm, n, est, n_per, bar, effect, low, high, or_ci, rd_ci, rr_ci, complication, design_f_lab)
```

```{r complications_gt}
#| eval: true
# propensity matched for footnotes
# Park 2020 (refid: 1134), Oh 2019 (refid: 132), Yoshimura 2022 (refid: 16890), Hasselberg 2021 (refid: 17551) 
propensity_refid <- c(1134, 132, 16890, 17551)

adverse_events_gt_dat <- adverse_events_dat |>
  filter(complication %in% c(complication_incl, "bradycardia")) |>
  mutate(
    complication = fct(complication),
    complication = fct_recode(complication,
      "Other Cardiac" = "cardiac",
      "Myocardial Infarction" = "myoinfarct",
      "Cardiac Arrest" = "cardarr",
      "Bradycardia" = "bradycardia",
      "Hypotension" = "hypo",
      "Stroke" = "stroke",
      "Acute Kidney Injury" = "kidneyinj",
      "Pneumonia" = "pneum",
      "Pulmonary Edema" = "pulcongest",
      "Pulmonary Embolism" = "pe",
      "Pneumothorax" = "pthorax",
      "Respiratory Failure" = "respfail"
    )
  ) |> 
  arrange(year, study, arm) |>
  mutate(
    rd_or = ifelse(refid %in% propensity_refid & row_number() != 1, paste0("<u>", or_ci, "</u>"), rd_ci),
    rd_or = ifelse(rd_or == "<u>—</u>", "—", rd_or),
    surgs_single = ifelse(surgs_single == "Vasc", "Vascular", surgs_single),
    study_l = ifelse(row_number() > 1, "", study_l),
    surgs_single = ifelse(row_number() > 1, "", surgs_single),
    complication = fct_drop(complication),
    complication_nodesign = complication,
    .by = study_compl
  ) |>
  unite(complication, complication, design_f_lab, sep = " – ") 

adverse_meta_dat <- adverse_events_gt_dat |>
  select(refid, year, study, arm_id, arm, arm_n, n, complication, or_ln_te, or_ln_se_te) |>
  mutate(
    n = case_when(
      study == "Luntz 2004" & arm_id == 1 ~ collapse_dichot(adverse_events_gt_dat, "Luntz 2004", c(1, 2), n),
      .default = n
    ),
    arm_n = case_when(
      study == "Luntz 2004" & arm_id == 1 ~ collapse_dichot(adverse_events_gt_dat, "Luntz 2004", c(1, 2), arm_n),
      .default = arm_n
    )
  ) |>
  filter(!(study %in% c("Luntz 2004") & arm_id  == 2)) 

adverse_meta_wide_dat <- adverse_meta_dat |>
  # filter(!is.na(or_ln_te)) |>
  arrange(refid, complication) |>
  pivot_wider(names_from = "arm", values_from = arm_n:n) |>
  group_by(refid, complication) |>
  fill(or_ln_te:n_TIVA) |>
  slice(2) |>
  ungroup() |>
  mutate(
    complication_nodesign = str_remove(complication, "\\s–.*"),
    study_design = ifelse(str_detect(complication, "Rand"), paste0(study, "*"), study)
  )

adverse_events_gt_dat |> 
  # tabyl(complication) |> arrange(desc(percent)) |> pull(complication) |> toString()
  group_by(complication) |>
  gt(id = "one") |>
  row_group_order(groups = c("Myocardial Infarction – Randomized Clinical Trial", "Myocardial Infarction – Retrospective Cohort", "Cardiac Arrest – Randomized Clinical Trial", "Cardiac Arrest – Retrospective Cohort", "Bradycardia – Randomized Clinical Trial", "Bradycardia – Nonrandomized Trial", "Hypotension – Randomized Clinical Trial", "Hypotension – Nonrandomized Trial", "Hypotension – Retrospective Cohort", "Other Cardiac – Randomized Clinical Trial", "Stroke – Randomized Clinical Trial", "Stroke – Retrospective Cohort", "Acute Kidney Injury – Randomized Clinical Trial", "Acute Kidney Injury – Retrospective Cohort", "Pneumonia – Randomized Clinical Trial", "Pneumonia – Retrospective Cohort", "Pneumothorax – Randomized Clinical Trial", "Pulmonary Embolism – Randomized Clinical Trial", "Pulmonary Embolism – Retrospective Cohort", "Pulmonary Edema – Retrospective Cohort", "Respiratory Failure – Randomized Clinical Trial", "Respiratory Failure – Retrospective Cohort")
) |>
  cols_hide(c(refid, year, study, arm_id, n, study, study_compl, rd_ci, rr_ci, or_ci, or_ln_te, or_ln_se_te, effect, adjcrude, est, low, high, detail_cardiac, complication_nodesign)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              =  "Arm",
    age_table        = "    Age",
    surgs_single     = "Surgery",
    n_per            = "N (%)",
    bar              = "0 – 100%",
    rd_or            = md("RD <u>OR</u> (95% CI)")
  ) |>
  fmt_markdown(columns = c(study_l, bar, age_table, rd_or)) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",") |> 
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l          ~ px(140),
    arm_n            ~ px(60),
    arm              ~ px(60),
    age_table        ~ px(100),
    surgs_single     ~ px(80),
    n_per            ~ px(90),
    bar              ~ px(100),
    rd_or            ~ px(140)
  ) |>
  tab_style(style = cell_text(align = "left"),          locations = cells_column_labels(columns = c(arm))) |>
  tab_style(style = cell_text(align = "center"),        locations = cells_column_labels(columns = c(arm_n, rd_or))) |>
  # tab_style(style = cell_text(align = "right"),       locations = cells_column_labels(columns = c())) |>
  tab_style(style = cell_text(align = "left"),          locations = cells_body(columns = c(arm, age_table, rd_or, surgs_single))) |>
  tab_style(style = cell_text(align = "center"),        locations = cells_body(columns = c(rd_or))) |>
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table))) |> 
  tab_footnote("Odds ratios for propensity-matched studies (risk differences accounting for matching were not reported).", locations = cells_column_labels(columns = c(rd_or))) |> 
  tab_footnote("RD: risk difference; OR: odds ratio; Ophtho: ophthalmologic; GI: gastointestinal; GI: gastrointestinal; Abd: abdominal.") |> 
  tab_footnote("Compared with combined inhalation arms (differed only in induction agents).", locations = cells_body(columns = c(rd_or), rows = study == "Luntz 2004" & arm_id == 3)) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n:age_table, n_per), rows = str_detect(arm, "TIVA"))) |> 
  tab_footnote("Atrial fibrillation.",                  locations = cells_body(columns = c(study_l), rows = detail_cardiac == "atrial fibrillation" & arm_id == 1), placement = c("right")) |> 
  tab_footnote("Cardiac dysfunction.",                  locations = cells_body(columns = c(study_l), rows = detail_cardiac == "cardiac dysfunction" & arm_id == 1), placement = c("right")) |> 
  tab_footnote("Arrhythmia.",                           locations = cells_body(columns = c(study_l), rows = detail_cardiac == "arrhythmia" & arm_id == 1), placement = c("right")) |> 
  tab_footnote("<50 bpm or ↓30% and require chronotropic agent.", locations = cells_body(columns = c(study_l), rows = detail_cardiac == "bradycardia" & study == "Zhang 2018a" & arm_id == 1), placement = c("right")) |>
  tab_footnote("<50 bpm.", locations = cells_body(columns = c(study_l), rows = detail_cardiac == "bradycardia" & study == "Nishikawa 2007a" & arm_id == 1), placement = c("right")) |>  
  tab_footnote("Definition not reported.", locations = cells_body(columns = c(study_l), rows = detail_cardiac == "bradycardia" & study  %in% c("Luntz 2004", "Zhou 2021", "Tian 2021") & arm_id == 1), placement = c("right")) |> 
  tab_footnote("Definition not reported.", locations = cells_body(columns = c(study_l), rows = detail_cardiac == "hypotension" & study  %in% c("Zhou 2021", "Tian 2021") & arm_id == 1), placement = c("right")) |> 
  tab_footnote("Systolic blood pressure <90 mm Hg or a decrease of >20% from baseline.", locations = cells_body(columns = c(study_l), rows = detail_cardiac == "hypotension" & study == "Chang 2022" & arm_id == 1 ), placement = c("right")) |>
  tab_footnote("Systolic blood pressure <90 mm Hg or a decrease of >30% from baseline.", locations = cells_body(columns = c(study_l), rows = detail_cardiac == "hypotension" & arm_id == 1 & study == "Cao 2023"), placement = c("right")) 

```

### *Pooled*

Note: given the limited number of randomized studies and absence of convincing evidence for any complication, we pooled all designs without detriment to any strength of evidence rating. When odds ratios were pooled, approximate risk differences were calculated based on the event rate across inhaled anesthetic arms and the corresponding risk ratio derived from the odds ratio.

```{r complication_meta}

complication_meta_or <- function(compl_label, use_hakn = TRUE, predictive = TRUE, study_label = "study_design", ...){
meta_dat <- adverse_meta_wide_dat |>
  filter(!str_detect(complication, "Other Cardiac")) |> 
  select(-complication) |>
  rename(complication = complication_nodesign) |>
  filter(complication %in% compl_label) |> 
  left_join(rob2_meta_dat, by = "refid")


meta_dat <- adverse_meta_wide_dat |>
  filter(!str_detect(complication, "Other Cardiac")) |> 
  select(-complication) |>
  rename(complication = complication_nodesign) |>
  filter(complication %in% compl_label) |> 
  left_join(rob2_meta_dat, by = "refid")

complication_bin <- metagen(
  or_ln_te, or_ln_se_te,
  data = meta_dat,
  studlab = study_design,
  sm = "OR",
  prediction = predictive,
  method.random.ci = use_hakn,
  allstudies = FALSE,
  ...
)  
}

complication_meta_rr <- function(compl_label, use_hakn = TRUE, predictive = TRUE, study_label = "study_design", ...){
meta_dat <- adverse_meta_wide_dat |>
  filter(!str_detect(complication, "Other Cardiac")) |> 
  select(-complication) |>
  rename(complication = complication_nodesign) |>
  filter(complication %in% compl_label) 

complication_bin <- metabin(
  event.e = n_TIVA,
  n.e = arm_n_TIVA,
  event.c = n_Inhaled,
  n.c = arm_n_Inhaled,
  data = meta_dat,
  studlab = study_design,
  sm = "RR",
  prediction = predictive,
  method.random.ci = use_hakn,
  allstudies = FALSE,
  method = "MH",
  ...)  
}

complication_forest_or <- function(adverse_meta, use_predictive = TRUE, random = TRUE, ...) {
  forest(adverse_meta,
    allstudies = TRUE,
    random = random,
    rightcols = c("effect", "ci"),
    rightlabs = c("OR ", "(95% CI)   "),
    leftcols = c("study_design", "n_TIVA", "arm_n_TIVA", "n_Inhaled", "arm_n_Inhaled"),
    leftlabs = c("Study", "TIVA\n Events", "Total", "Inhaled\nEvents", " Total"),
    colgap.forest = "5mm",
    just.addcols.right = "center",
    just.addcols.left = "right",
    digits.TE = 3,
    digits.tau2 = 1,
    overall.hetstat = TRUE,
    # print.subgroup.name = FALSE,
    overall = TRUE,
    print.I2.ci = TRUE,
    prediction = use_predictive,
    fs.xlab = 11,
    # pooled.events = TRUE,
    digits = 2,
    print.pval.Q = FALSE,
    xlim = c(0.1, 10),
    xlab = "Favors: TIVA                             Inhaled",
    addrows.below.overall = 4,
    text.addline1 = "*Randomized clinical trial",
    fs.hetstat = 10,
    ...
  )
}

complication_forest_rr <- function(adverse_meta, random = TRUE, use_predictive = TRUE, ...){
forest(adverse_meta,
  allstudies = TRUE,
  random = random,
  # leftcols = c("study_design", "n_TIVA", "arm_n_TIVA", "n_Inhaled", "arm_n_Inhaled"), 
  label.e = "TIVA           ",
  label.c = "Inhaled          ",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  colgap.forest = "5mm",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  # print.subgroup.name = FALSE,
  overall = TRUE,
  print.I2.ci = TRUE,
  prediction = use_predictive,
  fs.xlab = 11,
  # pooled.events = TRUE,
  digits = 2, 
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  xlim = c(0.1, 10),
  xlab = "Favors: TIVA                             Inhaled",
  addrows.below.overall = 4,
  text.addline1 = "*Randomized clinical trial",
  fs.hetstat = 10,
  ...
)
}

# to add to tables will place in clipboard
complication_summary_rr_or <- function(compl_label){
  temp <- adverse_meta_wide_dat |> 
    filter(complication_nodesign == compl_label) |>
    filter(n_TIVA + n_Inhaled != 0) |>
    summarize(
      n_studies = n_distinct(refid),
      n_TIVA_events = sum(n_TIVA),
      n_Inhaled_events = sum(n_Inhaled),
      n_TIVA = sum(arm_n_TIVA),
      n_Inhaled = sum(arm_n_Inhaled),
      n_patients = sum(arm_n_TIVA) + sum(arm_n_Inhaled),
    ) |> 
    unlist() |> 
    toString() 
    # str_replace_all(",", "")
  
    clipr::write_clip(temp)
    temp
}

complication_summary_rd <- function(compl_label){
  temp <- adverse_meta_wide_dat |> 
    filter(complication_nodesign == compl_label) |>
    summarize(
      n_studies = n_distinct(refid),
      n_TIVA_events = sum(n_TIVA),
      n_Inhaled_events = sum(n_Inhaled),
      n_TIVA = sum(arm_n_TIVA),
      n_Inhaled = sum(arm_n_Inhaled),
      n_patients = sum(arm_n_TIVA) + sum(arm_n_Inhaled),
    ) |> 
    unlist() |> 
    toString()
  
    clipr::write_clip(temp)
    temp
}

```

<a id="myocardial_infarction"></a>

#### Myocardial Infarction

<foot_mg>    </foot_mg> 

<caption_mg> `r figure_ref()` Odds ratio for myocardial infarction (randomized and nonrandomized studies). </caption_mg>

```{r complication_mi}
#| echo: false
#| include: false

png("assets/kq4_complication_mi.png", width = 8.9, height = 4.2, units = "in", res = 300)
temp_meta <- complication_meta_or("Myocardial Infarction", use_hakn = TRUE, study_label = "study_design")
complication_forest_or(temp_meta, big.mark = ",", text.addline2 = risk_diff_meta_or())
dev.off()

# meta_rob_traffic_light_refid(temp_meta)
# complication_summary_rr_or("Myocardial Infarction")
# soe_meta_result_rr_or(temp_meta, "OR")
# soe_meta_rd_or(temp_meta, digits = 1)

```

![](assets/kq4_complication_mi.png){fig.align="left" width="65%"}


<a id="cardiac_arrest"></a>

#### Cardiac Arrest

<foot_mg>    </foot_mg>

<caption_mg> `r figure_ref()` Risk ratio for cardiac arrest (randomized and nonrandomized studies). </caption_mg>

```{r complication_cardiac_arrest}
#| echo: false
#| include: false
png("assets/kq4_complication_cardiac_arrest.png", width = 8.1, height = 2.8, units = "in", res = 300)
temp_meta <- complication_meta_rr("Cardiac Arrest", random = FALSE, use_hakn = FALSE)
complication_forest_rr(temp_meta, random = FALSE, big.mark = ",", text.addline2 = risk_diff_meta_rr())
dev.off()

# complication_summary_rr_or("Cardiac Arrest")
# meta_rob_traffic_light_refid(temp_meta)

```

![](assets/kq4_complication_cardiac_arrest.png){fig.align="left" width="59%"}

<a id="brady"></a>

#### Bradycardia

<foot_mg>    </foot_mg>

<caption_mg> `r figure_ref()` Risk ratio for bradycardia (randomized and nonrandomized studies). </caption_mg>

```{r complication_brady}
#| echo: false
#| include: false
png("assets/kq4_complication_brady.png", width = 8.11, height = 3.8, units = "in", res = 300)
temp_meta <- complication_meta_rr("Bradycardia", use_hakn = TRUE)
complication_forest_rr(temp_meta, big.mark = ",", text.addline2 = risk_diff_meta_rr())
dev.off()

# meta_rob_traffic_light_refid(temp_meta)
# complication_summary_rr_or("Bradycardia")
# soe_meta_result_rr_or(temp_meta, "OR")
# soe_meta_rd_rr(temp_meta, digits = 2)


```

![](assets/kq4_complication_brady.png){fig.align="left" width="59%"}

<a id="intraop_hypotension"></a>

#### Hypotension

<foot_mg>    </foot_mg>

<caption_mg> `r figure_ref()` Risk ratio for hypotension (randomized and nonrandomized studies). </caption_mg>

```{r complication_hypotension}
#| echo: false
#| include: false

png("assets/kq4_complication_hypotension.png", width = 8.02, height = 3.6, units = "in", res = 300)
temp_meta <- complication_meta_rr("Hypotension", use_hakn = FALSE)
complication_forest_rr(temp_meta, big.mark = ",", text.addline2 = risk_diff_meta_rr())
dev.off()

# meta_rob_traffic_light_refid(temp_meta)
# complication_summary_rr_or("Hypotension")
# soe_meta_result_rr_or(temp_meta, "RR")
# soe_meta_rd_rr(temp_meta, digits = 2)

```

![](assets/kq4_complication_hypotension.png){fig.align="left" width="59%"}

<a id="-stroke"></a>

#### Stroke

<foot_mg>    </foot_mg>

<caption_mg> `r figure_ref()` Odds ratio for stroke (randomized and nonrandomized studies). </caption_mg>

```{r complication_stroke}
#| echo: false
#| include: false

png("assets/kq4_complication_stroke.png", width = 8.13, height = 2.8, units = "in", res = 300)
temp_meta <- complication_meta_or("Stroke", use_hakn = FALSE, random = FALSE)
complication_forest_or(temp_meta, big.mark = ",", random = FALSE, text.addline2 = risk_diff_meta_or())
dev.off()

# meta_rob_traffic_light_refid(temp_meta)
# complication_summary_rr_or("Stroke")
# soe_meta_result_rr_or(temp_meta, "OR")
# soe_meta_rd_or(temp_meta, digits = 2)

```

![](assets/kq4_complication_stroke.png){fig.align="left" width="58%"}

<a id="aki"></a>

#### Acute Kidney Injury

<foot_mg>    </foot_mg>

<caption_mg> `r figure_ref()` Odds ratio for acute kidney injury complications (randomized and nonrandomized studies). </caption_mg>

```{r complication_renal}
#| echo: false
#| include: false

png("assets/kq4_complication_renal.png", width = 8.9, height = 4, units = "in", res = 300)
temp_meta <- complication_meta_or("Acute Kidney Injury", use_hakn = TRUE)
complication_forest_or(temp_meta, big.mark = ",", text.addline2 = risk_diff_meta_or(digits = 2))
dev.off()

# meta_rob_traffic_light_refid(temp_meta)
# complication_summary_rr_or("Acute Kidney Injury")
# soe_meta_result_rr_or(temp_meta, "OR")
# soe_meta_rd_or(temp_meta, digits = 2)

```

![](assets/kq4_complication_renal.png){fig.align="left" width="65%"}

<a id="pneum"></a>

#### Pneumonia

<foot_mg>    </foot_mg>

<caption_mg> `r figure_ref()` Risk ratio for pneumonia (randomized clinical trials). </caption_mg>

```{r complication_pneumonia}
#| echo: false
#| include: false

png("assets/kq4_complication_pneumonia.png", width = 8.54, height = 3.8, units = "in", res = 300)
temp_meta <- complication_meta_or("Pneumonia", use_hakn = TRUE, predictive = TRUE)
complication_forest_or(temp_meta, use_predictive = TRUE, text.addline2 = risk_diff_meta_or())
dev.off()

# meta_rob_traffic_light_refid(temp_meta)
# complication_summary_rr_or("Pneumonia")
# soe_meta_result_rr_or(temp_meta, "OR")
# soe_meta_rd_or(temp_meta, digits = 1)

# temp_meta$data |> 
#   filter(refid %in% c(17551, 18477)) |> 
#   summarize(
#     total = sum(arm_n_TIVA) + sum(arm_n_Inhaled),
#     studies = n()
#   )

```

![](assets/kq4_complication_pneumonia.png){fig.align="left" width="62%"}

<a id="pe"></a>

#### Pulmonary Embolism

<foot_mg>    </foot_mg>

<caption_mg> `r figure_ref()` Odds ratio for pulmonary embolism (randomized and nonrandomized studies). </caption_mg>

```{r complication_pe}
#| echo: false
#| include: false

png("assets/kq4_complication_pe.png", width = 9.1, height = 3.8, units = "in", res = 300)
temp_meta <- complication_meta_or("Pulmonary Embolism", use_hakn = TRUE, predictive = FALSE)
complication_forest_or(temp_meta, use_predictive = TRUE, big.mark = ",", text.addline2 = risk_diff_meta_or(digits = 2))
dev.off()

# meta_rob_traffic_light_refid(temp_meta)
# complication_summary_rr_or("Pulmonary Embolism")
# soe_meta_result_rr_or(temp_meta, "OR")
# soe_meta_rd_or(temp_meta, digits = 2)
# 
# # nrsi
# temp_meta$data |>
#   filter(refid %in% c(17551, 16890, 6964)) |>
#   summarize(
#     total = sum(arm_n_TIVA) + sum(arm_n_Inhaled),
#     studies = n()
#   )

```

![](assets/kq4_complication_pe.png){fig.align="left" width="65%"}

<a id="resp_fail"></a>

#### Respiratory Failure 

<foot_mg>    </foot_mg>

<caption_mg> `r figure_ref()` Odds ratio for respiratory failure (randomized and nonrandomized studies). </caption_mg>

```{r respiratory_failure}
#| echo: false
#| include: false

png("assets/kq4_respiratory_failure.png", width = 8.5, height = 3.6, units = "in", res = 300)
temp_meta <- complication_meta_or("Respiratory Failure", use_hakn = FALSE, predictive = FALSE)
complication_forest_or(temp_meta, use_predictive = TRUE, big.mark = ",", text.addline2 = risk_diff_meta_or(digits = 2))
dev.off()

# meta_rob_traffic_light_refid(temp_meta)
# complication_summary_rr_or("Respiratory Failure")
# soe_meta_result_rr_or(temp_meta, "OR")
# soe_meta_rd_or(temp_meta, digits = 2)
#  
# # # nrsi
# temp_meta$data |>
#   filter(refid %in% c(17551, 16890)) |>
#   summarize(
#     total = sum(arm_n_TIVA) + sum(arm_n_Inhaled),
#     studies = n()
#   )

```

![](assets/kq4_respiratory_failure.png){fig.align="left" width="62%"}

## **Patient Satisfaction**

<caption_mg> `r table_ref()` Patient reported satisfaction. </caption_mg>

```{r pt_satisfaction}
satis_dat_gt <- dichot_dat |>
  select(refid, year, study, study_l, arm_id, arm_n, arm, design_f_lab, matches("satis"), notes_d) |>
  left_join(surgs |> select(refid, surgs_noabbr_f), by = "refid") |>
  left_join(study_arm_dat |> select(refid, arm_id, asa_ps_incl), by = c("refid", "arm_id")) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |> # age_table
  filter(if_any(satis_n:satis_95high, ~ !is.na(.x))) |>
  select(!c(d_satisfaction, satis_pval:satis_95high)) |>
  mutate(
    n_percent = n_per_fun(satis_n, arm_n, n_sig_dig = 1),
    bar = case_when(
      str_detect(arm, "Inhaled") ~ bar_prop(satis_n / arm_n * 100, "#969696"),
      str_detect(arm, "TIVA") ~ bar_prop(satis_n / arm_n * 100, color_2)
    )
  ) |>
  arrange(year, study, arm_id) 

satis_dat_gt <- satis_dat_gt |>
  mutate(
    satis_n = case_when(
      study == "Luntz 2004" & arm_id == 1 ~ collapse_dichot(satis_dat_gt, "Luntz 2004", c(1, 2), satis_n),
      .default = satis_n
    ),
    arm_n = case_when(
      study == "Luntz 2004" & arm_id == 1 ~ collapse_dichot(satis_dat_gt, "Luntz 2004", c(1, 2), arm_n),
      .default = arm_n
    )
  ) |>
  filter(!(study %in% c("Luntz 2004") & arm_id == 2)) |>
  mutate(
    ref_arm_n = arm_n,
    ref_n = satis_n
  ) |>
  group_by(refid) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_n = ifelse(row_number() > 1, NA, ref_n)
  ) |>
  fill(ref_arm_n, ref_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_n = ifelse(row_number() == 1, NA, ref_n)
  ) |>
  ungroup() |>
  mutate(
    rd_ci = ifelse(!is.na(ref_n), rd_per_ci_fun(satis_n, arm_n, ref_n, ref_arm_n, digits = 1), "—")
  )
  
satis_dat_gt |> 
 mutate(study_l = ifelse(row_number() > 1, "", study_l), 
        surgs_noabbr_f = ifelse(row_number() > 1, "", as.character(surgs_noabbr_f)), 
        surgs_noabbr_f = ifelse(str_detect(surgs_noabbr_f, "Gast"), "GI/Abdominal", surgs_noabbr_f), 
        asa_ps_incl = ifelse(row_number() > 1, "", asa_ps_incl), 
        .by = study) |>
  gt(id = "one") |>
  cols_hide(c(refid, year, arm_id, study, design_f_lab, satis_n, satis_per, notes_d, ref_arm_n, ref_n, satis_update_arm_n)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              = "Anesth",
    asa_ps_incl      = "PS",
    age_table        = "Age",
    surgs_noabbr_f   = "Surgery",
    n_percent        = "     N (%)",
    bar              = "0 – 100%",
    rd_ci            = "RD (95% CI)"
  ) |>
  tab_spanner(label = "ASA", columns = c(asa_ps_incl), level = 1) |>
  fmt_markdown(columns = c(study_l, age_table, bar)) |>
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l          ~ px(165),
    arm_n            ~ px(45),
    arm              ~ px(80),
    asa_ps_incl      ~ px(60),
    age_table        ~ px(80),
    surgs_noabbr_f   ~ px(100),
    n_percent        ~ px(100),
    bar              ~ px(100),
    rd_ci            ~ px(140),
  ) |> 
  tab_style(style = cell_text(align = "center", font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |>
  tab_style(style = cell_text(align = "left"),        locations = cells_column_labels(columns = c(study, arm))) |> 
  tab_style(style = cell_text(align = "center"),      locations = cells_column_labels(columns = c(asa_ps_incl, age_table, n_percent))) |> 
  tab_footnote("Mean (SD).",   locations = cells_column_labels(columns = c(age_table))) |>
  tab_footnote("TIVA: total intravenous anesthesia; ASA PS: ASA Physical Status; RD: risk difference.") |> 
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(arm_n:n_percent), rows = str_detect(arm, "TIVA"))) |> 
  tab_footnote("Completely satisfied.",               locations = cells_body(columns = c(n_percent), rows = study == "Epple 2001"), placement = "right") |>  
  tab_footnote("Highly satisfied.",                   locations = cells_body(columns = c(n_percent), rows = study == "Luntz 2004"), placement = "right") |>  
  tab_footnote("Inhaled arms combined.",              locations = cells_body(columns = c(arm), rows = study == "Luntz 2004" & arm == "Inhaled"), placement = "right") |>  
  tab_footnote("Very satisfied.",                     locations = cells_body(columns = c(n_percent), rows = study == "Nishikawa 2007a"), placement = "right") 

```

<a id="pooled-pt-satisfaction"></a>

### *Pooled*

<foot_mg>    </foot_mg> 

<caption_mg> `r figure_ref()` Risk ratio for patient satisfaction (randomized clinical trials). </caption_mg>

```{r satis_rct_meta}
#| echo: false
#| include: false

satis_meta_dat <- satis_dat_gt |> 
  select(refid, year, study, arm, satis_n, arm_n) |> 
  pivot_wider(names_from = "arm", values_from = satis_n:arm_n) |> 
  left_join(rob2_meta_dat, by = "refid") 

satis_meta <- metabin(satis_n_TIVA, arm_n_TIVA, satis_n_Inhaled, arm_n_Inhaled,
  data = satis_meta_dat,
  studlab = study,
  # cluster = refid,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  method.random.ci = "classic",
  prediction = FALSE,
  allstudies = TRUE,
)

# summary(plac_meta)

png("assets/kq4_satis_rct.png", width = 8.02, height = 3.2, units = "in", res = 300)
forest(satis_meta,
  allstudies = TRUE,
  # random = FALSE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  just.addcols.right = "right",
  colgap.forest = "5mm",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  # xlim = c(0.1, 20),
  xlab = "Favors: Inhaled                       TIVA       ",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  text.addline1 = "Similar inhaled arms combined for Luntz 2004.",
  text.addline2 = "Comparing higher versus lower levels of satisfaction (see preceding table).",
)
dev.off()

```

![](assets/kq4_satis_rct.png){fig.align="left" width="58%"}

## **Length of Stay**

<caption_mg> `r table_ref()` Length of stay according to procedure classification and comparator. </caption_mg>

```{r length_of_stay}
#| echo: false
los_tab <- contin_dat |>
  mutate(los_for_tables(contin_dat)) |>
  filter(if_any(los_m:los_diff_pval, ~ !is.na(.))) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |> # age_table
  left_join(study_arm_dat |> select(refid, arm_id, asa_ps_incl), by = c("refid", "arm_id")) |>
  left_join(surgs |> select(refid, surgs_noabbr_f), by = c("refid")) |>
  left_join(study_char_dat |> select(refid, country), by = "refid") |>
  mutate(
    refid_arm_id = paste0(refid, "-", arm_id),
    surg_groups = paste0(design_f_lab, " - ", surgs_noabbr_f),
    mean_med = case_when(
      !is.na(los_m) ~ los_m,
      !is.na(los_med) ~ los_med
    ),
    calc_prop_35d = 100 * mean_med / 35,
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(calc_prop_35d, "#A93226"),
      .default = bar_prop(calc_prop_35d, "#969696")
    )
  ) |>
  arrange(surg_groups, year, study, arm_id) |>
  select(refid, refid_arm_id, study, study_l, arm_n, arm, asa_ps_incl, age_table, los_table, bar, surg_groups, country)

los_tab |>
  mutate(
    study_l = ifelse(row_number() > 1, "", study_l),
    country = ifelse(row_number() > 1, "", country),
    .by = refid
  ) |>
  # tabyl(surg_groups) |> pull(surg_groups) |> toString()
  group_by(surg_groups) |>
  gt(id = "one") |>
  row_group_order(groups = c(
    "Randomized Clinical Trial - Cardiac",
    "Randomized Clinical Trial - Thoracic",
    "Randomized Clinical Trial - Gastrointestinal/Abdominal",
    "Randomized Clinical Trial - Various",
    "Retrospective Cohort - Cardiac",
    "Retrospective Cohort - Orthopedic",
    "Retrospective Cohort - Various"
  )) |>
  cols_hide(c(refid, refid_arm_id, study)) |>
  cols_label(
    study_l = "Study",
    arm_n = " N",
    arm = "Anesth",
    asa_ps_incl = "PS",
    age_table = "    Age",
    los_table = "    LOS",
    bar = "0 – 35 days",
    country = "Country"
  ) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",") |>
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(60),
    arm ~ px(80),
    asa_ps_incl ~ px(60),
    age_table ~ px(100),
    los_table ~ px(100),
    bar ~ px(120),
    country ~ px(80)
  ) |>
  fmt_markdown(columns = c(study_l, bar, age_table, los_table)) |>
  tab_style(style = cell_text(align = "center", font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(arm_n, arm, bar))) |>
  tab_style(style = cell_text(align = "left"), locations = cells_column_labels(columns = c(study_l, age_table, los_table))) |>
  tab_style(style = cell_text(align = "left"), locations = cells_body(columns = c(study_l, age_table, los_table, bar, arm))) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n:los_table), rows = str_detect(arm, "TIVA"))) |>
  tab_footnote(md("NR: not reported")) |>
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table, los_table))) |>
  tab_footnote(md("ASA Physical Status."), locations = cells_column_labels(columns = c(asa_ps_incl)))

```

<a id="pooled-los-rct"></a>

### *Pooled*

<foot_mg>    </foot_mg> 

<caption_mg> `r figure_ref()` Mean difference in length of stay (randomized clinical trials). </caption_mg>

```{r los_meta}
#| echo: false
#| include: false 

los_meta_dat <- contin_dat |>
  filter(refid %in% los_tab$refid) |> 
  select(refid, study, design_f_lab, arm, arm_n, los_m, los_sd, los_med, los_rl, los_ru, los_iqrl, los_iqru, los_95l, los_95u) |> 
  rename_with(~ str_remove(.x, "los_")) |> 
  select(!matches("95")) |> 
  pivot_wider(names_from = "arm", values_from = arm_n:iqru) |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  arrange(year) 

los_rct_meta_dat <- los_meta_dat |> 
  filter(str_detect(design_f_lab, "Rand")) |> 
  left_join(rob2_meta_dat, by = "refid") |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid")

# los_rct_meta_dat |>
#   summarise(
#     n_TIVA = sum(arm_n_TIVA),
#     n_Inhaled = sum(arm_n_Inhaled),
#     total = n_TIVA + n_Inhaled,
#   )

los_nrsi_meta_dat <- los_meta_dat |> 
  filter(!str_detect(design_f_lab, "Rand")) |> 
  left_join(robinsi_meta_dat, by = "refid") |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid")

los_meta <- metacont(
  n.e = arm_n_TIVA, 
  n.c = arm_n_Inhaled,
  common =  TRUE,
  mean.e = m_TIVA,
  sd.e = sd_TIVA,
  median.e = med_TIVA,
  q1.e = iqrl_TIVA,
  q3.e = iqru_TIVA,
  min.e = rl_TIVA,
  max.e = ru_TIVA,
  mean.c = m_Inhaled,
  sd.c = sd_Inhaled,
  median.c = med_Inhaled,
  q1.c = iqrl_Inhaled,
  q3.c = iqru_Inhaled,
  min.c = rl_Inhaled,
  max.c = ru_Inhaled,
  data = los_rct_meta_dat,
  sm = "MD",
  method.random.ci = "HK",
  method.tau = "REML",
  prediction = TRUE,
  studlab = study
)

png("assets/kq4_los_rct.png", width = 9.32, height = 3.77, units = "in", res = 300)
forest(los_meta,
  weight.study = "random",
  common =  TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  print.tau2 = FALSE,
  print.tau = TRUE,
  print.tau.ci = TRUE,
  digits = 1,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau = 1,
  # digits.pval.Q = 2,
  print.I2.ci = TRUE,
  fs.xlab = 10,
  just.addcols.right = "right",
  print.pval.Q = FALSE,
  # sortvar = -TE,
  xlim = c(-10, 10),
  # at = c(-80, -60, -40, -20, 0, 20, 40),
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("MD ", "(95% CI)   ", "Procedure"),
  xlab = "Favors: TIVA                                      Inhaled           ",
  smlab = "Mean Difference (days)",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  text.addline1 = "If the mean or standard deviation were not reported, they were imputed from from the median, interquartile range, and/or range."
)
dev.off()

```

![](assets/kq4_los_rct.png){fig.align="left" width="68%"}

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### Meta-analysis methods detail.

```{r}
#| include: false  

temp <- print(los_meta) |> 
  str_replace_all("\\n", "<br/> ") |>
  str_remove("<br/> Details on meta-analytical method:<br/> ") |> 
  str_replace_all("tau\\^2", "tau<sup>2</sup>") |> 
  str_replace_all("tau", "&tau;")

```

<foot_mg> `r temp` </foot_mg>
:::

<a id="pooled-los-nrsi"></a>  

<foot_mg>    </foot_mg> 

<caption_mg> `r figure_ref()` Mean difference in length of stay (nonrandomized designs). </caption_mg>

```{r los_nrsi_meta}
#| echo: false
#| include: false

los_meta <- metacont(
  n.e = arm_n_TIVA, 
  n.c = arm_n_Inhaled,
  common =  TRUE,
  mean.e = m_TIVA,
  sd.e = sd_TIVA,
  median.e = med_TIVA,
  q1.e = iqrl_TIVA,
  q3.e = iqru_TIVA,
  min.e = rl_TIVA,
  max.e = ru_TIVA,
  mean.c = m_Inhaled,
  sd.c = sd_Inhaled,
  median.c = med_Inhaled,
  q1.c = iqrl_Inhaled,
  q3.c = iqru_Inhaled,
  min.c = rl_Inhaled,
  max.c = ru_Inhaled,
  data = los_nrsi_meta_dat,
  sm = "MD",
  method.tau = "REML",
  method.random.ci = "classic",
  prediction = TRUE,
  studlab = study
)

png("assets/kq4_los_nrsi.png", width = 9.87, height = 3.2, units = "in", res = 300)
forest(los_meta,
  weight.study = "random",
  common =  FALSE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  print.tau2 = FALSE,
  print.tau = TRUE,
  print.tau.ci = TRUE,
  digits = 1,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau = 1,
  print.I2.ci = TRUE,
  fs.xlab = 10,
  just.addcols.right = "right",
  print.pval.Q = FALSE,
  # sortvar = -TE,
  xlim = c(-10, 10),
  # at = c(-80, -60, -40, -20, 0, 20, 40),
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("MD", "(95% CI)  ", "Procedure"),
  xlab = "Favors: TIVA                                      Inhaled           ",
  smlab = "Mean Difference (days)",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  big.mark = ",",
  text.addline1 = "If the mean or standard deviation were not reported, they were imputed from from the median, interquartile range, and/or range."
)
dev.off()

```

![](assets/kq4_los_nrsi.png){fig.align="left" width="71%"}

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### Meta-analysis methods detail.

```{r}
#| include: false  

temp <- print(los_meta,) |> 
  str_replace_all("\\n", "<br/> ") |>
  str_remove("<br/> Details on meta-analytical method:<br/> ") |> 
  str_replace_all("tau\\^2", "tau<sup>2</sup>") |> 
  str_replace_all("tau", "&tau;")

```

<foot_mg> `r temp` </foot_mg>
:::

<br/>

## **Discharge Location**

<caption_mg> `r table_ref()` Discharge location in nonrandomized study. </caption_mg>

```{r dc_loc}
#| eval: true
dc_loc_dat <- dichot_dat |>
  filter(if_any(starts_with("disch_"), ~ !is.na(.x))) |>
  mutate(
    arm_n = ifelse(!is.na(disch_update_arm_n), disch_update_arm_n, arm_n),
    disch_nper = n_per_fun(disch_inst_n, arm_n, n_sig_dig = 1),
    disch_per = disch_inst_n/arm_n
  ) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |> # age_table
  left_join(study_arm_dat |> select(refid, arm_id, asa_ps_incl), by = c("refid", "arm_id")) |>
  left_join(surgs |> select(refid, surgs_noabbr_f), by = c("refid")) |>
  left_join(study_char_dat |> select(refid, country), by = "refid") |>
  mutate(design_surg = paste0(design_f_lab, " — ", surgs_noabbr_f)) |>
  select(refid, refid, arm_id, study, study_l, arm_n, arm, asa_ps_incl, age_table, design_surg, country, starts_with("disch_")) |>
  select(-c(disch_inst_per:disch_inst_95high)) |> 
  arrange(refid, arm_id) |> 
  group_by(study) |> 
  mutate(
    ref_disch_n = ifelse(arm_id > 1, first(disch_inst_n), NA),
    ref_arm_n = ifelse(arm_id > 1, first(arm_n), NA),
    rr_ci = ifelse(!is.na(ref_disch_n), rr_ci_fun(disch_inst_n, arm_n, ref_disch_n, ref_arm_n), NA)) |> 
  select(-starts_with("ref_")) 
```

```{r dc_loc_gt}
dc_loc_dat |> 
  group_by(study_l) |>
  arrange(study, arm_id) |> 
  mutate(
    study_l = ifelse(row_number() == 1, study_l, NA),
    country = ifelse(row_number() == 1, country, NA),
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(disch_per * 100, "#A93226"),
      .default = bar_prop(disch_per * 100, "#969696")
    ),
  ) |>
  ungroup() |>
  select(refid, study_l, arm_n, arm, age_table, country, disch_nper, bar, rr_ci, everything()) |> 
  group_by(design_surg) |>
  gt(id = "one") |>
  row_group_order(groups = c("Retrospective Cohort — Orthopedic")) |>
  cols_hide(c(refid, arm_id, study, disch_update_arm_n, asa_ps_incl, disch_inst_n, disch_per)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              = "Arm",
    age_table        = "   Age",
    country          = "Country",
    disch_nper       = "N (%)",
    bar              = "0 — 100%",
    rr_ci            = "RR (95% CI)"
  ) |>
  tab_spanner(label = "Discharge to Institution", columns = c(disch_nper:bar), level = 1) |>
  fmt_markdown(columns = c(study_l, bar, age_table)) |>
  # fmt_number(VARIABLE, decimals = 0) |>
  # fmt_integer(use_seps = TRUE, sep_mark = ",") |>
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l          ~ px(165),
    arm_n            ~ px(45),
    arm              ~ px(50),
    age_table        ~ px(90),
    country          ~ px(80),
    disch_nper       ~ px(80),
    bar              ~ px(120),
    rr_ci            ~ px(120)
    ) |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(study, age_table, arm))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(rr_ci, country))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_column_labels(columns = c(arm_n, disch_nper))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(study, age_table, arm, bar))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(rr_ci, country))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_body(columns = c(disch_nper))) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n, arm, age_table, disch_nper), rows = str_detect(arm, "TIVA"))) |> 
  tab_footnote("Gen: general; Neur: neuraxial; RR: risk ratio.") |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table)))

```

<a id="mort"></a>

## **Mortality**

```{r mortality_data}
#| eval: true
mortality_dat <- dichot_dat |>
  filter(if_any(starts_with("mort"), ~ !is.na(.x))) |> 
  # filter(arm_n != mort_update_arm_n) |> 
  # select(refid, arm_n, mort_update_arm_n)
  mutate(
    # arm_n use mort_update_arm_n if different
    arm_n = ifelse(!is.na(mort_update_arm_n), mort_update_arm_n, arm_n)
  ) |> 
  select(refid, refid_c, arm_id, arm, year, study, study_l, design_f_lab, arm_n, matches("_n|per|est|low|high") & starts_with("mort"), -mort_update_arm_n) |> 
  # select(refid, refid_c, arm_id, arm, year, study, study_l, design_f_lab, arm_n, matches("_n|per") & starts_with("mort"), -mort_update_arm_n) |> 
  pivot_longer(
    cols = starts_with("mort"),
    names_to = "estimand",
    values_to = "estimate",
    values_drop_na = TRUE
  ) |>
  mutate(
    mort_period = str_remove(estimand, "_.*"),
    estimand = str_replace(estimand, ".*_(.*)$", "\\1")
  ) |>
  pivot_wider(
    names_from = estimand,
    values_from = estimate
  ) |>
  mutate(
    mort_period = case_when(
      str_detect(mort_period, "hosp") ~ "Hospital",
      str_detect(mort_period, "mort30") ~ "30-day",
      str_detect(mort_period, "mort90") ~ "90-day",
      str_detect(mort_period, "mort1") ~ "1-year"
    ), 
    per = per/100
  ) |>
  rename(mort_n = n, mort_per_rep = per) |>
  # for Park 2020 and Dai 2021 reported both in-hospital and 30-day; Zangrillo 2011 1-year and 30-day (use 30-day) to distinguish
  mutate(
    refid_c = ifelse(study %in% c("Park 2020", "Dai 2021", "Zangrillo 2011") & mort_period == "30-day", paste0(refid_c, "-30"), refid_c),
  ) |> 
  arrange(refid_c, arm_id) |>
  mutate(
    ref_arm_n = arm_n,
    ref_mort_n = mort_n
  ) |>
  group_by(refid_c) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_mort_n = ifelse(row_number() > 1, NA, ref_mort_n)
  ) |>
  fill(ref_arm_n, ref_mort_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_mort_n = ifelse(row_number() == 1, NA, ref_mort_n)
  ) |>
  ungroup() |> 
  left_join(study_char_dat |> select(refid, surgs_single_f), by = "refid") |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |>
  left_join(asa_combine |> select(refid, arm_id, asa_ps_incl), by = c("refid", "arm_id")) |> 
  mutate(mort_percent = mort_n/arm_n,
         mort_period = factor(mort_period, levels = c("Hospital", "30-day", "90-day", "1-year"))) |>
  rename(low = "95low", high = "95high") |>
  select(refid, refid_c, arm_id, year, study, study_l, arm_n, arm, asa_ps_incl, age_table, design_f_lab, mort_n, mort_percent, ref_mort_n, ref_arm_n, mort_period, mort_per_rep, surgs_single_f, est, low, high)

```

<font size = 4> `r table_ref()` Reported in-hospital, 30-day, and 1-year mortality in randomized clinical trials.</font>

```{r mortality_rct_gt}
#| eval: true
mortality_dat |>
  arrange(mort_period, surgs_single_f, year, study, arm_id) |>
  filter(str_detect(design_f_lab, "Rand")) |> 
  group_by(mort_period, study_l) |>
  mutate(
    surgs_single_f = as.character(surgs_single_f),
    study_l = ifelse(row_number() == 1, study_l, NA),
    study = ifelse(row_number() == 1, study, NA),
    across(c(surgs_single_f, asa_ps_incl,), ~ ifelse(row_number() > 1, NA, .x)),
    # bar = bar_prop(50, color_1),
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(mort_percent * 100, "#A93226"),
      !is.na(est) ~ NA,
      .default = bar_prop(mort_percent * 100, "#969696")
    ),
  ) |>
  ungroup() |>
  mutate(
    # de Jonghe 2014 reported in hospital and 90-day
    # study_l = ifelse(refid == 16552 & arm_id == 1, "[de Jonghe 2014](evidence_tables.html#16552)", study_l),
    # surgs_single_f = ifelse(refid == 16552 & arm_id == 1, "Ortho", surgs_single_f),
    rd_ci = ifelse(!is.na(ref_mort_n), rd_per_ci_fun(mort_n, arm_n, ref_mort_n, ref_arm_n, digits = 1), "—"),
    rd_ci = ifelse(!is.na(est), paste0("<u>", est, " (", low, "—", high, ")", "</u>"), rd_ci),
    mort_n_percent = n_per_fun(mort_n, arm_n, 1)
  ) |> 
  relocate(surgs_single_f, .before = asa_ps_incl) |> 
  relocate(mort_n_percent, .before = bar) |> 
  select(-mort_n) |> 
  arrange(year, refid_c, arm_id) |> 
  group_by(mort_period) |> 
  gt(id = "one") |> 
  cols_hide(c(refid, refid_c, arm_id, year, study, design_f_lab, mort_percent, ref_mort_n, ref_arm_n, mort_per_rep, est, low, high)) |>
  # row_group_order(groups = c("Hospital", "30-day", "90-day")) |> 
  cols_label(
    study_l = "Study",
    arm_n = "N  ",
    arm = "Arm",
    surgs_single_f = "Surgery",
    age_table = "Age",
    asa_ps_incl = "PS",
    mort_n_percent = "N (%)",
    bar = md("0 - 100%"),
    rd_ci = "RD (95% CI)"
  ) |> 
  fmt_markdown(columns = c(study_l, bar, age_table)) |>
  tab_spanner(label = "Mortality", columns = c(mort_n_percent, bar)) |> 
  tab_spanner(label = "ASA", columns = c(asa_ps_incl)) |> 
  row_group_order(groups = c("Hospital", "30-day", "1-year")) |> 
  gt_theme_mg() |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(study, arm, surgs_single_f))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(age_table, asa_ps_incl, rd_ci))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(study, arm, surgs_single_f, bar))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(rd_ci))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_column_labels(columns = c(arm_n, mort_n_percent))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_body(columns = c(mort_n_percent))) |>
  tab_style(style = cell_text(align = "center",  font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |> 
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n, arm, age_table, mort_n_percent), rows = str_detect(arm, "TIVA"))) |> 
  sub_missing(columns = everything(), rows = everything(), missing_text = "") |> 
  cols_width(
    study_l ~ px(140),
    arm_n ~ px(65),
    arm ~ px(70),
    surgs_single_f ~ px(95),
    age_table ~ px(100),
    asa_ps_incl ~ px(60),
    mort_n_percent ~ px(80),
    bar ~ px(100),
    rd_ci ~ px(145)
  ) |> 
  # opt_css(css = "#one .gt_column_spanner {border-bottom-style: hidden;}") |>
  tab_footnote("ASA PS: American Society of Anesthesiologists Physical Status; Vasc: vascular; GI/Abd: gastrointestinal/abdominal; RD: risk difference; NR: not reported.") |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table)))  
  # tab_footnote("Different lengths of follow-up from the same trial.", locations = cells_body(columns = study_l, rows = study %in% c("Su 2016", "Zhang 2019b"))) 

```

<a id="mortality_nrsi"></a>

<br/>

<font size = 4> `r table_ref()` Reported in-hospital and 30-day mortality in nonrandomized designs (all retrospective cohort studies).</font>

```{r mortality_nrsi_gt}
#| eval: true
mortality_dat |>
  arrange(mort_period, surgs_single_f, year, study, arm_id) |>
  filter(!str_detect(design_f_lab, "Rand")) |> 
  group_by(mort_period, study_l) |>
  mutate(
    surgs_single_f = as.character(surgs_single_f),
    study_l = ifelse(row_number() == 1, study_l, NA),
    study = ifelse(row_number() == 1, study, NA),
    across(c(surgs_single_f, asa_ps_incl,), ~ ifelse(row_number() > 1, NA, .x)),
    # bar = bar_prop(50, color_1),
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(mort_percent * 100, "#A93226"),
      .default = bar_prop(mort_percent * 100, "#969696")
    ),
  ) |> 
  ungroup() |> 
  mutate(
    # de Jonghe 2014 reported in hospital and 90-day
    # study_l = ifelse(refid == 16552 & arm_id == 1, "[de Jonghe 2014](evidence_tables.html#16552)", study_l),
    # surgs_single_f = ifelse(refid == 16552 & arm_id == 1, "Ortho", surgs_single_f),
    rd_ci = ifelse(!is.na(ref_mort_n), rd_per_ci_fun(mort_n, arm_n, ref_mort_n, ref_arm_n, digits = 1), "—"),
    rd_ci = ifelse(!is.na(est), paste0("<u>", est, " (", low, "—", high, ")", "</u>"), rd_ci),
    mort_n_percent = n_per_fun(mort_n, arm_n, 1)
  ) |> 
  relocate(surgs_single_f, .before = asa_ps_incl) |> 
  relocate(mort_n_percent, .before = bar) |> 
  select(-mort_n) |> 
  arrange(year, refid_c, arm_id) |> 
  group_by(mort_period) |> 
  gt(id = "one") |> 
  cols_hide(c(refid, refid_c, arm_id, year, study, design_f_lab, mort_percent, ref_mort_n, ref_arm_n, mort_per_rep, est, low, high)) |>
  # row_group_order(groups = c("Hospital", "30-day", "90-day")) |> 
  cols_label(
    study_l = "Study",
    arm_n = "N    ",
    arm = "Arm",
    surgs_single_f = "Surgery",
    age_table = "Age",
    asa_ps_incl = "PS",
    mort_n_percent = "N (%)",
    bar = md("0 - 100%"),
    rd_ci = md("RD <u>OR</U> (95% CI)")
  ) |> 
  fmt_markdown(columns = c(study_l, bar, age_table, rd_ci)) |>
  tab_spanner(label = "Mortality", columns = c(mort_n_percent, bar)) |> 
  tab_spanner(label = "ASA", columns = c(asa_ps_incl)) |> 
  fmt_integer(use_seps = TRUE, sep_mark = ",") |>
  gt_theme_mg() |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(study, arm, surgs_single_f))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(age_table, asa_ps_incl, rd_ci))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(study, arm, surgs_single_f, bar))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(rd_ci))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_column_labels(columns = c(arm_n, mort_n_percent))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_body(columns = c(mort_n_percent))) |>
  tab_style(style = cell_text(align = "center",  font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |> 
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n, arm, age_table, mort_n_percent), rows = str_detect(arm, "TIVA"))) |> 
  sub_missing(columns = everything(), rows = everything(), missing_text = "") |> 
  cols_width(
    study_l ~ px(140),
    arm_n ~ px(65),
    arm ~ px(70),
    surgs_single_f ~ px(95),
    age_table ~ px(100),
    asa_ps_incl ~ px(60),
    mort_n_percent ~ px(80),
    bar ~ px(100),
    rd_ci ~ px(145)
  ) |> 
  # opt_css(css = "#one .gt_column_spanner {border-bottom-style: hidden;}") |>
  tab_footnote("ASA PS: American Society of Anesthesiologists Physical Status; RD: risk difference; GI: gastrointestinal; Abd: abdominal (includes hepatic); Various: more that one procedure category.") |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table))) |> 
  tab_footnote("Odds ratios for studies reporting adjusted results (e.g., propensity matched).", locations = cells_column_labels(columns = rd_ci))
  # tab_footnote("Different lengths of follow-up from the same trial.", locations = cells_body(columns = study_l, rows = study %in% c("Su 2016", "Zhang 2019b"))) 

```

<a id="pooled-morality-rct"></a>

### *Pooled*

<foot_mg>    </foot_mg> 

```{r mortality_meta}
#| eval: true

# hosp & 30-day
mortality_rct_meta_dat <- mortality_dat |>
  filter(str_detect(design_f_lab, "Rand")) |> 
  filter(mort_period %in% c("Hospital", "30-day")) |>
  # exclude Dai 2021 hospital 30-day; retain 30-day
  filter(!(study == "Dai 2021" & mort_period == "Hospital")) |> 
  select(refid, study, arm, mort_n, arm_n, mort_period)

pairwise_rct_mort_dat <- pairwise(
  treat = arm,
  event = mort_n,
  n = arm_n,
  studlab = study,
  allstudies = TRUE,
  data = mortality_rct_meta_dat,
  sm = "RR",
  keep.all.comparisons = TRUE
)

mortality_nrsi_meta_dat <-  mortality_dat |>
  filter(!str_detect(design_f_lab, "Rand")) |> 
  filter(mort_period %in% c("Hospital", "30-day")) |>
  # exclude hospital retain 30-day
  filter(!(study %in% c("Jakobsen 2007", "Park 2020") & mort_period == "Hospital")) |> 
  select(refid, study, arm, mort_n, arm_n, mort_period, est, low, high, -mort_period) |> 
  arrange(refid, est) |> 
  group_by(refid) |>
  fill(est, low, high) |> 
  ungroup() |>
  pivot_wider(
    id_cols = c(refid, study, est, low, high),
    names_from = arm,
    values_from = c(mort_n, arm_n)
  ) |>
  mutate(
    ln_or = or_ln_te_fun(mort_n_TIVA, arm_n_TIVA, mort_n_Inhaled, arm_n_Inhaled),
    ln_se = or_ln_se_fun(mort_n_TIVA, arm_n_TIVA, mort_n_Inhaled, arm_n_Inhaled),
    ln_or = ifelse(!is.na(est), log(est), ln_or),
    ln_se = ifelse(!is.na(est), (log(high) - log(low)) / (2 * 1.96), ln_se),
  ) |> 
  select(-c(est:high))

# 1-year
mortality_1yr_meta_dat <- mortality_dat |>
  filter(mort_period %in% c("1-year")) |>
  select(refid, study, arm, mort_n, arm_n, mort_period)

pairwise_mort_1yr_dat <- pairwise(
  treat = arm,
  event = mort_n,
  n = arm_n,
  studlab = study,
  allstudies = TRUE,
  data = mortality_1yr_meta_dat,
  sm = "RR",
  keep.all.comparisons = TRUE
)

# pairwise_rct_mort_dat |>
#   # filter(event1 > 0 | event2 > 0) |>
#   summarise(
#     studies = n(),
#     tiva_event = sum(event2),
#     inhale_event = sum(event1),
#     tiva_n = sum(n2),
#     inhale_n = sum(n1),
#     total = sum(n1 + n2)
#   )


```

<caption_mg> `r figure_ref()` Risk ratio for hospital or 30-day mortality (randomized clinical trials). </caption_mg>

```{r mort_rct_meta}
#| echo: false
#| include: false

mort_meta_dat <- pairwise_rct_mort_dat |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  left_join(rob2_meta_dat, by = "refid") |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid") |> 
  select(study, year, event2, n2, event1, n1, surgs_single, D1:Overall, mort_period, refid)

# total_meta(mort_meta_dat)
# refid_meta_fun(mort_meta_dat)

mort_rct_meta <- metabin(event2, n2, event1, n1,
  data = mort_meta_dat,
  studlab = study,
  # cluster = refid,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  method.random.ci = "classic",
  prediction = FALSE,
  allstudies = FALSE,
)

temp_meta <- mort_rct_meta

# summary(plac_meta)

png("assets/kq4_mort_rct.png", width = 9.12, height = 3.6, units = "in", res = 300)
forest(mort_rct_meta,
  allstudies = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("RR", "(95% CI)", "Procedure"),
  just.addcols.right = "left",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  xlim = c(0.1, 20),
  xlab = "Favors: TIVA                       Inhaled       ",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  big.mark = ",",
  method.random.ci = "HK",
  text.addline1 = risk_diff_meta_rr()
)
dev.off()

#                    RR            95%-CI    z p-value
# Zangrillo 2011 2.0000 (0.1881, 21.2627) 0.57  0.5655

```

![](assets/kq4_mort_rct.png){fig.align="left" width="67%"}

<a id="mort_nsri"></a>

<br/> 

<caption_mg> `r figure_ref()` Risk ratio for hospital or 30-day mortality (nonrandomized designs). </caption_mg>

```{r mort_nrsi_meta}
#| echo: false
#| include: false

mort_meta_dat <- mortality_nrsi_meta_dat |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid")
  # select(study, year, event2, n2, event1, n1, surgs_single,  mort_period, refid)

# total_meta(mort_meta_dat)
# refid_meta_fun(mort_meta_dat)

mort_nrsi_meta <- metagen(ln_or, ln_se,
  data = mort_meta_dat,
  studlab = study,
  sm = "OR",
  method.tau = "REML",
  method.random.ci = "HK",
  prediction = TRUE,
  allstudies = FALSE,
)

# summary(plac_meta)

temp_meta <- mort_nrsi_meta
temp_meta <- metabin(
  mort_n_TIVA, arm_n_TIVA, mort_n_Inhaled, arm_n_Inhaled,
  data = mort_meta_dat,
  studlab = study,
  sm = "OR",
  method.tau = "REML",
  method.random.ci = "HK",
  prediction = TRUE,
  allstudies = FALSE,
)

# riskdiff_ci_from_meta_or <- function(meta_object, pscale = 1, digits = 2) {

temp <- metaprop(mort_n_Inhaled, arm_n_Inhaled, data = mort_meta_dat)
control_arm <- boot::inv.logit(temp$TE.common)
odds_ratios <- exp(c(mort_nrsi_meta$TE.random, mort_nrsi_meta$lower.random, mort_nrsi_meta$upper.random))
temp <- effectsize::oddsratio_to_arr(odds_ratios, control_arm) * 1000
temp <- formatC(temp, digits = 2, format = "f")
paste0(temp[1], " per ", 1000, " (95% CI, ", temp[2], " to ", temp[3], ")")

png("assets/kq4_mort_nrsi.png", width = 9.92, height = 4, units = "in", res = 300)
forest(mort_nrsi_meta,
  allstudies = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("OR", "(95% CI)  ", "Procedure"),
  leftcols = c("studlab", "mort_n_TIVA", "arm_n_TIVA", "mort_n_Inhaled", "arm_n_Inhaled"),
  leftlabs = c("Study", "TIVA\n Events", "Total", "Inhaled\nEvents", " Total"),
  colgap.forest = "5mm",
  just.addcols.left = "right",
  just.addcols.right = "left",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  xlim = c(0.1, 10),
  xlab = "Favors: TIVA                                     Inhaled       ",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  big.mark = ",",
  method.random.ci = "HK",
  text.addline2 = paste0("Approximate pooled risk difference ", temp[1], " per ", 1000, " (95% CI, ", temp[2], " to ", temp[3], ")")
)
dev.off()

```

![](assets/kq4_mort_nrsi.png){fig.align="left" width="72%"}

<a id="mort-1yr"></a>

<br/>

<caption_mg> `r figure_ref()` Risk ratio for 1-year mortality (randomized and nonrandomized). </caption_mg>

```{r mort_1yr_meta}
#| echo: false
#| include: false

mort_meta_1yr_dat <- pairwise_mort_1yr_dat |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid") |> 
  select(study, year, event2, n2, event1, n1, surgs_single, refid)

# total_meta(mort_meta_1yr_dat)
# refid_meta_fun(mort_meta_1yr_dat)

mort_1yr_meta <- metabin(event2, n2, event1, n1,
  data = mort_meta_1yr_dat,
  studlab = study,
  random = FALSE,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  method.random.ci = "classic",
  prediction = FALSE,
  allstudies = FALSE,
)

temp_meta <- mort_1yr_meta

# summary(plac_meta)

png("assets/kq4_mort_1yr.png", width = 8.99, height = 2.6, units = "in", res = 300)
forest(mort_1yr_meta,
  allstudies = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("RR", "(95% CI)", "Procedure"),
  just.addcols.right = "left",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  xlim = c(0.1, 20),
  xlab = "Favors: TIVA                       Inhaled       ",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  big.mark = ",",
  text.addline1 = risk_diff_meta_rr()
)
dev.off()

# meta_rob_traffic_light_refid(mort_1yr_meta)
# soe_meta_result_rr_or(mort_1yr_meta, "RR")
# soe_meta_rd_rr(mort_1yr_meta, digits = 1)


```

![](assets/kq4_mort_1yr.png){fig.align="left" width="67%"}

## **Risk of Bias**

### Randomized

<caption_mg> `r figure_ref()` Summary risk of bias assessment for randomized clinical trials. </caption_mg>

```{r rob2_summary_overall, fig.height = 3, out.width = "60%"}
rob_temp_dat <- rob2_dat |>
  filter(!is.na(Study) & refid %in% kq4_refid) |> 
  select(-refid)

rob_summary(rob_temp_dat, tool = "ROB2", colour = "colourblind", weighted = FALSE)
```

<caption_mg> `r figure_ref()` Risk of bias assessments for randomized clinical trials. </caption_mg>

```{r rob_overall_study, out.width = "55%", fig.height = 7}
#| warning: false
rob_traffic_light(rob_temp_dat, psize = 4, tool = "ROB2", colour = "colourblind")
```

### Nonrandomized

<caption_mg> `r figure_ref()` Summary risk of bias assessment for nonrandomized studies. </caption_mg>

```{r nrsi_summary_overall, fig.height = 3, out.width = "60%"}
robinsi_temp_dat <- robinsi_dat |>
  filter(!is.na(Study) & refid %in% kq4_refid) |> 
  select(-refid)

rob_summary(robinsi_temp_dat, tool = "ROBINS-I", colour = "colourblind", weighted = FALSE)
```

<caption_mg> `r figure_ref()` Risk of bias assessments for nonrandomized studies. </caption_mg>

```{r nrsi_overall_study, out.width = "55%", fig.height = 5}
#| warning: false
rob_traffic_light(robinsi_temp_dat, psize = 4, tool = "ROBINS-I", colour = "colourblind")
```

## **References** {#references}
