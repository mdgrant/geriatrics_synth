---
title: "TIVA versus Inhaled Anesthesia"
editor: source
toc-title: "**TIVA versus Inhaled Anesthesia**"
toc-location: "left"
toc-depth: 4
toc_float: 
  collapsed: false
tbl-cap-location: "top"
page-layout: full
css: styles.css
tables:
      style: Table
      caption:
        pre: "Table "
        sep: " -- "
bibliography: "bib/kq4.bib"
csl: jama.csl
link-citations: false
nocite: '@*'
---

## Key Question

Among older patients undergoing surgery with general anesthesia, does the use of intravenous agents for maintenance of anesthesia improve postoperative outcomes compared with inhaled agents?

```{r read_data}
#| include: false
source("code/load_data.R")
# kq4_refid <- kq4_refid[!kq4_refid %in% c(290, 17101)]

study_char_dat <- data_kq(study_char_dat, kq4_refid) |> 
  mutate(
  surgs = ifelse(str_count(surgs, "\\|") > 3 | str_detect(surgs, "Various"), "Various", surgs))

study_arm_dat <- data_kq(study_arm_dat, kq4_refid) |> 
  mutate(arm = ifelse(arm_kq4_iv_inhale == "tiva", "TIVA", "Inhaled"))

contin_dat <- data_kq(contin_dat, kq4_refid) |> 
  left_join(study_arm_dat |> select(refid, arm_id, arm), by = c("refid", "arm_id")) |> 
  relocate(arm, .after = arm_id)

likert_dat <- data_kq(likert_dat, kq4_refid) |> 
  left_join(study_arm_dat |> select(refid, arm_id, arm), by = c("refid", "arm_id")) |> 
  relocate(arm, .after = arm_id)

# VARIABLE: delirium_inc_prop <lgl> [dichot_dat] reported incidence proportion
# VARIABLE: neurocog_inc_prop <lgl> [dichot_dat] reported incidence proportion
# VARIABLE: delirium_day_max <num> [dichot_dat] max of daily 
# VARIABLE: neurocog_day_max <num> [dichot_dat] max of daily 

dichot_dat <- data_kq(dichot_dat, kq4_refid) |>
  mutate(
    delirium_inc_prop = !is.na(delitotal_n), 
    delirium_day_max = pmax(delirium_n1, delirium_n2, delirium_n3, delilast_n, na.rm = TRUE),
    delitotal_n = ifelse(is.na(delitotal_n), delirium_day_max, delitotal_n),
  ) |> 
  relocate(delirium_day_max, .after = delitotal_n) |> 
  left_join(study_arm_dat |> select(refid, arm_id, arm), by = c("refid", "arm_id")) |> 
  relocate(arm, .after = arm_id)
  
# rob_dat <- data_kq(rob_dat, kq4_refid) 
```

## Balance Tables

<font size = 4> Benefits, harms, and strength of evidence (GRADE) for TIVA versus inhaled anesthesia. </font>

```{r reg_gen_balance}
kq4_balance_main() |> 
  text_replace("See Appendix", "See below", locations = cells_body()) 
  # text_replace("See Appendix", "See Appendix", locations = cells_body())
```

<font size = 4> Included complications and strength of evidence (GRADE) for TIVA versus inhaled anesthesia. </font>

```{r reg_gen_complications}
kq4_complications()
```

## Outcome Importance

<font size = 4> `r table_ref()` Rankings of the 5 most important outcomes (11 respondents). </font>

```{r outcome_priority}
#| include: true
#| eval: true
outcome_dat <- rankings("KQ4")
outcome_tab(outcome_dat, 11)
```

## Outcomes Reported

<font size = 4> `r table_ref()` Dichotomous or count outcomes. </font>

```{r dichot_outcome_freq}
# CODE: reporting frequency tabulation
dichot_freq_fun(dichot_dat, "ADL: activities of daily living; NCR: neurocognitive recovery; POCD: postoperative neurocognitive disorder; QoR: quality of recovery; ")
```

<font size = 4> `r table_ref()` Continuous outcomes. </font>

```{r cont_outcome_freq}
contin_freq_fun(contin_dat)
```

<font size = 4> `r table_ref()` Likert or ordinal outcomes. </font>

```{r likert_outcome_freq}
likert_freq_fun(likert_dat, "ADL: activities of daily living; NCR: neurocognitive recovery; POCD: postoperative neurocognitive disorder; QoR: quality of recovery; ")
```

## **Included Studies**

<font size = 4> `r table_ref()` Number of studies by design. </font>

```{r studies_design}
# CODE: study design table — design and number; no duplicate studies for kq4
study_char_dat |>
  arrange(year) |> 
  group_by(linked_references_all_refid) |> # count 1 for multiple pubs from single study
  slice(1) |> 
  ungroup() |> 
  # select(refid, study, linked_references_all_refid, design_f_lab) |> # to check studies > 1 report
  select(refid, study, design_f_lab) |>
  group_by(design_f_lab, .drop = TRUE) |>
  summarise(total = n()) |>
  adorn_totals("row") |>
  gt(id = "one") |>
  cols_label(design_f_lab = "Design", total = "Studies") |>
  cols_width(
    # design_f_lab ~ px(200),
    design_f_lab ~ "1.8in",
    total ~ ".5in"
  ) |>
  gt_theme_mg() |> 
  tab_style(
    style = list(
      cell_fill(color = "#E4F3FE"),
      cell_text(weight = "bold"),
      cell_borders(sides = c("top", "bottom"), color = "#9A9EA1", style = "solid", weight = px(1.3))
    ),
    locations = cells_body(
      rows = design_f_lab == "Total"
    )
  ) |> 
  tab_style(
    style = list(
      cell_text(align = "left")),
      locations = cells_body(
        columns = design_f_lab
      )
    ) 
  # tab_footnote("Studies with multiple publications counted only once (applied to 1 trial with 2 publications).")
```

### Design, centers, country, and surgery

<font size = 4> `r table_ref()` Study design, enrollment, centers, country, and surgery (see [References](#references) for citations). </font>

```{r included_studies_table}
#| echo: false
included_dat <- study_char_dat |>
  mutate(study_l = study_l_w_linked) |>
  select(refid, starts_with("design"), study_l, year, n_enroll, n_analyze, centers, country, non_vh_hdi) |>
  left_join(surgs |> select(refid, surgs), by = "refid") |>
  mutate(
    design_f_lab = as.character(design_f_lab),
    # surgs = factor(surgs, levels = c("GI/Abdominal", "Cardiac", "Ortho", "Ent", "Ophtho", "Thoracic", "GI/Abdominal|Ortho|Ent", "General|Spine|Thoracic|Urol", "General|Thoracic|Urol", "Headneck", "Spine", "Urol", "Vasc", "Various"))
  ) |>
  arrange(design_f, surgs, study_l) |>
  select(refid, design_f_lab, study_l, centers, n_enroll, country, surgs, non_vh_hdi)

included_dat |>
  group_by(design_f_lab) |> 
  gt(id = "one") |>
  cols_label(
    refid = "ID",
    study_l = "Study",
    n_enroll = "Enrolled",
    country = "Country",
    centers = "Centers",
    surgs = "Surgery"
   ) |>
  cols_hide(c(non_vh_hdi, design_f_lab)) |>
    fmt_markdown(columns = c(study_l)) |> 
  cols_width(
    refid ~ px(60),
    study_l ~ px(165),
    centers ~ px(60),
    n_enroll ~ px(60),
    country ~ px(100),
    surgs ~ px(150)
  ) |> 
  # opt_horizontal_padding(scale = 2) |>
  # row_group_order(groups = c("GI/Abdominal", "Cardiac", "Ortho", "Ent", "Ophtho", "Thoracic", "GI/Abdominal|Ortho|Ent", "General|Spine|Thoracic|Urol", "General|Thoracic|Urol", "Headneck", "Spine", "Urol", "Various")) |>
  sub_missing(columns = everything(), missing_text = " — ") |>
  gt_theme_mg() |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c("refid"))) |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(surgs))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(surgs))) |>
  opt_footnote_marks(marks = "letters") |> 
  tab_footnote(footnote = md("Described as various or more than 4 different types of surgery."), locations = cells_body(columns = surgs, surgs == "Various")) |>
  tab_footnote(footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."), 
               locations = cells_column_labels(columns = country)) |>
  tab_footnote(footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."), 
               locations = cells_body(columns = country, rows = !is.na(non_vh_hdi))) |>
  # tab_footnote(footnote = "Studies examining drugs not directly relevant to recommendations but potentially relevant to the evidence space (eg, a connected network) were included.",  locations = cells_row_groups(groups = )) |> 
  tab_footnote("GI: gastrointestinal; Ortho: orthopedic; Ent: ear, nose, and throat; Neuro: neurological; Oralmax: oral maxillofacial; Vasc: vascular.")

```

### Country Summary

<font size = 4> `r table_ref()` Summary of studies by country where conducted. </font>

```{r country}
study_char_dat |>
  mutate(linked_references = ifelse(is.na(linked_references), refid, linked_references)) |> 
  slice(1, .by = linked_references) |>
  select(country) |>
  tbl_summary(
    sort = everything() ~ "frequency",
    label = list(country ~ "Country")
  ) |>
  modify_header(label ~ "") |> 
  as_gt(id = "one") |> 
  gt_theme_mg()

```

## **Comparators**

```{r tiva_inh_tab}
tiva_inh_tab <- study_arm_dat |>
  select(refid, refid_c, arm_id, study, design_f_lab, year, arm_n, arm, asa_ps_incl, kq4_desflurane, kq4_halothane, kq4_isoflurane, kq4_sevoflurane, kq4_inhale_other, kq4_fentanyl, kq4_propofol, kq4_remifent, kq4_sufentanil, kq4_thiopentone, kq4_tiva_other, kq4_control_desc) |>
  left_join(study_char_dat |> select(refid, study_l, surg_ortho_tka, surg_ortho_tha, surg_ortho_hipfx, surg_ortho_other, surg_list, surgs, surgs_noabbr_f), by = "refid") |>
  left_join(ortho_proc |> select(refid, ortho), by = c("refid")) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |>
  left_join(table_mn_med |> select(refid, arm_id, pre_mmse), by = c("refid", "arm_id")) |>
  rename_with(~ str_replace(.x, "kq4_", "")) |>
  mutate(
    across(desflurane:inhale_other, ~ notna_to_x(.x, symbol = "\U2713")),
    across(fentanyl:tiva_other, ~ notna_to_x(.x, symbol = "\U25CF")),
    remifent = ifelse(str_detect(control_desc, "remifent") & arm == "Inhaled", "\U25CB", remifent),
    propofol = ifelse(str_detect(control_desc, "propofol") & arm == "Inhaled", "\U25CB", propofol),
    fentanyl = ifelse(str_detect(control_desc, "fentanyl") & arm == "Inhaled", "\U25CB", fentanyl),
    sufentanil = ifelse(str_detect(control_desc, "sufentanil") & arm == "Inhaled", "\U25CB", sufentanil),
    remifentanil = ifelse(str_detect(control_desc, "remifentanil") & arm == "Inhaled", "\U25CB", sufentanil),
    thiopentone = ifelse(str_detect(control_desc, "thiopentone") & arm == "Inhaled", "\U25CB", thiopentone),
    surgs = str_replace(surgs, "Ent", "ENT"),
    surgs_design = paste0(surgs, " - ", design_f_lab) 
    # surgs = str_replace(surgs, " Other", ""),
    # surgs = str_replace(surgs, "Ortho ", "Ortho — "),
    # surgs = str_replace(surgs, "\\s{1}$", "")
  ) |>
  select(refid, surgs_design, arm_id, study, study_l, arm_n, arm, asa_ps_incl, age_table, pre_mmse, surgs, surgs_noabbr_f, year, ortho, desflurane:tiva_other) |>
  arrange(surgs, year, study, arm) 
```

#### Randomized

<font size = 4> `r table_ref()` Selected characteristics of randomized clinical trials comparing TIVA with inhaled maintenance anesthesia. </font>

```{r tiva_inh_rct_gt}
#| eval: true
tiva_inh_tab |>
  # randomized or nrsi
  filter(str_detect(surgs_design, "Random")) |> 
  remove_empty(which = "cols") |> 
  # tabyl(surgs_noabbr_f) |> arrange(desc(percent)) |> pull(surgs_noabbr_f) |> toString()
  # filter(!str_detect(surgs_design, "Random"))
  mutate(study_l = ifelse(row_number() > 1, "", study_l), .by = study) |>
  mutate(arm_n = ifelse(refid == 221, "NR", arm_n)) |> 
  group_by(surgs_noabbr_f) |>
  gt(id = "one") |>
  row_group_order(groups =  c("Gastrointestinal/Abdominal", "Various", "Thoracic", "Ophthalmologic", "Otolaryngological", "Orthopedic", "Cardiac", "Urologic", "Head & Neck", "Vascular", "Spine")) |>
  cols_hide(c(refid, arm_id, study, year, ortho, surgs_design, surgs)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = "N ",
    arm              = "Comparator",
    asa_ps_incl      = "PS",
    age_table        = "    Age",
    pre_mmse         = "MMSE",
    desflurane       = "Des",
    # halothane        = "Hal",
    isoflurane       = "Iso",
    sevoflurane      = "Sev",
    inhale_other     = "Oth",
    fentanyl         = "Fen",
    propofol         = "Pro",
    remifent         = "Rem",
    tiva_other       = "Oth"
  ) |>
  tab_spanner(label = "Inhaled", columns = c(desflurane:inhale_other), level = 1) |>
  tab_spanner(label = "ASA", columns = c(asa_ps_incl), level = 1) |>
  tab_spanner(label = "TIVA", columns = c(fentanyl:tiva_other), level = 1) |>
  fmt_markdown(columns = c(study_l, age_table, pre_mmse)) |>
  # fmt_number(VARIABLE, decimals = 0) |>
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(45),
    arm ~ px(80),
    asa_ps_incl ~ px(60),
    age_table ~ px(100),
    pre_mmse ~ px(100),
    desflurane ~ px(40),
    isoflurane ~ px(40),
    sevoflurane ~ px(40),
    inhale_other ~ px(40),
    fentanyl ~ px(45),
    propofol ~ px(40),
    remifent ~ px(40),
    tiva_other ~ px(40)
  ) |> 
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(arm_n:tiva_other), rows = str_detect(arm, "TIVA"))) |> 
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(asa_ps_incl))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(desflurane:tiva_other))) |> 
  tab_footnote(md("TIVA: total intravenous anesthesia; NR: not reported; ASA PS: ASA Physical Status; MMSE: Mini-Mental State Exam; Des: desflurane; Hal: halothane; Iso: isoflurane; Sev: sevoflurane; Fen: fentanyl; Pro: propofol; Rem: remifentanil; Oth: other.")) |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table, pre_mmse))) |> 
  tab_footnote("Thimylal", locations = cells_body(columns = tiva_other, rows = study == "Nishikawa 2007a" & arm_id == 2)) |> 
  tab_footnote("Induction with sevoflurane; either inhalant used.", locations = cells_body(columns = c(isoflurane, sevoflurane), rows = study == "Forsmo 2016" & arm_id == 1)) |> 
  tab_footnote("Diazepam.", locations = cells_body(columns = arm, rows = study == "Salonia 2006" & arm_id == 2)) |>
  tab_footnote("Induction with sevoflurane.", locations = cells_body(columns = sevoflurane, rows = study == "Luntz 2004" & arm_id == 1)) |> 
  tab_footnote("Induction with sevoflurane.", locations = cells_body(columns = sevoflurane, rows = study == "Goins 2018" & arm_id == 1)) 
```

#### Nonrandomized

<font size = 4> `r table_ref()` Selected characteristics of nonrandomized studies comparing TIVA with inhaled maintenance anesthesia. </font> 

```{r tiva_inh_nrsi_gt}
#| eval: true
tiva_inh_tab |>
  # randomized or nrsi
  filter(!str_detect(surgs_design, "Random")) |> 
  # remove_empty(which = "cols") |> 
  # tabyl(surgs_design) |> arrange(desc(percent)) |> pull(surgs_design) |> toString()
  mutate(study_l = ifelse(row_number() > 1, "", study_l), .by = study) |>
  mutate(arm_n = ifelse(refid == 221, "NR", arm_n)) |> 
  group_by(surgs_design) |>
  gt(id = "one") |>
  row_group_order(groups =  c("Cardiac - Retrospective Cohort", "Various - Retrospective Cohort", "GI/Abdominal - Retrospective Cohort", "General|Spine|Thoracic|Urol - Prospective Cohort", "General|Thoracic|Urol - Prospective Cohort", "Ortho - Prospective Cohort", "Ortho - Retrospective Cohort", "Thoracic - Retrospective Cohort")) |>
  cols_hide(c(refid, arm_id, study, year, ortho, surgs, surgs_noabbr_f, inhale_other, halothane, tiva_other, thiopentone)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = "N ",
    arm              = "Comparator",
    asa_ps_incl      = "PS",
    age_table        = "    Age",
    pre_mmse         = "MMSE",
    desflurane       = "Des",
    isoflurane       = "Iso",
    sevoflurane      = "Sev",
    fentanyl         = "Fen",
    propofol         = "Pro",
    remifent         = "Rem",
    sufentanil       = "Suf"
  ) |>
  tab_spanner(label = "Inhaled", columns = c(desflurane:sevoflurane), level = 1) |>
  tab_spanner(label = "ASA", columns = c(asa_ps_incl), level = 1) |>
  tab_spanner(label = "TIVA", columns = c(fentanyl:sufentanil), level = 1) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",") |> 
  fmt_markdown(columns = c(study_l, age_table, pre_mmse)) |>
  # fmt_number(VARIABLE, decimals = 0) |>
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(65),
    arm ~ px(80),
    asa_ps_incl ~ px(60),
    age_table ~ px(100),
    pre_mmse ~ px(100),
    desflurane ~ px(40),
    isoflurane ~ px(40),
    sevoflurane ~ px(40),
    fentanyl ~ px(45),
    propofol ~ px(40),
    remifent ~ px(40),
    sufentanil ~ px(40)
  ) |> 
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(arm_n:sufentanil), rows = str_detect(arm, "TIVA"))) |> 
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(asa_ps_incl))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(desflurane:sevoflurane))) |> 
  tab_footnote(md("TIVA: total intravenous anesthesia; NR: not reported; ASA PS: ASA Physical Status; MMSE: Mini-Mental State Exam; Des: desflurane; Iso: isoflurane; Sev: sevoflurane; Fen: fentanyl; Pro: propofol; Rem: remifentanil; Suf: sufentanil.")) |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table, pre_mmse))) |> 
  tab_footnote("Either of the two inhalent agents used.", locations = cells_body(columns = c(desflurane, sevoflurane), rows = study %in% c("Koo 2016", "Cho 2021", "Goins 2018") & arm_id == 1)) |> 
  # tab_footnote("As needed.", locations = cells_body(columns = c(remifent), rows = study == "Cho 2021" & arm_id == 1)) 
  tab_footnote("Any agent used.", locations = cells_body(columns = c(desflurane, sevoflurane, isoflurane) , rows = study == "Yoshimura 2022" & arm_id == 1)) |> 
  tab_footnote("Agent used not specified.", locations = cells_body(columns = c(desflurane, sevoflurane, isoflurane) , rows = study == "Park 2020" & arm_id == 1))

```

## **Delirium Incidence**

```{r delirium_meta_dat}
delirium_meta_dat <- dichot_dat |>
  mutate(arm_n = ifelse(!is.na(deli_update_arm_n), deli_update_arm_n, arm_n)) |> # 2023-05-12 none to be updated
  filter(!is.na(delitotal_est) | !is.na(delilast_est) | !is.na(delirium_disch_est) | !is.na(delitotal_n)) |>
  left_join(study_char_dat |> select(refid, country), by = "refid") |>
  left_join(surgs |> select(refid, surgs_single_f), by = c("refid")) |>
  rename(surg_f = surgs_single_f) |>
  select(refid, refid_c, arm_id, arm_n, year, study, study_l, design_f_lab, country, surg_f, arm, delitotal_time:delitotal_95high, deli_cam:deli_scale_otherspec, deli_update_arm_n, delirium_inc_prop) |>
  arrange(design_f_lab, refid_c, arm_id)

delirium_rr_ref <- delirium_meta_dat |>
   select(refid, refid_c, arm_id, delitotal_n, arm_n) |>
   arrange(refid_c, arm_id) |>
   rename(ref_deli_n = delitotal_n, ref_arm_n = arm_n) |>
   group_by(refid_c) |>
   mutate(
     ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
     ref_deli_n = ifelse(row_number() > 1, NA, ref_deli_n)
   ) |>
   fill(ref_arm_n, ref_deli_n) |>
   mutate(
     ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
     ref_deli_n = ifelse(row_number() == 1, NA, ref_deli_n)
   ) |>
   select(-refid)

delirium_meta_dat <- delirium_meta_dat |>
  remove_empty(which = "cols") |>
  mutate(
    across(starts_with("deli_"), ~ str_remove_all(.x, "scale_")),
    across(starts_with("deli_"), ~ str_remove_all(.x, "deli_")),
    across(deli_cam:deli_scale_otherspec, ~ toupper(.x)),
  ) |>
  rename_with(~ gsub("scale_", "", .x, fixed = TRUE)) |>
  rename_with(~ gsub("deli_", "", .x, fixed = TRUE)) |>
  left_join(delirium_rr_ref, by = c("refid_c", "arm_id")) |>
  mutate(
    other = ifelse(str_detect(otherspec, "ICD"), "ICD codes", other),
    calc_percent = delitotal_n / arm_n * 100,
    n_percent = n_per_fun(delitotal_n, arm_n, 1),
    rr_ci = ifelse(!is.na(ref_arm_n), rr_ci_fun(delitotal_n, arm_n, ref_deli_n, ref_arm_n), "—"),
    or_ci = ifelse(!is.na(ref_arm_n), or_ci_fun(delitotal_n, arm_n, ref_deli_n, ref_arm_n), "—"),
    ln_or = ifelse(!is.na(ref_arm_n), or_ln_te_fun(delitotal_n, arm_n, ref_deli_n, ref_arm_n), NA),
    ln_se_or = ifelse(!is.na(ref_arm_n), or_ln_se_fun(delitotal_n, arm_n, ref_deli_n, ref_arm_n), NA),
    # if reported adjusted or use
    or_ci = ifelse(!is.na(delitotal_est), format_est_ci_fun(delitotal_est, delitotal_95low, delitotal_95high), or_ci),
    ln_or = ifelse(!is.na(delitotal_est), log(delitotal_est), ln_or),
    ln_se_or = ifelse(!is.na(delitotal_est), se_ln_ci_fun(delitotal_95low, delitotal_95high), ln_se_or),
  ) |>
  relocate(calc_percent, .after = delitotal_perc) |>
  unite(compare_groups, c(surg_f, design_f_lab), sep = " – ", remove = FALSE) |> 
  unite(scale_delirium, cam:other, remove = TRUE, sep = "/", na.rm = TRUE) |>
  mutate(
    scale_delirium = ifelse(scale_delirium == "UNSPEC", "NS", scale_delirium),
    effect = ifelse(!str_detect(design_f_lab, "Rand") & arm_id == 2, paste0("<u>", or_ci, "</u>"), rr_ci)) |> 
  left_join(table_mn_med |> select(refid, arm_id, pre_mmse), by = c("refid", "arm_id")) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |>
  relocate(pre_mmse, .before = scale_delirium) |>
  relocate(age_table, .after = arm_n) |>
  select(year, refid, refid_c, design_f_lab, compare_groups, study, study_l, arm_id, arm_n, arm, age_table, pre_mmse, scale_delirium, delitotal_time, delirium_inc_prop, n_percent, delitotal_n, calc_percent, effect, rr_ci, or_ci, ln_or, ln_se_or)

```

<font size = 4> `r table_ref()` Delirium incidence and days of ascertainment during hospitalization in randomized clinical trials comparing TIVA with inhaled anesthetics. </font>

```{r delirium_gt}
# no use of daily max est
delirium_meta_dat |>
  # tabyl(compare_groups) |> pull(compare_groups) |> toString()
  arrange(year, study, arm_id) |>
  mutate(
    delitotal_time = ifelse(delitotal_time == 999, "Stay", as.character(delitotal_time)),
    study_l = ifelse(row_number() > 1, "", study_l),
    delitotal_time = ifelse(row_number() > 1, "", delitotal_time),
    scale_delirium = ifelse(row_number() > 1, "", scale_delirium),
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(calc_percent, "#A93226"),
      .default = bar_prop(calc_percent, "#969696")
    ),
    .by = study_l
  ) |>
  group_by(compare_groups) |>
  gt(id = "one") |>
  row_group_order(groups = c("GI/Abd – Randomized Clinical Trial", "Ortho – Randomized Clinical Trial", "Various – Randomized Clinical Trial", "Cardiac – Retrospective Cohort", "Various – Prospective Cohort", "Various – Retrospective Cohort")) |>
  cols_hide(c(year, refid, refid_c, design_f_lab, arm_id, study, design_f_lab, age_table, pre_mmse, calc_percent, rr_ci:ln_se_or, delirium_inc_prop, delitotal_n)) |>
  cols_label(
    study_l = "Study",
    arm_n = " N",
    # age_table = "  Age",
    arm = "Arm",
    # pre_mmse = md("  MMSE<br/>  (preop)"),
    scale_delirium = "Scale",
    delitotal_time = "Day(s)",
    n_percent = "N (%)",
    bar = "0 – 100%",
    effect = md("RR <u>OR</U> (95% CI)")
  ) |>
  tab_spanner(label = "Incidence Proportion", columns = c(n_percent, bar)) |>
  fmt_markdown(columns = c(study_l, bar, effect)) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",") |> 
  sub_values(columns = effect, rows = study %in% c("Nishikawa 2004", "Tanaka 2017"), pattern = ".*", replacement = "") |> # 0 events in an arm 
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(70),
    # age_table ~ px(100),
    arm ~ px(70),
    # pre_mmse ~ px(95),
    scale_delirium ~ px(105),
    delitotal_time ~ px(55),
    n_percent ~ px(90),
    bar ~ px(100),
    effect ~ px(140)
  ) |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(study, arm, scale_delirium))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(arm_n, delitotal_time, effect))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_column_labels(columns = c(n_percent, effect))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_body(columns = c(n_percent))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(arm, scale_delirium, bar))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(delitotal_time, effect))) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n:n_percent), rows = str_detect(arm, "TIVA"))) |>
  tab_footnote("RR: risk ratio; OR: odds ratio; DRS: Delirium Rating Scale; CAM: Confusion Assessment Method; NS: not specified.") |>
  # tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table, pre_mmse))) |>
  tab_footnote("Day(s) over which incidence proportion assessed. Stay indicates duration of hospitalization.", locations = cells_column_labels(columns = delitotal_time)) |> 
  tab_footnote("Adjusted from multivariable model.", locations = cells_body(columns = effect, rows = study ==  "Goins 2018" & arm_id == 2)) |> 
  tab_footnote("Propensity score matched.", locations = cells_body(columns = effect, rows = study == "Yoshimura 2022" & arm_id == 2)) 

```

### *Pooled*

#### Randomized

<font size = 4> `r figure_ref()` Delirium incidence (TIVA versus inhaled anesthesia; randomized clinical trials). </font> 

```{r delirium_meta_rct_nrsi_dat}
delirium_all_meta_dat <- delirium_meta_dat |> 
  rename(n = delitotal_n) |> 
  select(refid, year, study, design_f_lab, arm, n, arm_n) 

pairs_dat <- pairwise(
  treat = arm,
  event = n,
  n = arm_n,
  studlab = study,
  data = delirium_all_meta_dat,
  sm = "RR",
  keep.all.comparisons = TRUE
)

pairwise_dat <- pairs_dat |>
  select(refid, studlab, treat1, treat2, event1, n1, event2, n2, year, design_f_lab, year) |>
  mutate(
    treat2 = "TIVA",
    treat1 = "Inhaled"
  ) |>
  rename(study = studlab)

delirium_rct_meta_dat <- pairwise_dat |> 
  filter(str_detect(design_f_lab, "Rand")) |>
  left_join(rob2_meta_dat, by = "refid") |> 
  select(-design_f_lab) |> 
  arrange(year, study)

# cao_2023 <- tribble(
#   ~refid , ~study , ~treat1, ~treat2, ~event1, ~n1, ~event2, ~n2, ~year, ~D1, ~D2, ~D3, ~D4, ~D5, ~Overall,
#   99999, "Cao 2023", "Inhaled", "TIVA", 74, 597, 50, 598, 2023, NA, NA, NA, NA, NA, NA
# )
# 
# delirium_rct_meta_dat <-  delirium_rct_meta_dat |> 
#   bind_rows(cao_2023)

delirium_nsri_meta_dat <- pairwise_dat |> 
  filter(!str_detect(design_f_lab, "Rand")) |> 
  left_join(delirium_meta_dat |> slice(2, .by = refid) |> select(refid, ln_or, ln_se_or), by = "refid") |> 
  left_join(robinsi_meta_dat, by = "refid") |> 
  select(-design_f_lab) |> 
  arrange(year, study)

rm(delirium_all_meta_dat)

delirium_meta_rct <- metabin(event2, n2, event1, n1,
  data = delirium_rct_meta_dat,
  studlab = study,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  hakn = FALSE,
  prediction = TRUE,
  allstudies = TRUE,
  # subset = study %in% c("Cao 2023", "Dai 2021")
)

delirium_meta_rct_rd <- update(delirium_meta_rct, sm = "RD")

```

```{r delirium_meta_rct}
#| include: false

png("assets/kq4_delirium_meta_rct.png", width = 9.72, height = 3.6, units = "in", res = 300)
forest(delirium_meta_rct,
  allstudies = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "Overall"),
  rightlabs = c("RR", "(95% CI)", "D1", "D2", "D3", "D4", "D5", "All"),
  just.addcols.right = "right",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  # xlim = c(0.05, 20),
  xlab = "Favors: TIVA                             Inhaled",
  addrows.below.overall = 4,
  fs.hetstat = 10
)
dev.off()

```
![](assets/kq4_delirium_meta_rct.png){fig.align="left" width="71%"}

<foot_mg> RR: risk ratio; D1: bias arising from the randomization process; D2: bias due to deviations from intended interventions; D3: bias due to missing outcome data; D4: bias in measurement of the outcome; D5: bias in selection of the reported result: All: overall risk of bias.<br/> Risk of bias ratings: low +, some concerns ?, high -- . <br/> Hartung-Knapp adjustment not applied. Continuity correction of 0.5 added to studies arms with no events. Too few studies to examine small study effects. </foot_mg><br/>

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delirium incidence (TIVA versus inhaled anesthesia; randomized clinical trials; risk difference per 100). </caption_mg> <a id="kq4_delirium_risk-diff"></a>

```{r kq4_delirium_meta_forest_rd}
#| echo: false
#| include: false
png("assets/kq4_delirium_meta_forest_rd.png", width = 9.72, height = 3.6, units = "in", res = 300)
forest(delirium_meta_rct_rd,
  allstudies = TRUE,
  common = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "Overall"),
  rightlabs = c("RD", "(95% CI)", "D1", "D2", "D3", "D4", "D5", "All"),
  just.addcols.right = "right",
  digits = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  # sortvar = year,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  xlim = c(-20, 20),
  pscal = 100,
  xlab = "Favors: TIVA                          Inhaled",
  addrows.below.overall = 4,
  fs.test.subgroup = 10,
  fs.hetstat = 10
)
dev.off()
```
![](assets/kq4_delirium_meta_forest_rd.png){fig.align="left" width="75%"}
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delirium incidence (TIVA versus inhaled anesthesia; small study effects). </caption_mg>

```{r kq4_delirium_funnel_limit} 
#| echo: false
#| include: false

delirium_meta_or <- update(delirium_meta_rct, sm = "OR")

png("assets/kq4_delirium_or_funnel.png", width = 8.5, height = 5.5, units = "in", res = 300)
par(mar = c(4, 4, 2, 1))
limit_colors <- c("#AAB7B8", "#D5DBDB", "#F4F6F6")
# text(1.2, 0.05, labels = "Adjusted estimate", col = "darkgray", pos = 3, cex = .9)
par(bty = "n", xaxt = "s", yaxt = "s")
funnel(delirium_meta_or,  pch = 20, contour = c(0.9, 0.95, 0.99), col.contour = limit_colors, studlab = TRUE, pos.studlab = 4, fs.smlab = 6, ff.smlab = "italic")
legend(0.1, 0.02, c("0.1 > p > 0.05", "0.05 > p > 0.01", "< 0.01"), fill = c("#AAB7B8", "#D5DBDB", "#F4F6F6"), bty = "n")
dev.off()

```

![](assets/kq4_delirium_funnel.png){width="75%"}
:::

<a id="delirium_meta_rct_nrsi"></a>

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delirium incidence summary risk of bias from randomized clinical trials comparing TIVA to inhaled anesthesia (weighted). </caption_mg>

```{r rob2_summary_delirium, fig.height = 3, out.width = "60%"}
rob_summary_meta_weighted_fun(delirium_meta_rct)
# rob_summary_fun(delirium_meta_dat$refid)
```
:::

#### Nonrandomized 

<caption_mg> `r figure_ref()` Delirium incidence (TIVA verus anesthetic; nonrandomized designs). </caption_mg> 

```{r delirium_meta_nrsi}
delirium_meta_nrsi <- metagen(ln_or, ln_se_or,
  data = delirium_nsri_meta_dat,
  sm = "OR",
  backtransf = TRUE
)
```

```{r delirium_meta_nrsi_forest}
#| echo: false
#| include: false

png("assets/kq4_delirium_meta_nrsi.png", width = 10.53, height = 2.8, units = "in", res = 300)
forest(delirium_meta_nrsi,
  allstudies = TRUE,
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "Overall"),
  rightlabs = c("OR", "(95% CI)  ", "D1", "D2", "D3", "D4", "D5", "D6", "D7", "All"),
  leftcols = c("study", "event2", "n2", "event1", "n1"), 
  leftlabs = c("Study", "Events", "TIVA    \n Total", "Events", "Inhaled\n Total"),
  just.addcols.right = "center",
  just.addcols.left = "right",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = FALSE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  big.mark = ",",
  print.pval.Q = FALSE,
  xlim = c(0.1, 2),
  xlab = "Favors: TIVA                             Inhaled",
  addrows.below.overall = 4,
  fs.hetstat = 10,
)
dev.off()

```
![](assets/kq4_delirium_meta_nrsi.png){fig.align="left" width="75%"}

<foot_mg> D1: Bias due to confounding; D2: Bias in selection of participants into the study; D3: Bias in classification of interventions; D4: Bias due to deviations from intended interventions; D5: Bias due to missing data; D6: Bias in measurement of outcomes; D7: Bias in selection of reported results; All: overall risk of bias.<br/> Risk of bias ratings: low ++, moderate +, serious -, critical - - ; NI: no information; NA: not applicable. <br/> Note: pooling of adjusted odds ratios from Yoshimura 2022 (propensity matching) and Goins 2018 (multivariable adjustment). </foot_mg>

## **Delayed Neurocognitive Recovery**

```{r dncr_ncd_dat}
#| eval: true
# CODE: neurocog meta data munge; here to produce figure
# VARIABLE: postop_only <lgl> from study arm only post-op administration [postop_only_dat]

## dncr_dat ------------------------------------------- (2023-04-15 15:55) @----
dncr_dat <- dichot_dat |>
  filter(if_any(c(neurocog_n1, neurocog_n2, neurocog_n3, neurocog_last_n, neurocog_total_n), ~ !is.na(.x))) |>
  # > 30 day exam
  filter(if_any(matches("neurocog.*time.*"), ~ .x <= 30)) |>
  # select(refid, study, arm_n, neurocog_update_arm_n, neurocog_n1, neurocog_n2, neurocog_n3, neurocog_last_n, neurocog_total_n, matches("neurocog.*time")) |>
  mutate(
    arm_n = ifelse(!is.na(neurocog_update_arm_n), neurocog_update_arm_n, arm_n),
    neurocog_n1 = ifelse(neurocog_time1 > 30, NA, neurocog_n1),
    neurocog_n2 = ifelse(neurocog_time2 > 30, NA, neurocog_n2),
    neurocog_n3 = ifelse(neurocog_time3 > 30, NA, neurocog_n3),
    neurocog_last_n = ifelse(neurocog_last_time > 30, NA, neurocog_last_n),
    neurocog_total_n = ifelse(neurocog_total_time > 30, NA, neurocog_total_n),
    neurocog_time1 = ifelse(neurocog_time1 > 30, NA, neurocog_time1),
    neurocog_time2 = ifelse(neurocog_time2 > 30, NA, neurocog_time2),
    neurocog_time3 = ifelse(neurocog_time3 > 30, NA, neurocog_time3),
    neurocog_last_time = ifelse(neurocog_last_time > 30, NA, neurocog_last_time),
    neurocog_total_time = ifelse(neurocog_total_time > 30, NA, neurocog_total_time),
    dncr_time = pmax(neurocog_time1, neurocog_time2, neurocog_time3, neurocog_last_time, neurocog_total_time, na.rm = TRUE),
    neurocog_total_n = case_when(
      neurocog_time1 == dncr_time ~ neurocog_n1,
      neurocog_time2 == dncr_time ~ neurocog_n2,
      neurocog_time3 == dncr_time ~ neurocog_n3,
      neurocog_last_time == dncr_time ~ neurocog_last_n,
      neurocog_total_time == dncr_time ~ neurocog_total_n
    ),
    neurocog_prop = neurocog_total_n/arm_n,
    neurocog_nper = n_per_fun(neurocog_total_n, arm_n, 1)
  ) |>
  left_join(study_char_dat |> select(refid, country, neuro_threshold), by = "refid") |>
  left_join(surgs |> select(refid, surgs_single_f, surgs_noabbr_f), by = c("refid")) |>
  left_join(table_mn_med |> select(refid, arm_id, pre_mmse), by = c("refid", "arm_id")) |>
  rename(surg_f = surgs_single_f) |>
  arrange(refid_c, arm_id) |>
  mutate(
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(neurocog_prop * 100, "#A93226"),
      .default = bar_prop(neurocog_prop * 100, "#969696")),
    year = as.numeric(str_extract(study, "\\d{4}")),
    # arm = fct_collapse(arm, "Plac/None" = c("Plac", "None")),
    across(c(arm, design_f_lab, surg_f), ~ fct_drop(.x)),
    scale_mmse = ifelse(!is.na(neurocog_mmse), "\U2713", NA),
    scale_dst = ifelse(!is.na(neurocog_dst) | str_detect(neurocog_scale_otherspec, "[Dd]igit"), "\U2713", NA),
    scale_moca = ifelse(!is.na(neurocog_scale_moca), "\U2713", NA),
    scale_other = neurocog_scale_otherspec,
    scale_other = str_to_title(str_replace(scale_other, "Digit [Ss]ymbol [Tt]est; |Digit symbol substitution test; |Montreal Cognitive Assessment \\(MoCA\\)|MoCA", "")),
    scale_other = ifelse(scale_other == "", NA, scale_other),
    scale_other = str_replace_all(scale_other, "Pocd", "POCD"),
    neurocog_scale_other = ifelse(study == "Lindholm 2013", "neurocog_scale_other", neurocog_scale_other),
    scale_other_tf = ifelse(!is.na(neurocog_scale_other), "\U2713", NA)
  ) |> 
  select(refid, refid_c, year, arm_id, study, study_l, design_f_lab, pre_mmse, country, surg_f, surgs_noabbr_f, arm, pre_mmse, dncr_time, neurocog_total_n, arm_n, arm, neurocog_nper, neurocog_prop, bar, scale_mmse:scale_other_tf, neuro_threshold)

# add referents for rr calculation
dncr_rr_ref <- dncr_dat |>
  select(refid, refid_c, arm_id, neurocog_total_n, arm_n) |>
  arrange(refid_c, arm_id) |>
  rename(ref_neurocog_n = neurocog_total_n, ref_arm_n = arm_n) |>
  group_by(refid_c) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_neurocog_n = ifelse(row_number() > 1, NA, ref_neurocog_n)
  ) |>
  fill(ref_arm_n, ref_neurocog_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_neurocog_n = ifelse(row_number() == 1, NA, ref_neurocog_n)
  ) |>
  select(-refid)

#| DATA: neurocog_allarms_meta_dat for subsequent pooling, arms not collapsed
neurocog_allarms_meta_dat <- dncr_dat |> 
  select(refid, study, design_f_lab, year, arm_id, arm, neurocog_total_n, arm_n, dncr_time, surgs_noabbr_f) 

dncr_dat <- dncr_dat |> 
  left_join(dncr_rr_ref, by = c("refid_c", "arm_id")) |> 
  mutate(rr_ci = ifelse(!is.na(ref_arm_n), rr_ci_fun(neurocog_total_n, arm_n, ref_neurocog_n, ref_arm_n), "—")) |> 
  select(refid, year, design_f_lab, surg_f, surgs_noabbr_f, study, study_l, arm_id, arm_n, arm, pre_mmse, scale_mmse:scale_other_tf, neuro_threshold, dncr_time, neurocog_nper, bar, rr_ci)

rm(dncr_rr_ref)
```

<caption_mg> `r table_ref()` Delayed neurocognitive recovery incidence and ascertainment (TIVA versus inhaled; randomized and nonrandomized designs). </caption_mg>

```{r dncr_gt}
#| eval: true

# create footnotes for thresholds
# dncr_dat |>
#   select(refid, study, scale_mmse, scale_dst, scale_moca, neuro_threshold) |>
#   slice(1, .by = refid) |>
#   mutate(
#     neuro_threshold = str_replace(neuro_threshold, "≤-", "≥"),
#     footnotes = case_when(
#     !is.na(scale_mmse) ~ paste0("tab_footnote('", neuro_threshold, ".', locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == '", study, "')) |>"),
#     !is.na(scale_dst) ~ paste0("tab_footnote('", neuro_threshold, ".', locations = cells_body(columns = c(scale_dst), rows = arm_id == 1 & study == '", study, "')) |>"),
#     !is.na(scale_moca) ~ paste0("tab_footnote('", neuro_threshold, ".', locations = cells_body(columns = c(scale_moca), rows = arm_id == 1 & study == '", study, "')) |>")
#   ),
#   footnotes = ifelse(row_number() == n(), str_remove(footnotes, ".{2}$"), footnotes)) |>
#   filter(!is.na(footnotes)) |>
#   pull(footnotes) |>
#   noquote()

dncr_dat |>
  arrange(year, study) |>
  mutate(
    design_surg = paste0(as.character(design_f_lab), " — ", as.character(surgs_noabbr_f)),
    # design_surg = str_remove(design_surg, "Randomized Clinical Trial — ")
  ) |>
  # tabyl(design_surg) |> arrange(desc(percent)) |> pull(design_surg) |> toString()
  mutate(
    study_l = ifelse(row_number() > 1, NA, study_l),
    across(scale_mmse:scale_other_tf, ~ ifelse(row_number() > 1, NA, .x)),
    dncr_time = ifelse(row_number() > 1, NA, dncr_time),
    .by = study
  ) |>
  # tabyl(design_surg) |> arrange(desc(percent))
  group_by(design_surg) |>
  gt(id = "one") |>
  row_group_order(groups = c("Randomized Clinical Trial — Gastrointestinal/Abdominal", "Randomized Clinical Trial — Thoracic", "Randomized Clinical Trial — Otolaryngological", "Randomized Clinical Trial — Spine", "Randomized Clinical Trial — Various", "Randomized Clinical Trial — Vascular", "Prospective Cohort — Orthopedic")) |>
  cols_hide(c(refid, year, arm_id, study, scale_other, design_f_lab, surg_f, neuro_threshold, surgs_noabbr_f)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              = "Drug",
    pre_mmse         = "MMSE",
    scale_mmse       = "MMSE",
    scale_dst        = "DST",
    scale_moca       = "MoCA",
    scale_other_tf   = "Other",
    dncr_time        = "Day",
    neurocog_nper    = "N (%)",
    bar              = "0 — 100%",
    rr_ci            = "RR (95% CI)"
  ) |>
  gt_theme_mg() |>
  fmt_markdown(columns = c(study_l, bar, pre_mmse, scale_mmse:scale_other_tf)) |>
  fmt_number(dncr_time, decimals = 0) |>
  sub_missing(columns = everything(), missing_text = "") |>
  tab_spanner(label = "Instrument", columns = c(scale_mmse:scale_other_tf), level = 1) |>
  tab_spanner(label = "Delayed Neurocognitive Recovery", columns = c(neurocog_nper:rr_ci), level = 1) |>
  tab_spanner(label = "Preop", columns = c(pre_mmse), level = 1) |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(45),
    arm ~ px(70),
    pre_mmse ~ px(100),
    scale_mmse ~ px(50),
    scale_dst ~ px(50),
    scale_moca ~ px(50),
    scale_other_tf ~ px(50),
    dncr_time ~ px(60),
    neurocog_nper ~ px(90),
    bar ~ px(100),
    rr_ci ~ px(140),
  ) |>
  tab_style(style = cell_text(align = "left"), locations = cells_column_labels(columns = c(study, arm))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(starts_with("scale"), pre_mmse, dncr_time, neurocog_nper, rr_ci))) |>
  tab_style(style = cell_text(align = "right"), locations = cells_column_labels(columns = c(neurocog_nper))) |>
  tab_style(style = cell_text(align = "left"), locations = cells_body(columns = c(study, arm, pre_mmse))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(starts_with("scale"), dncr_time, rr_ci))) |>
  tab_style(style = cell_text(align = "right"), locations = cells_body(columns = c(neurocog_nper))) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n:pre_mmse, neurocog_nper), rows = str_detect(arm, "TIVA"))) |>
  tab_footnote("Mini-Mental State Exam; DST: Digit Span Test; MoCA: Montreal Cognitive Assessment; RR: risk ratio.") |>
  tab_footnote("Day of assessment.", locations = cells_column_labels(columns = c(dncr_time))) |>
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(pre_mmse))) |>
  tab_footnote("Included Digit Symbol Substitution Test; Cumulative Test; Trail Making Test; Rey Auditory Verbal Learning Test; Grooved Pegboard Test.", locations = cells_body(columns = c(scale_other_tf), rows = study == "Geng 2017" & arm_id == 1)) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Zhang 2018a")) |>
  tab_footnote("Difference from baseline >20%.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Egawa 2016")) |>
  tab_footnote("Difference from baseline >20%.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Geng 2017")) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Tang 2014")) |>
  tab_footnote("Difference from baseline >2 pts.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Qiao 2023")) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Li 2021a")) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Konishi 2018")) |>
  tab_footnote("Z ≥1.96.", locations = cells_body(columns = c(scale_mmse), rows = arm_id == 1 & study == "Rohan 2005")) |> 
  tab_footnote("Cognitive dysfunction without specified evaluation.", locations = cells_body(columns = c(scale_other_tf), rows = study == "Lindholm 2013" & arm_id == 1)) 

```

<a id="kq4_dncr_meta"></a> 

### *Pooled*

<caption_mg> `r figure_ref()` Delayed neurocognitive recovery assessed at postoperative day 5 or later (TIVA versus inhaled; randomized clinical trials).  </caption_mg>

```{r dncr_meta_dat}
#| eval: true
neurocog_meta_dat <- neurocog_allarms_meta_dat |>
  filter(dncr_time >= 3) |> # per Fritz
  # filter(dncr_time > 3) |> # per Fritz
  # collapse arms
  mutate(
    neurocog_total_n = case_when(
      study == "Geng 2017" & arm_id == 1 ~ collapse_dichot(neurocog_allarms_meta_dat, "Geng 2017", c(1, 2), neurocog_total_n),
      .default = neurocog_total_n
    ),
    arm_n = case_when(
      study == "Geng 2017" & arm_id == 1 ~ collapse_dichot(neurocog_allarms_meta_dat, "Geng 2017", c(1, 2), arm_n),
      .default = arm_n
    )
  ) |>
  filter(!(study %in% c("Geng 2017") & arm_id %in% c(2))) |>
  left_join(surgs |> select(refid, surgs_single_f), by = c("refid")) 

nma_dncr_dat <- neurocog_meta_dat |>
  mutate(time = ifelse(dncr_time < 3, "at <3 days", "at ≥3 days" )) |> 
  filter(time == "at ≥3 days") |> 
  # select(-dncr_time) |> 
  filter(design_f_lab == "Randomized Clinical Trial") 

pairs_dat <- pairwise(
  treat = arm,
  event = neurocog_total_n,
  n = arm_n,
  studlab = study,
  data = nma_dncr_dat,
  sm = "RR",
  keep.all.comparisons = TRUE
)

```

```{r dncr_meta}
#| eval: true
#| include: false
dncr_meta_dat <- pairs_dat |>
  arrange(year, study) |> 
  left_join(rob2_meta_dat, by = "refid") |>
  select(refid, study, year, event2, n2, event1, n1, D1:Overall, surgs_single_f, dncr_time) |>
  mutate(
    rob = case_when(
      Overall == "+" ~ "Low",
      Overall == "?" ~ "Some Concerns",
      Overall == "–" ~ "High"
    )
  ) |>
  left_join(study_char_dat |> select(refid, country), by = "refid") |> 
  arrange(dncr_time, study) |>
  mutate(dncr_time = paste0("At day ", dncr_time)) 

dncr_tiva_inhaled_meta <- metabin(event2, n2, event1, n1,
  data = dncr_meta_dat,
  studlab = study,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  subgroup = dncr_time,
  print.subgroup.name = FALSE,
  hakn = TRUE,
  prediction = TRUE,
  allstudies = TRUE,
  subset = study != "Geng 2017",
  # subgroup = country
  )

dncr_tiva_inhaled_meta_rct_rd <- update(dncr_tiva_inhaled_meta, sm = "RD", method = "Inverse", method.tau = "REML")

# summary(plac_meta)

png("assets/kq4_dncr_meta.png", width = 11.4, height = 5.25, units = "in", res = 300) 
forest(dncr_tiva_inhaled_meta,
  allstudies = TRUE,
  common = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "surgs_single_f", "D1", "D2", "D3", "D4", "D5", "Overall"),
  rightlabs = c("RR ", "(95% CI)   ", "Procedure", "D1", "D2", "D3", "D4", "D5", "All"),
  just.addcols.right = "left",
  digits = 2,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  subgroup = TRUE,
  # print.subgroup.labels = FALSE,
  test.subgroup.common = FALSE,
  test.subgroup.random = FALSE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  colgap.right = "5mm",
  fs.xlab = 11,
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  xlim = c(0.2, 2),
  xlab = "Favors: TIVA                    Inhaled",
  addrows.below.overall = 4,
  fs.hetstat = 10
)  
dev.off()

```
![](assets/kq4_dncr_meta.png){fig.align="left" width="84%"}

<foot_mg> RR: risk ratio; D1: bias arising from the randomization process; D2: bias due to deviations from intended interventions; D3: bias due to missing outcome data; D4: bias in measurement of the outcome; D5: bias in selection of the reported result: All: overall risk of bias.<br/> Risk of bias ratings: low +, some concerns ?, high -- .<br/> 
Four trials conducted in China and one each in Norway (Lindholm 2013) and Japan (Egawa 2016).<br/>
Including Geng 2017 assessments at day 3 — RR 0.66 (95% CI, 0.54–0.81; prediction interval, 0.54–0.91)</foot_mg><br/>

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delayed neurocognitive recovery assessed at postoperative day 5 or later (TIVA versus inhaled; randomized clinical trials; risk difference per 100). </caption_mg> <a id="kq4_delirium_risk-diff"></a>

```{r kq4_dncr_meta_forest_rd}
#| echo: false
#| include: false
png("assets/kq4_dncr_meta_forest_rd.png", width = 9.72, height = 5.65, units = "in", res = 300)
forest(dncr_tiva_inhaled_meta_rct_rd,
  allstudies = TRUE,
  common = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "D1", "D2", "D3", "D4", "D5", "Overall"),
  rightlabs = c("RD", "(95% CI)", "D1", "D2", "D3", "D4", "D5", "All"),
  just.addcols.right = "right",
  digits = 1,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  # sortvar = year,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  # xlim = c(-20, 20),
  pscal = 100,
  xlab = "Favors: TIVA                          Inhaled",
  addrows.below.overall = 4,
  fs.test.subgroup = 10,
  fs.hetstat = 10
)
dev.off()
```
![](assets/kq4_dncr_meta_forest_rd.png){fig.align="left" width="75%"}
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delayed neurocognitive recovery assessed at postoperative day 5 or later (TIVA versus inhaled anesthesia; small study effects). </caption_mg>

```{r kq4_dncr_funnel_limit} 
#| echo: false
#| include: false

dncr_tiva_inhaled_meta_or <- update(dncr_tiva_inhaled_meta , sm = "OR")

png("assets/kq4_dncr_or_funnel.png", width = 8.5, height = 5.5, units = "in", res = 300)
par(mar = c(4, 4, 2, 1))
limit_colors <- c("#AAB7B8", "#D5DBDB", "#F4F6F6")
# text(1.2, 0.05, labels = "Adjusted estimate", col = "darkgray", pos = 3, cex = .9)
par(bty = "n", xaxt = "s", yaxt = "s")
funnel(dncr_tiva_inhaled_meta_or,  pch = 20, contour = c(0.9, 0.95, 0.99), col.contour = limit_colors, studlab = TRUE, pos.studlab = 4, fs.smlab = 6, ff.smlab = "italic")
legend(0.1, 0.02, c("0.1 > p > 0.05", "0.05 > p > 0.01", "< 0.01"), fill = c("#AAB7B8", "#D5DBDB", "#F4F6F6"), bty = "n")
dev.off()

```

![](assets/kq4_dncr_or_funnel.png){width="75%"}
:::

::: {.callout-note collapse="true" appearance="minimal" icon="false"}
#### <caption_mg> `r figure_ref()` Delayed neurocognitive recovery summary risk of bias from randomized clinical trials comparing TIVA to inhaled anesthesia (weighted). </caption_mg>

```{r rob2_summary_dncr, fig.height = 3, out.width = "60%"}
temp <- update(dncr_tiva_inhaled_meta, subgroup = NULL)

add_weights <- tibble(temp$data$refid[temp$data$refid != 16559], temp$w.random / sum(temp$w.random)) |> # exclude Geng 2017
  set_names("refid", "weight")

rob_temp_dat <- rob2_dat |>
  filter(refid %in% temp$data$refid[temp$data$refid != 16559]) |>
  select(refid, Study, D1:Overall) |>
  left_join(add_weights, by = "refid") |>
  rename(Weight = weight) |> 
  select(-refid)
rob_summary(rob_temp_dat, tool = "ROB2", colour = "colourblind", weighted = TRUE)

```
:::

## **Postoperative Neurocognitive Disorder**

<font size = 4> `r table_ref()` Cognitive dysfunction > 30 days and ascertainment (TIVA versus inhaled; prospective cohort studies). </font>

```{r ncd_dat}
ncd_dat <- dichot_dat |>
  filter(if_any(c(neurocog_n1, neurocog_n2, neurocog_n3, neurocog_last_n, neurocog_total_n), ~ !is.na(.x))) |>
  # > 30 day exam
  filter(if_any(matches("neurocog.*time.*"), ~ .x > 30)) |>
  mutate(
    arm_n = ifelse(!is.na(neurocog_update_arm_n), neurocog_update_arm_n, arm_n),
    ncd_time = case_when(
      neurocog_time1 > 30 ~ neurocog_time1,
      neurocog_time2 > 30 ~ neurocog_time2,
      neurocog_time3 > 30 ~ neurocog_time3,
      neurocog_last_time > 30 ~ neurocog_last_time,
      neurocog_total_time > 30 ~ neurocog_total_time,
      .default = NA
    ),
    neurocog_total_n = case_when(
      neurocog_time1 > 30 ~ neurocog_n1,
      neurocog_time2 > 30 ~ neurocog_n2,
      neurocog_time3 > 30 ~ neurocog_n3,
      neurocog_last_time > 30 ~ neurocog_last_n,
      neurocog_total_time > 30 ~ neurocog_total_n
    ),
    neurocog_prop = neurocog_total_n / arm_n,
    neurocog_nper = n_per_fun(neurocog_total_n, arm_n, 1)
  ) |>
  left_join(study_char_dat |> select(refid, country), by = "refid") |>
  left_join(surgs |> select(refid, surgs_single_f), by = c("refid")) |>
  left_join(table_mn_med |> select(refid, arm_id, pre_mmse), by = c("refid", "arm_id")) |>
  rename(surg_f = surgs_single_f) |>
  arrange(refid, arm_id) |>
  mutate(
    bar = case_when(
      str_detect(arm, "Inhaled") ~ bar_prop(neurocog_prop * 100, "#969696"),
      str_detect(arm, "TIVA") ~ bar_prop(neurocog_prop * 100, color_2),
      .default = bar_prop(neurocog_prop * 100, color_1)),
    year = as.numeric(str_extract(study, "\\d{4}")),
    scale_mmse = ifelse(!is.na(neurocog_mmse), "\U2713", NA),
    scale_dst = ifelse(!is.na(neurocog_dst) | str_detect(neurocog_scale_otherspec, "[Dd]igit"), "\U2713", NA),
    scale_moca = ifelse(str_detect(neurocog_scale_otherspec, "MoCA|Montreal"), "\U2713", NA),
    scale_other = neurocog_scale_otherspec,
    scale_other = str_to_title(str_replace(scale_other, "Digit [Ss]ymbol [Tt]est; |Digit symbol substitution test; |Montreal Cognitive Assessment \\(MoCA\\)|MoCA", "")),
    scale_other = ifelse(scale_other == "", NA, scale_other),
    scale_other = str_replace_all(scale_other, "Pocd", "POCD"),
    scale_other_tf = ifelse(!is.na(scale_other), "\U2713", NA)
  ) |>
  select(refid, year, arm_id, study, study_l, design_f_lab, pre_mmse, country, surg_f, pre_mmse, ncd_time, neurocog_total_n, arm_n, arm, neurocog_nper, neurocog_prop, bar, scale_mmse:scale_other_tf)

ncd_rr_ref <- ncd_dat |>
  select(refid, arm_id, neurocog_total_n, arm_n) |>
  arrange(refid, arm_id) |>
  rename(ref_neurocog_n = neurocog_total_n, ref_arm_n = arm_n) |>
  group_by(refid) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_neurocog_n = ifelse(row_number() > 1, NA, ref_neurocog_n)
  ) |>
  fill(ref_arm_n, ref_neurocog_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_neurocog_n = ifelse(row_number() == 1, NA, ref_neurocog_n)
  )

ncd_dat <- ncd_dat |>
  left_join(ncd_rr_ref, by = c("refid", "arm_id")) |>
  mutate(rr_ci = ifelse(!is.na(ref_arm_n), rr_ci_fun(neurocog_total_n, arm_n, ref_neurocog_n, ref_arm_n), "—")) |>
  select(refid, year, design_f_lab, study, study_l, arm_id, arm_n, arm, pre_mmse, scale_mmse:scale_other_tf, ncd_time, neurocog_nper, bar, rr_ci)
```

```{r ncd_pool}
#| eval: false
temp_dat <- ncd_dat |> 
  mutate(n = as.numeric(str_extract(neurocog_nper, "\\d{1,2}"))) |> 
  select(study, arm, n, arm_n) |> 
  pivot_wider(names_from = "arm", values_from = c("n", "arm_n"))

metabin(n_TIVA, arm_n_TIVA, n_Inhaled, arm_n_Inhaled,
  data = temp_dat,
  studlab = study,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  # hakn = TRUE,
  # prediction = FALSE,
  allstudies = TRUE,
)

```

```{r ncd_gt}
#| eval: true
ncd_dat |>
  arrange(year, study) |>
  mutate(study_l = ifelse(row_number() > 1, NA, study_l),
         across(scale_mmse:scale_other_tf, ~ ifelse(row_number() > 1, NA, .x)),
         ncd_time = ifelse(row_number() > 1, NA, ncd_time),
         .by = study) |>
  group_by(design_f_lab) |>
  gt(id = "one") |>
  row_group_order(groups = c("Prospective Cohort")) |>
  cols_hide(c(refid, year, arm_id, study, scale_other)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              = "Comparator",
    pre_mmse         = "MMSE",
    scale_mmse       = "MMSE",
    scale_dst        = "DST",
    scale_moca       = "MoCA",
    scale_other_tf   = "Other",
    ncd_time         = "Day",
    neurocog_nper    = "N (%)",
    bar              = "0 — 100%",
    rr_ci            = "RR (95% CI)"
  ) |>
  gt_theme_mg() |>
  # fmt_markdown(columns = c(study_l, bar, pre_mmse, scale_mmse:scale_other_tf)) |>
  fmt_markdown(columns = c(study_l, bar, pre_mmse)) |>
  fmt_number(ncd_time, decimals = 0) |>
  sub_missing(columns = everything(), missing_text = "") |>
  tab_spanner(label = "Instrument", columns = c(scale_mmse:scale_other_tf), level = 1) |>
  tab_spanner(label = "Neurocognitive Disorder", columns = c(neurocog_nper:rr_ci), level = 1) |>
  tab_spanner(label = "Preop", columns = c(pre_mmse), level = 1) |>
  cols_width(
    study_l          ~ px(165),
    arm_n            ~ px(45),
    arm              ~ px(70),
    pre_mmse         ~ px(80),
    scale_mmse       ~ px(50),
    scale_dst        ~ px(50),
    scale_moca       ~ px(50),
    scale_other_tf   ~ px(50),
    ncd_time         ~ px(60),
    neurocog_nper    ~ px(90),
    bar              ~ px(100),
    rr_ci            ~ px(140),
  ) |>
  tab_style(style = cell_text(align = "left"),        locations = cells_column_labels(columns = c(study, arm))) |>
  tab_style(style = cell_text(align = "center"),      locations = cells_column_labels(columns = c(starts_with("scale"), pre_mmse, ncd_time, neurocog_nper, rr_ci))) |>
  # tab_style(style = cell_text(align = "right"),       locations = cells_column_labels(columns = c(neurocog_nper))) |>
  tab_style(style = cell_text(align = "left"),        locations = cells_body(columns = c(study, arm, pre_mmse))) |>
  tab_style(style = cell_text(align = "center"),      locations = cells_body(columns = c(starts_with("scale"), ncd_time, rr_ci))) |>
  tab_style(style = cell_text(align = "right"),       locations = cells_body(columns = c(neurocog_nper))) |>
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(arm_n:pre_mmse, neurocog_nper), rows = str_detect(arm, "TIVA"))) |>
  tab_footnote("Mini-Mental State Exam; DST: Digit Span Test; MoCA: Montreal Cognitive Assessment; RR: risk ratio.") |>
  tab_footnote("Pooled RR 1.15 (95% CI, 0.68–1.95)") |> 
  tab_footnote("Day of assessment.",                   locations = cells_column_labels(columns = c(ncd_time))) |>
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(pre_mmse))) |> 
  tab_footnote('Z ≥1.96.', locations = cells_body(columns = c(scale_dst), rows = arm_id == 1 & study == 'Rasmussen 2003')) |> 
  tab_footnote("Uniform Data Set Battery", locations = cells_body(columns = c(scale_other_tf), rows = study == "Deiner 2015" & arm_id == 1))
```

## **Physical Function**

No studies
    
## **Complications**

```{r complications_check_notrun}
#| eval: false

# create excel file to inspect complications
complication_fun <- function(var_prefix) {
  dichot_dat %>%
    filter(if_any(!!paste0(var_prefix, "_per"):!!paste0(var_prefix, "_95high"), ~ !is.na(.x))) |>
    select(refid, study, arm_id, arm, arm_n, comp_update_arm_n, !!paste0(var_prefix, "_n"):!!paste0(var_prefix, "_95high"))
}

# the complications included to be reported
complication_incl <- c("cardiac", "myoinfarct", "cardarr", "stroke", "kidneyinj", "asppneum", "atelec", "pulm", "pneum", "pthorax", "airleak", "pulcongest", "pe", "pinfiltrate", "respfail", "intub", "upperair", "vent48")

# complication <- c("medical", "surg", "cardiac", "gastro", "neuro", "pulm", "thromb", "infect", "fall", "stroke", "othcomp", "asppneum", "atelec", "bronch", "cardarr", "myoinfarct", "ssi", "sepsis", "uti", "pneum", "pthorax", "airleak", "pulcongest", "pe", "pinfiltrate", "respfail", "intub", "upperair", "vent48", "kidneyinj", "nerveinj", "clavien1", "clavien2", "clavien3", "clavien4", "clavien5")

adverse_events_dat <- map(complication_incl, complication_fun)

wb <- openxlsx::createWorkbook("kq4_complications")

for (i in 1:17) {
    temp_sheet <- adverse_events_dat[[i]]
    addWorksheet(wb, sheetName = complication_incl[i])
    setColWidths(wb, i, cols = c(1:12), widths = c(rep(15, 12)))
    writeData(wb, sheet = i, temp_sheet)
}

path <- glue::glue("/Users/mgrant/Desktop/temp.xlsx")
saveWorkbook(wb, "/Users/mgrant/Desktop/kq4.xlsx", overwrite = TRUE)
```

<font size = 4> `r table_ref()` Complications following TIVA versus inhaled anesthesia --- cardiac, pulmonary, and renal (randomized and nonrandomized designs). </font>

```{r complications}
#| warning: false
#| eval: true

# included complications; note add bradycardia from cardiac subsequently
complication_incl <- c("cardiac", "myoinfarct", "cardarr", "stroke", "kidneyinj", "asppneum", "atelec", "pulm", "pneum", "pthorax", "airleak", "pulcongest", "pe", "pinfiltrate", "respfail", "intub", "upperair", "vent48")

# complication_all <- c("medical", "surg", "cardiac", "gastro", "neuro", "pulm", "thromb", "infect", "fall", "stroke", "othcomp", "asppneum", "atelec", "bronch", "cardarr", "myoinfarct", "ssi", "sepsis", "uti", "pneum", "pthorax", "airleak", "pulcongest", "pe", "pinfiltrate", "respfail", "intub", "upperair", "vent48", "kidneyinj", "nerveinj", "clavien1", "clavien2", "clavien3", "clavien4", "clavien5")

complication_fun <- function(var_prefix) {
  dichot_dat %>%
    filter(if_any(!!paste0(var_prefix, "_per"):!!paste0(var_prefix, "_95high"), ~ !is.na(.x))) |>
    select(refid, year, study, arm_id, arm, arm_n, comp_update_arm_n, !!paste0(var_prefix, "_n"):!!paste0(var_prefix, "_95high")) |>
    mutate(complication = var_prefix) |>
    rename_with(~ str_replace(.x, "95", "ci_"), .cols = everything()) |>
    rename_with(~ str_replace(.x, "^.*_", ""), .cols = c(8:15)) |>
    arrange(complication, year, study, arm_id)
}

# adverse event data includes all reported complications in list
adverse_events_dat <- map_df(complication_incl, complication_fun) |>
  mutate(
    arm_n = ifelse(!is.na(comp_update_arm_n), comp_update_arm_n, arm_n),
    calc_per = n / arm_n * 100,
    n_per = n_per_fun(n, arm_n, 1),
    diff = per - calc_per
  )

# if RR convert to OR get ln_te ln_se
# if reported OR use ests to get ln_te ln_se
# if neither use estimate
adverse_events_dat <- adverse_events_dat |>
  left_join(cardiac_compl, by = c("refid", "complication")) |>
  left_join(study_char_dat |> select(refid, study_l, surgs_single, design_f_lab), by = "refid") |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |>
  arrange(complication, surgs_single, year, study, arm_id) |> 
  mutate(
    complication = if_else(detail_cardiac == "bradycardia", "bradycardia", complication, missing = complication),
    study_compl = paste0(study, complication),
    ref_arm_n = arm_n,
    ref_n = n
  ) |>
  group_by(study_compl) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_n = ifelse(row_number() > 1, NA, ref_n)
  ) |>
  fill(ref_arm_n, ref_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_n = ifelse(row_number() == 1, NA, ref_n)
  ) |>
  mutate(
    # Luntz 2004 combine inhalation arms; differed in induction
    ref_arm_n = ifelse(study == "Luntz 2004" & arm_id == 3, 64, ref_arm_n),
    ref_n = ifelse(study == "Luntz 2004" & arm_id == 3, 5, ref_n),
    ref_arm_n = ifelse(study == "Luntz 2004" & arm_id == 2, NA, ref_arm_n),
    ref_n = ifelse(study == "Luntz 2004" & arm_id == 2, NA, ref_n),
    rd_ci = ifelse(!is.na(ref_n), rd_per_ci_fun(n, arm_n, ref_n, ref_arm_n, digits = 2), "—"),
    or_ci = ifelse(!is.na(ref_n) & n != 0 & ref_arm_n != 0, or_ci_fun(n, arm_n, ref_n, ref_arm_n, digits = 2), "—"), # not if any Os
    rr_ci = ifelse(!is.na(ref_n) & n != 0 & ref_arm_n != 0, rr_ci_fun(n, arm_n, ref_n, ref_arm_n, digits = 2), "—"), # not if any Os
    # or_ci = ifelse(!is.na(ref_n), or_ci_fun(n, arm_n, ref_n, ref_arm_n, digits = 2), "—"),
    or_ln_te = ifelse(!is.na(ref_n), or_ln_te_fun(n, arm_n, ref_n, ref_arm_n), NA),
    or_ln_se_te = ifelse(!is.na(ref_n), or_ln_se_fun(n, arm_n, ref_n, ref_arm_n), NA),
    bar = case_when(
      str_detect(arm, "Inhaled") ~ bar_prop(calc_per, "#969696"),
      .default = bar_prop(calc_per, "#A93226"))) |>
  ungroup() |>
  select(refid, year, arm_id, study, study_l, study_compl, arm_n, arm, n, age_table, surgs_single, n_per, bar, rd_ci, rr_ci, or_ci, or_ln_te, or_ln_se_te, complication, design_f_lab, effect:high, detail_cardiac) 

# adverse_events_dat |> filter(!is.na(detail_cardiac)) |> select(study, detail_cardiac) |> distinct()

# for summary table
# temp <- adverse_events_dat |>
#   group_by(refid, arm_id) |>
#   filter(str_detect(design_f_lab, "Rand")) |>
#   slice(1) |>
#   ungroup() |>
#   summarise(total = sum(arm_n, na.rm = TRUE))
# 
# length(unique(temp$refid))

# temp <- adverse_events_dat |>
#   # filter(!str_detect(design_f_lab, "Random")) |>
#   mutate(
#     effect = ifelse(is.na(est), "OR", effect),
#     est = case_when(
#       !is.na(effect) & !is.na(est) & !is.na(low + high) ~ paste0(est, " (", sprintf("%.2f", low), ", ", sprintf("%.2f", high), ")"),
#       is.na(est) & effect == "OR" ~ or_ci),
#     # est = ifelse(is.na(est), or_ci, est),
#     # effect = ifelse(est == "—", NA, effect),
#     # # est = ifelse(!is.na(low) & effect != "RD", paste0(est, " (", sprintf("%.2f", low), ", ", sprintf("%.2f", high), ")"), est)
#   ) |>
#   mutate(effect = ifelse(est == "—", NA, effect)) |>
#   select(refid, study,  arm_n, arm, n, est, n_per, bar, effect, low, high, or_ci, rd_ci, rr_ci, complication, design_f_lab)
```

```{r complications_gt}
#| eval: true
# propensity matched for footnotes
# Park 2020 (refid: 1134), Oh 2019 (refid: 132), Yoshimura 2022 (refid: 16890)
propensity_refid <- c(1134, 132, 16890)

adverse_events_gt_dat <- adverse_events_dat |>
  filter(complication %in% c(complication_incl, "bradycardia")) |>
  mutate(
    complication = fct(complication),
    complication = fct_recode(complication,
      "Other Cardiac" = "cardiac",
      "MI" = "myoinfarct",
      "Cardiac Arrest" = "cardarr",
      "Bradycardia" = "bradycardia",
      "Stroke" = "stroke",
      "Acute Kidney Injury" = "kidneyinj",
      "Pneumonia" = "pneum",
      "Pulmonary Congestion" = "pulcongest",
      "Pulmonary Embolism" = "pe",
      "Pneumothorax" = "pthorax",
      "Respiratory Failure" = "respfail"
    )
  ) |> 
  arrange(year, study, arm) |>
  mutate(
    rd_or = ifelse(refid %in% propensity_refid & row_number() != 1, paste0("<u>", or_ci, "</u>"), rd_ci),
    rd_or = ifelse(rd_or == "<u>—</u>", "—", rd_or),
    surgs_single = ifelse(surgs_single == "Vasc", "Vascular", surgs_single),
    study_l = ifelse(row_number() > 1, "", study_l),
    surgs_single = ifelse(row_number() > 1, "", surgs_single),
    complication = fct_drop(complication),
    complication_nodesign = complication,
    .by = study_compl
  ) |>
  unite(complication, complication, design_f_lab, sep = " – ") 

adverse_meta_dat <- adverse_events_gt_dat |>
  select(refid, year, study, arm_id, arm, arm_n, n, complication, or_ln_te, or_ln_se_te) |>
  mutate(
    n = case_when(
      study == "Luntz 2004" & arm_id == 1 ~ collapse_dichot(adverse_events_gt_dat, "Luntz 2004", c(1, 2), n),
      .default = n
    ),
    arm_n = case_when(
      study == "Luntz 2004" & arm_id == 1 ~ collapse_dichot(adverse_events_gt_dat, "Luntz 2004", c(1, 2), arm_n),
      .default = arm_n
    )
  ) |>
  filter(!(study %in% c("Luntz 2004") & arm_id  == 2)) 

adverse_meta_wide_dat <- adverse_meta_dat |>
  # filter(!is.na(or_ln_te)) |>
  arrange(refid, complication) |>
  pivot_wider(names_from = "arm", values_from = arm_n:n) |>
  group_by(refid, complication) |>
  fill(or_ln_te:n_TIVA) |>
  slice(2) |>
  ungroup() |>
  mutate(
    complication_nodesign = str_remove(complication, "\\s–.*"),
    study_design = ifelse(str_detect(complication, "Rand"), paste0(study, "*"), study)
  )

adverse_events_gt_dat |> 
  # tabyl(complication) |> arrange(desc(percent)) |> pull(complication) |> toString()
  group_by(complication) |>
  gt() |> 
  # gt(id = "one") |>
  row_group_order(groups = c("MI – Randomized Clinical Trial", "MI – Retrospective Cohort", "Cardiac Arrest – Randomized Clinical Trial", "Cardiac Arrest – Retrospective Cohort", "Bradycardia – Randomized Clinical Trial", "Bradycardia – Nonrandomized Trial", "Other Cardiac – Randomized Clinical Trial", "Stroke – Randomized Clinical Trial", "Acute Kidney Injury – Retrospective Cohort", "Acute Kidney Injury – Randomized Clinical Trial", "Pneumonia – Randomized Clinical Trial", "Pneumothorax – Randomized Clinical Trial", "Pulmonary Embolism – Randomized Clinical Trial", "Pulmonary Embolism – Retrospective Cohort", "Pulmonary Congestion – Retrospective Cohort", "Respiratory Failure – Randomized Clinical Trial", "Respiratory Failure – Retrospective Cohort")
) |>
  cols_hide(c(refid, year, study, arm_id, n, study, study_compl, rd_ci, rr_ci, or_ci, or_ln_te, or_ln_se_te, effect, adjcrude, est, low, high, detail_cardiac, complication_nodesign)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              =  "Arm",
    age_table        = "    Age",
    surgs_single     = "Surgery",
    n_per            = "N (%)",
    bar              = "0 – 100%",
    rd_or            = md("RD <u>OR</u> (95% CI)")
  ) |>
  fmt_markdown(columns = c(study_l, bar, age_table, rd_or)) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",") |> 
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l          ~ px(140),
    arm_n            ~ px(60),
    arm              ~ px(60),
    age_table        ~ px(100),
    surgs_single     ~ px(80),
    n_per            ~ px(90),
    bar              ~ px(100),
    rd_or            ~ px(140)
  ) |>
  tab_style(style = cell_text(align = "left"),          locations = cells_column_labels(columns = c(arm))) |>
  tab_style(style = cell_text(align = "center"),        locations = cells_column_labels(columns = c(arm_n, rd_or))) |>
  # tab_style(style = cell_text(align = "right"),       locations = cells_column_labels(columns = c())) |>
  tab_style(style = cell_text(align = "left"),          locations = cells_body(columns = c(arm, age_table, rd_or, surgs_single))) |>
  tab_style(style = cell_text(align = "center"),        locations = cells_body(columns = c(rd_or))) |>
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table))) |> 
  tab_footnote("Odds ratios for propensity-matched studies (risk differences accounting for matching were not reported).", locations = cells_column_labels(columns = c(rd_or))) |> 
  tab_footnote("RD: risk difference; OR: odds ratio; Ophtho: ophthalmologic; GI: gastointestinal; Abd: abdominal.") |> 
  tab_footnote("Compared with combined inhalation arms (differed only in induction agents).", locations = cells_body(columns = c(rd_or), rows = study == "Luntz 2004" & arm_id == 3)) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n:age_table, n_per), rows = str_detect(arm, "TIVA"))) |> 
  tab_footnote("Atrial fibrillation.",                  locations = cells_body(columns = c(study_l), rows = detail_cardiac == "atrial fibrillation" & arm_id == 1), placement = c("right")) |> 
  tab_footnote("Cardiac dysfunction.",                  locations = cells_body(columns = c(study_l), rows = detail_cardiac == "cardiac dysfunction" & arm_id == 1), placement = c("right"))

```

### *Pooled*

Note: given the limited number of randomized studies and absence of convincing evidence for any complication, we pooled all designs without detriment to any strength of evidence rating. When odds ratios were pooled, approximate risk differences were calculated based on the event rate across inhaled anesthetic arms and the corresponding risk ratio derived from the odds ratio.


```{r complication_meta}

complication_meta_or <- function(compl_label, use_hakn = TRUE, predictive = TRUE, study_label = "study_design"){
meta_dat <- adverse_meta_wide_dat |>
  filter(!str_detect(complication, "Other Cardiac")) |> 
  select(-complication) |>
  rename(complication = complication_nodesign) |>
  filter(complication %in% compl_label) |> 
  left_join(rob2_meta_dat, by = "refid")

complication_bin <- metagen(
  or_ln_te, or_ln_se_te,
  data = meta_dat,
  studlab = study_design,
  sm = "OR",
  prediction = predictive,
  hakn = use_hakn,
  allstudies = FALSE,
)  
}

complication_meta_rr <- function(compl_label, use_hakn = TRUE, predictive = TRUE, study_label = "study_design", ...){
meta_dat <- adverse_meta_wide_dat |>
  filter(!str_detect(complication, "Other Cardiac")) |> 
  select(-complication) |>
  rename(complication = complication_nodesign) |>
  filter(complication %in% compl_label) 

complication_bin <- metabin(
  event.e = n_TIVA,
  n.e = arm_n_TIVA,
  event.c = n_Inhaled,
  n.c = arm_n_Inhaled,
  data = meta_dat,
  studlab = study_design,
  sm = "RR",
  prediction = predictive,
  hakn = use_hakn,
  allstudies = FALSE,
  method = "MH",
  ...)  
}

complication_forest_or <- function(adverse_meta, use_predictive = TRUE, ...){
forest(adverse_meta,
  allstudies = TRUE,
  random = TRUE,
  rightcols = c("effect", "ci"),
  rightlabs = c("OR ", "(95% CI)   "),
  leftcols = c("study_design", "n_TIVA", "arm_n_TIVA", "n_Inhaled", "arm_n_Inhaled"), 
  leftlabs = c("Study", "TIVA\n Events", "Total", "Inhaled\nEvents", " Total"),
  colgap.right = "4mm",
  just.addcols.right = "center",
  just.addcols.left = "right",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  # print.subgroup.name = FALSE,
  overall = TRUE,
  print.I2.ci = TRUE,
  prediction = use_predictive,
  fs.xlab = 11,
  # pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  xlim = c(0.1, 10),
  xlab = "Favors: TIVA                             Inhaled",
  addrows.below.overall = 4,
  text.addline1 = "*Randomized clinical trial",
  fs.hetstat = 10,
  ...
)
}

complication_forest_rr <- function(adverse_meta, random = TRUE, use_predictive = TRUE, ...){
forest(adverse_meta,
  allstudies = TRUE,
  random = random,
  # leftcols = c("study_design", "n_TIVA", "arm_n_TIVA", "n_Inhaled", "arm_n_Inhaled"), 
  label.e = "TIVA           ",
  label.c = "Inhaled          ",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  colgap.right = "4mm",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  # print.subgroup.name = FALSE,
  overall = TRUE,
  print.I2.ci = TRUE,
  prediction = use_predictive,
  fs.xlab = 11,
  # pooled.events = TRUE,
  digits = 2, 
  pooled.events = TRUE,
  print.pval.Q = FALSE,
  xlim = c(0.1, 10),
  xlab = "Favors: TIVA                             Inhaled",
  addrows.below.overall = 4,
  text.addline1 = "*Randomized clinical trial",
  fs.hetstat = 10,
  ...
)
}

```

#### Myocardial Infarction

<font size = 4> `r figure_ref()` Odds ratio for myocardial infarction (TIVA versus inhaled anesthesia; randomized and nonrandomized studies). </font>

```{r complication_mi}
#| echo: false
#| include: false

png("assets/kq4_complication_mi.png", width = 8.35, height = 3.8, units = "in", res = 300)
temp_meta <- complication_meta_or("MI", use_hakn = FALSE, study_label = "study_design")
complication_forest_or(temp_meta, big.mark = ",", text.addline2 = risk_diff_meta_or())
dev.off()
```

![](assets/kq4_complication_mi.png){fig.align="left" width="61%"}

#### Cardiac Arrest

<font size = 4> `r figure_ref()` Risk ratio for cardiac arrest (TIVA versus inhaled anesthesia; randomized and nonrandomized studies). </font>

```{r complication_cardiac_arrest}
#| echo: false
#| include: false
png("assets/kq4_complication_cardiac_arrest.png", width = 7.95, height = 2.8, units = "in", res = 300)
temp_meta <- complication_meta_rr("Cardiac Arrest", random = FALSE, use_hakn = FALSE)
complication_forest_rr(temp_meta, random = FALSE, big.mark = ",", text.addline2 = risk_diff_meta_rr())
dev.off()

```

![](assets/kq4_complication_cardiac_arrest.png){fig.align="left" width="58%"}

#### Bradycardia

<font size = 4> `r figure_ref()` Risk ratio for bradycardia (TIVA versus inhaled anesthesia; randomized and nonrandomized studies). </font>

```{r complication_brady}
#| echo: false
#| include: false
png("assets/kq4_complication_brady.png", width = 7.95, height = 3.6, units = "in", res = 300)
temp_meta <- complication_meta_rr("Bradycardia", use_hakn = FALSE)
complication_forest_rr(temp_meta, big.mark = ",", text.addline2 = risk_diff_meta_rr())
dev.off()

```

![](assets/kq4_complication_brady.png){fig.align="left" width="58%"}

#### Acute Kidney Injury

<font size = 4> `r figure_ref()` Odds ratio for acute kidney injury complications (TIVA versus inhaled anesthesia; randomized and nonrandomized studies). </font>

```{r complication_renal}
#| echo: false
#| include: false

png("assets/kq4_complication_renal.png", width = 8.35, height = 3.6, units = "in", res = 300)
temp_meta <- complication_meta_or("Acute Kidney Injury", use_hakn = FALSE)
complication_forest_or(temp_meta, big.mark = ",", text.addline2 = risk_diff_meta_or(digits = 2))
dev.off()
```

![](assets/kq4_complication_renal.png){fig.align="left" width="61%"}

#### Pneumonia

<font size = 4> `r figure_ref()` Risk ratio for pneumonia (TIVA versus general anesthesia; randomized clinical trials). </font>

```{r complication_pneumonia}
#| echo: false
#| include: false

png("assets/kq4_complication_pneumonia.png", width = 7.95, height = 3.4, units = "in", res = 300)
temp_meta <- complication_meta_rr("Pneumonia", use_hakn = FALSE, predictive = TRUE)
complication_forest_rr(temp_meta, use_predictive = TRUE, text.addline2 = risk_diff_meta_rr())
dev.off()
```

![](assets/kq4_complication_pneumonia.png){fig.align="left" width="58%"}

#### Pulmonary Embolism

<font size = 4> `r figure_ref()` Odds ratio for pulmonary embolism (TIVA versus general anesthesia; randomized and nonrandomized studies). </font>

```{r complication_pe}
#| echo: false
#| include: false

png("assets/kq4_complication_pe.png", width = 8.55, height = 3.6, units = "in", res = 300)
temp_meta <- complication_meta_or("Pulmonary Embolism", use_hakn = FALSE, predictive = FALSE)
complication_forest_or(temp_meta, use_predictive = TRUE, big.mark = ",", text.addline2 = risk_diff_meta_or(digits = 2))
dev.off()
```

![](assets/kq4_complication_pe.png){fig.align="left" width="61%"}

#### Respiratory Failure 

<font size = 4> `r figure_ref()` Odds ratio for respiratory failure (TIVA versus general anesthesia; randomized and nonrandomized studies). </font>

```{r respiratory_failure}
#| echo: false
#| include: false

png("assets/kq4_respiratory_failure.png", width = 8.35, height = 3.4, units = "in", res = 300)
temp_meta <- complication_meta_or("Respiratory Failure", use_hakn = FALSE, predictive = FALSE)
complication_forest_or(temp_meta, use_predictive = TRUE, big.mark = ",", text.addline2 = risk_diff_meta_or(digits = 2))
dev.off()
```

![](assets/kq4_respiratory_failure.png){fig.align="left" width="61%"}

## **Patient Satisfaction**

<font size = 4> `r table_ref()` Patient satisfaction according to TIVA or inhalation anesthesia. </font>

```{r pt_satisfaction}
satis_dat_gt <- dichot_dat |>
  select(refid, year, study, study_l, arm_id, arm_n, arm, design_f_lab, matches("satis"), notes_d) |>
  left_join(surgs |> select(refid, surgs_noabbr_f), by = "refid") |>
  left_join(study_arm_dat |> select(refid, arm_id, asa_ps_incl), by = c("refid", "arm_id")) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |> # age_table
  filter(if_any(satis_n:satis_95high, ~ !is.na(.x))) |>
  select(!c(d_satisfaction, satis_pval:satis_95high)) |>
  mutate(
    n_percent = n_per_fun(satis_n, arm_n, n_sig_dig = 1),
    bar = case_when(
      str_detect(arm, "Inhaled") ~ bar_prop(satis_n / arm_n * 100, "#969696"),
      str_detect(arm, "TIVA") ~ bar_prop(satis_n / arm_n * 100, color_2)
    )
  ) |>
  arrange(year, study, arm_id) 

satis_dat_gt <- satis_dat_gt |>
  mutate(
    satis_n = case_when(
      study == "Luntz 2004" & arm_id == 1 ~ collapse_dichot(satis_dat_gt, "Luntz 2004", c(1, 2), satis_n),
      .default = satis_n
    ),
    arm_n = case_when(
      study == "Luntz 2004" & arm_id == 1 ~ collapse_dichot(satis_dat_gt, "Luntz 2004", c(1, 2), arm_n),
      .default = arm_n
    )
  ) |>
  filter(!(study %in% c("Luntz 2004") & arm_id == 2)) |>
  mutate(
    ref_arm_n = arm_n,
    ref_n = satis_n
  ) |>
  group_by(refid) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_n = ifelse(row_number() > 1, NA, ref_n)
  ) |>
  fill(ref_arm_n, ref_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_n = ifelse(row_number() == 1, NA, ref_n)
  ) |>
  ungroup() |>
  mutate(
    rd_ci = ifelse(!is.na(ref_n), rd_per_ci_fun(satis_n, arm_n, ref_n, ref_arm_n, digits = 1), "—")
  )
  
satis_dat_gt |> 
 mutate(study_l = ifelse(row_number() > 1, "", study_l), 
        surgs_noabbr_f = ifelse(row_number() > 1, "", as.character(surgs_noabbr_f)), 
        surgs_noabbr_f = ifelse(str_detect(surgs_noabbr_f, "Gast"), "GI/Abdominal", surgs_noabbr_f), 
        asa_ps_incl = ifelse(row_number() > 1, "", asa_ps_incl), 
        .by = study) |>
  gt(id = "one") |>
  cols_hide(c(refid, year, arm_id, study, design_f_lab, satis_n, satis_per, notes_d, ref_arm_n, ref_n, satis_update_arm_n)) |>
  cols_label(
    study_l          = "Study",
    arm_n            = " N",
    arm              = "Anesth",
    asa_ps_incl      = "PS",
    age_table        = "Age",
    surgs_noabbr_f   = "Surgery",
    n_percent        = "     N (%)",
    bar              = "0 – 100%",
    rd_ci            = "RD (95% CI)"
  ) |>
  tab_spanner(label = "ASA", columns = c(asa_ps_incl), level = 1) |>
  fmt_markdown(columns = c(study_l, age_table, bar)) |>
  sub_missing(columns = everything(), missing_text = "") |>
  gt_theme_mg() |>
  cols_width(
    study_l          ~ px(165),
    arm_n            ~ px(45),
    arm              ~ px(80),
    asa_ps_incl      ~ px(60),
    age_table        ~ px(80),
    surgs_noabbr_f   ~ px(100),
    n_percent        ~ px(100),
    bar              ~ px(100),
    rd_ci            ~ px(140),
  ) |> 
  tab_style(style = cell_text(align = "center", font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |>
  tab_style(style = cell_text(align = "left"),        locations = cells_column_labels(columns = c(study, arm))) |> 
  tab_style(style = cell_text(align = "center"),      locations = cells_column_labels(columns = c(asa_ps_incl, age_table, n_percent))) |> 
  tab_footnote("Mean (SD).",   locations = cells_column_labels(columns = c(age_table))) |>
  tab_footnote("TIVA: total intravenous anesthesia; ASA PS: ASA Physical Status; RD: risk difference.") |> 
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(arm_n:n_percent), rows = str_detect(arm, "TIVA"))) |> 
  tab_footnote("Completely satisfied.",               locations = cells_body(columns = c(n_percent), rows = study == "Epple 2001"), placement = "right") |>  
  tab_footnote("Highly satisfied.",                   locations = cells_body(columns = c(n_percent), rows = study == "Luntz 2004"), placement = "right") |>  
  tab_footnote("Inhaled arms combined.",              locations = cells_body(columns = c(arm), rows = study == "Luntz 2004" & arm == "Inhaled"), placement = "right") |>  
  tab_footnote("Very satisfied.",                     locations = cells_body(columns = c(n_percent), rows = study == "Nishikawa 2007a"), placement = "right") 

```

### *Pooled*

<font size = 4> `r figure_ref()` Risk ratio for patient satisfaction (TIVA versus inhaled; randomized clinical trials). </font>

```{r satis_rct_meta}
#| echo: false
#| include: false

satis_meta_dat <- satis_dat_gt |> 
  select(refid, year, study, arm, satis_n, arm_n) |> 
  pivot_wider(names_from = "arm", values_from = satis_n:arm_n) |> 
  left_join(rob2_meta_dat, by = "refid") 

satis_meta <- metabin(satis_n_TIVA, arm_n_TIVA, satis_n_Inhaled, arm_n_Inhaled,
  data = satis_meta_dat,
  studlab = study,
  # cluster = refid,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  hakn = FALSE,
  prediction = FALSE,
  allstudies = TRUE,
)

# summary(plac_meta)

png("assets/kq4_satis_rct.png", width = 7.85, height = 3.4, units = "in", res = 300)
forest(satis_meta,
  allstudies = TRUE,
  # random = FALSE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci"),
  rightlabs = c("RR", "(95% CI)"),
  just.addcols.right = "right",
  colgap.right = "4mm",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  # xlim = c(0.1, 20),
  xlab = "Favors: Inhaled                       TIVA       ",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  text.addline1 = "Similar inhaled arms combined for Luntz 2004.",
  text.addline2 = "Comparing higher versus lower levels of satisfaction (see preceding table).",
)
dev.off()

```

![](assets/kq4_satis_rct.png){fig.align="left" width="58%"}


## **Length of Stay**

<font size = 4> `r table_ref()` Length of stay according to procedure classification and comparator. </font>

```{r length_of_stay}
#| echo: false
los_tab <- contin_dat |>
  mutate(los_for_tables(contin_dat)) |>
  filter(if_any(los_m:los_diff_pval, ~ !is.na(.))) |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |> # age_table
  left_join(study_arm_dat |> select(refid, arm_id, asa_ps_incl), by = c("refid", "arm_id")) |>
  left_join(surgs |> select(refid, surgs_noabbr_f), by = c("refid")) |>
  left_join(study_char_dat |> select(refid, country), by = "refid") |>
  mutate(
    refid_arm_id = paste0(refid, "-", arm_id),
    surg_groups = paste0(design_f_lab, " - ", surgs_noabbr_f),
    mean_med = case_when(
      !is.na(los_m) ~ los_m,
      !is.na(los_med) ~ los_med
    ),
    calc_prop_35d = 100 * mean_med / 35,
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(calc_prop_35d, "#A93226"),
      .default = bar_prop(calc_prop_35d, "#969696")
    )
  ) |>
  arrange(surg_groups, year, study, arm_id) |>
  select(refid, refid_arm_id, study, study_l, arm_n, arm, asa_ps_incl, age_table, los_table, bar, surg_groups, country)

los_tab |>
  mutate(
    study_l = ifelse(row_number() > 1, "", study_l),
    country = ifelse(row_number() > 1, "", country),
    .by = refid
  ) |>
  # tabyl(surg_groups) |> pull(surg_groups) |> toString()
  group_by(surg_groups) |>
  gt(id = "one") |>
  row_group_order(groups = c(
    "Randomized Clinical Trial - Gastrointestinal/Abdominal",
    "Randomized Clinical Trial - Thoracic",
    "Randomized Clinical Trial - Various",
    "Retrospective Cohort - Cardiac",
    "Retrospective Cohort - Orthopedic",
    "Retrospective Cohort - Various"
  )) |>
  cols_hide(c(refid, refid_arm_id, study)) |>
  cols_label(
    study_l = "Study",
    arm_n = " N",
    arm = "Anesth",
    asa_ps_incl = "PS",
    age_table = "    Age",
    los_table = "    LOS",
    bar = "0 – 35 days",
    country = "Country"
  ) |>
  fmt_integer(use_seps = TRUE, sep_mark = ",") |>
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(60),
    arm ~ px(80),
    asa_ps_incl ~ px(60),
    age_table ~ px(100),
    los_table ~ px(100),
    bar ~ px(120),
    country ~ px(80)
  ) |>
  fmt_markdown(columns = c(study_l, bar, age_table, los_table)) |>
  tab_style(style = cell_text(align = "center", font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(arm_n, arm, bar))) |>
  tab_style(style = cell_text(align = "left"), locations = cells_column_labels(columns = c(study_l, age_table, los_table))) |>
  tab_style(style = cell_text(align = "left"), locations = cells_body(columns = c(study_l, age_table, los_table, bar, arm))) |>
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n:los_table), rows = str_detect(arm, "TIVA"))) |>
  tab_footnote(md("NR: not reported")) |>
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table, los_table))) |>
  tab_footnote(md("ASA Physical Status."), locations = cells_column_labels(columns = c(asa_ps_incl)))

```

### *Pooled*

<font size = 4> `r figure_ref()` Mean difference in length of stay (TIVA versus inhaled; randomized clinical trials). </font>

```{r los_meta}
#| echo: false
#| include: false 

los_meta_dat <- contin_dat |>
  filter(refid %in% los_tab$refid) |> 
  select(refid, study, design_f_lab, arm, arm_n, los_m, los_sd, los_med, los_rl, los_ru, los_iqrl, los_iqru, los_95l, los_95u) |> 
  rename_with(~ str_remove(.x, "los_")) |> 
  select(!matches("95")) |> 
  pivot_wider(names_from = "arm", values_from = arm_n:iqru) |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  arrange(year) 

los_rct_meta_dat <- los_meta_dat |> 
  filter(str_detect(design_f_lab, "Rand")) |> 
  left_join(rob2_meta_dat, by = "refid") |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid")

los_nrsi_meta_dat <- los_meta_dat |> 
  filter(!str_detect(design_f_lab, "Rand")) |> 
  left_join(robinsi_meta_dat, by = "refid") |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid")

los_meta <- metacont(
  n.e = arm_n_TIVA, 
  n.c = arm_n_Inhaled,
  common =  TRUE,
  mean.e = m_TIVA,
  sd.e = sd_TIVA,
  median.e = med_TIVA,
  q1.e = iqrl_TIVA,
  q3.e = iqru_TIVA,
  min.e = rl_TIVA,
  max.e = ru_TIVA,
  mean.c = m_Inhaled,
  sd.c = sd_Inhaled,
  median.c = med_Inhaled,
  q1.c = iqrl_Inhaled,
  q3.c = iqru_Inhaled,
  min.c = rl_Inhaled,
  max.c = ru_Inhaled,
  data = los_rct_meta_dat,
  sm = "MD",
  method.tau = "REML",
  hakn = FALSE,
  prediction = TRUE,
  studlab = study
)

png("assets/kq4_los_rct.png", width = 9.08, height = 3.4, units = "in", res = 300)
forest(los_meta,
  weight.study = "random",
  common =  TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  print.tau2 = FALSE,
  print.tau = TRUE,
  print.tau.ci = TRUE,
  digits = 1,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau = 1,
  # digits.pval.Q = 2,
  print.I2.ci = TRUE,
  fs.xlab = 10,
  just.addcols.right = "right",
  print.pval.Q = FALSE,
  # sortvar = -TE,
  xlim = c(-10, 10),
  # at = c(-80, -60, -40, -20, 0, 20, 40),
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("MD ", "(95% CI)   ", "Procedure"),
  xlab = "Favors: TIVA                                      Inhaled           ",
  smlab = "Mean Difference (days)",
  addrows.below.overall = 4,
  fs.hetstat = 10
)
dev.off()

```

![](assets/kq4_los_rct.png){fig.align="left" width="65%"}

<br/>

<font size = 4> `r figure_ref()` Mean difference in length of stay (TIVA versus inhaled; nonrandomized designs). </font>

```{r los_nrsi_meta}
#| echo: false
#| include: false

los_meta <- metacont(
  n.e = arm_n_TIVA, 
  n.c = arm_n_Inhaled,
  common =  TRUE,
  mean.e = m_TIVA,
  sd.e = sd_TIVA,
  median.e = med_TIVA,
  q1.e = iqrl_TIVA,
  q3.e = iqru_TIVA,
  min.e = rl_TIVA,
  max.e = ru_TIVA,
  mean.c = m_Inhaled,
  sd.c = sd_Inhaled,
  median.c = med_Inhaled,
  q1.c = iqrl_Inhaled,
  q3.c = iqru_Inhaled,
  min.c = rl_Inhaled,
  max.c = ru_Inhaled,
  data = los_nrsi_meta_dat,
  sm = "MD",
  method.tau = "REML",
  hakn = FALSE,
  prediction = TRUE,
  studlab = study
)

png("assets/kq4_los_nrsi.png", width = 9.68, height = 3.0, units = "in", res = 300)
forest(los_meta,
  weight.study = "random",
  common =  FALSE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  print.tau2 = FALSE,
  print.tau = TRUE,
  print.tau.ci = TRUE,
  digits = 1,
  digits.sd = 1,
  digits.mean = 1,
  digits.tau = 1,
  print.I2.ci = TRUE,
  fs.xlab = 10,
  just.addcols.right = "right",
  print.pval.Q = FALSE,
  # sortvar = -TE,
  xlim = c(-10, 10),
  # at = c(-80, -60, -40, -20, 0, 20, 40),
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("MD", "(95% CI)  ", "Procedure"),
  xlab = "Favors: TIVA                                      Inhaled           ",
  smlab = "Mean Difference (days)",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  big.mark = ",",
  text.addline1 = "If mean or standard deviation were not reported, they were imputed from from the median, interquartile range, and/or range."
)
dev.off()

```

![](assets/kq4_los_nrsi.png){fig.align="left" width="65%"}

## **Discharge Location**

No studies reported

## **Mortality**

```{r mortality_data}
#| eval: true
mortality_dat <- dichot_dat |>
  filter(if_any(starts_with("mort"), ~ !is.na(.x))) |> 
  # filter(arm_n != mort_update_arm_n) |> 
  # select(refid, arm_n, mort_update_arm_n)
  mutate(
    # arm_n use mort_update_arm_n if different
    arm_n = ifelse(!is.na(mort_update_arm_n), mort_update_arm_n, arm_n)
  ) |> 
  select(refid, refid_c, arm_id, arm, year, study, study_l, design_f_lab, arm_n, matches("_n|per") & starts_with("mort"), -mort_update_arm_n) |> 
  pivot_longer(
    cols = starts_with("mort"),
    names_to = "estimand",
    values_to = "estimate",
    values_drop_na = TRUE
  ) |>
  mutate(
    mort_period = str_remove(estimand, "_.*"),
    estimand = str_replace(estimand, ".*_(.*)$", "\\1")
  ) |>
  pivot_wider(
    names_from = estimand,
    values_from = estimate
  ) |>
  mutate(
    mort_period = case_when(
      str_detect(mort_period, "hosp") ~ "Hospital",
      str_detect(mort_period, "mort30") ~ "30-day",
      str_detect(mort_period, "mort90") ~ "90-day",
      str_detect(mort_period, "mort1") ~ "1-year"
    ), 
    per = per/100
  ) |>
  rename(mort_n = n, mort_per_rep = per) |>
  # for Park 2020 and Dai 2021 reported both in-hospital and 30-day
  mutate(
    refid_c = ifelse(study %in% c("Park 2020", "Dai 2021") & mort_period == "30-day", paste0(refid_c, "-30"), refid_c)
  ) |> 
  arrange(refid_c, arm_id) |>
  mutate(
    ref_arm_n = arm_n,
    ref_mort_n = mort_n
  ) |>
  group_by(refid_c) |>
  mutate(
    ref_arm_n = ifelse(row_number() > 1, NA, ref_arm_n),
    ref_mort_n = ifelse(row_number() > 1, NA, ref_mort_n)
  ) |>
  fill(ref_arm_n, ref_mort_n) |>
  mutate(
    ref_arm_n = ifelse(row_number() == 1, NA, ref_arm_n),
    ref_mort_n = ifelse(row_number() == 1, NA, ref_mort_n)
  ) |>
  ungroup() |> 
  left_join(study_char_dat |> select(refid, surgs_single_f), by = "refid") |>
  left_join(table_age_mn_med, by = c("refid", "arm_id")) |>
  left_join(asa_combine |> select(refid, arm_id, asa_ps_incl), by = c("refid", "arm_id")) |> 
  mutate(mort_percent = mort_n/arm_n,
         mort_period = factor(mort_period, levels = c("Hospital", "30-day", "90-day", "1-year"))) |>
  select(refid, refid_c, arm_id, year, study, study_l, arm_n, arm, asa_ps_incl, age_table, design_f_lab, mort_n, mort_percent, ref_mort_n, ref_arm_n, mort_period, mort_per_rep, surgs_single_f)

```

<font size = 4> `r table_ref()` Reported in-hospital, 30-day, and 1-year mortality from randomized clinical trials.</font>

```{r mortality_rct_gt}
#| eval: true
mortality_dat |>
  arrange(mort_period, surgs_single_f, year, study, arm_id) |>
  filter(str_detect(design_f_lab, "Rand")) |> 
  group_by(mort_period, study_l) |>
  mutate(
    surgs_single_f = as.character(surgs_single_f),
    study_l = ifelse(row_number() == 1, study_l, NA),
    study = ifelse(row_number() == 1, study, NA),
    across(c(surgs_single_f, asa_ps_incl,), ~ ifelse(row_number() > 1, NA, .x)),
    # bar = bar_prop(50, color_1),
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(mort_percent * 100, "#A93226"),
      .default = bar_prop(mort_percent * 100, "#969696")
    ),
  ) |>
  ungroup() |>
  mutate(
    # de Jonghe 2014 reported in hospital and 90-day
    # study_l = ifelse(refid == 16552 & arm_id == 1, "[de Jonghe 2014](evidence_tables.html#16552)", study_l),
    # surgs_single_f = ifelse(refid == 16552 & arm_id == 1, "Ortho", surgs_single_f),
    rd_ci = ifelse(!is.na(ref_mort_n), rd_per_ci_fun(mort_n, arm_n, ref_mort_n, ref_arm_n, digits = 1), "—"),
    mort_n_percent = n_per_fun(mort_n, arm_n, 1)
  ) |> 
  relocate(surgs_single_f, .before = asa_ps_incl) |> 
  relocate(mort_n_percent, .before = bar) |> 
  select(-mort_n) |> 
  arrange(year, refid_c, arm_id) |> 
  group_by(mort_period) |> 
  gt(id = "one") |> 
  cols_hide(c(refid, refid_c, arm_id, year, study, design_f_lab, mort_percent, ref_mort_n, ref_arm_n, mort_per_rep)) |>
  # row_group_order(groups = c("Hospital", "30-day", "90-day")) |> 
  cols_label(
    study_l = "Study",
    arm_n = "N  ",
    arm = "Arm",
    surgs_single_f = "Surgery",
    age_table = "Age",
    asa_ps_incl = "PS",
    mort_n_percent = "N (%)",
    bar = md("0 - 100%"),
    rd_ci = "RD (95% CI)"
  ) |> 
  fmt_markdown(columns = c(study_l, bar, age_table)) |>
  tab_spanner(label = "Mortality", columns = c(mort_n_percent, bar)) |> 
  tab_spanner(label = "ASA", columns = c(asa_ps_incl)) |> 
  row_group_order(groups = c("Hospital", "30-day", "1-year")) |> 
  gt_theme_mg() |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(study, arm, surgs_single_f))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(age_table, asa_ps_incl, rd_ci))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(study, arm, surgs_single_f, bar))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(rd_ci))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_column_labels(columns = c(arm_n, mort_n_percent))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_body(columns = c(mort_n_percent))) |>
  tab_style(style = cell_text(align = "center",  font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |> 
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n, arm, age_table, mort_n_percent), rows = str_detect(arm, "TIVA"))) |> 
  sub_missing(columns = everything(), rows = everything(), missing_text = "") |> 
  cols_width(
    study_l ~ px(140),
    arm_n ~ px(65),
    arm ~ px(70),
    surgs_single_f ~ px(95),
    age_table ~ px(100),
    asa_ps_incl ~ px(60),
    mort_n_percent ~ px(80),
    bar ~ px(100),
    rd_ci ~ px(145)
  ) |> 
  # opt_css(css = "#one .gt_column_spanner {border-bottom-style: hidden;}") |>
  tab_footnote("ASA PS: American Society of Anesthesiologists Physical Status; Vasc: vascular; GI/Abd: gastrointestinal/abdominal; RD: risk difference; NR: not reported.") |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table)))  
  # tab_footnote("Different lengths of follow-up from the same trial.", locations = cells_body(columns = study_l, rows = study %in% c("Su 2016", "Zhang 2019b"))) 

```

<font size = 4> `r table_ref()` Reported in-hospital and 30-day mortality from nonrandomized designs (all retrospective cohort studies).</font>

```{r mortality_nrsi_gt}
#| eval: true
mortality_dat |>
  arrange(mort_period, surgs_single_f, year, study, arm_id) |>
  filter(!str_detect(design_f_lab, "Rand")) |> 
  group_by(mort_period, study_l) |>
  mutate(
    surgs_single_f = as.character(surgs_single_f),
    study_l = ifelse(row_number() == 1, study_l, NA),
    study = ifelse(row_number() == 1, study, NA),
    across(c(surgs_single_f, asa_ps_incl,), ~ ifelse(row_number() > 1, NA, .x)),
    # bar = bar_prop(50, color_1),
    bar = case_when(
      str_detect(arm, "TIVA") ~ bar_prop(mort_percent * 100, "#A93226"),
      .default = bar_prop(mort_percent * 100, "#969696")
    ),
  ) |>
  ungroup() |>
  mutate(
    # de Jonghe 2014 reported in hospital and 90-day
    # study_l = ifelse(refid == 16552 & arm_id == 1, "[de Jonghe 2014](evidence_tables.html#16552)", study_l),
    # surgs_single_f = ifelse(refid == 16552 & arm_id == 1, "Ortho", surgs_single_f),
    rd_ci = ifelse(!is.na(ref_mort_n), rd_per_ci_fun(mort_n, arm_n, ref_mort_n, ref_arm_n, digits = 1), "—"),
    mort_n_percent = n_per_fun(mort_n, arm_n, 1)
  ) |> 
  relocate(surgs_single_f, .before = asa_ps_incl) |> 
  relocate(mort_n_percent, .before = bar) |> 
  select(-mort_n) |> 
  arrange(year, refid_c, arm_id) |> 
  group_by(mort_period) |> 
  gt(id = "one") |> 
  cols_hide(c(refid, refid_c, arm_id, year, study, design_f_lab, mort_percent, ref_mort_n, ref_arm_n, mort_per_rep)) |>
  # row_group_order(groups = c("Hospital", "30-day", "90-day")) |> 
  cols_label(
    study_l = "Study",
    arm_n = "N    ",
    arm = "Arm",
    surgs_single_f = "Surgery",
    age_table = "Age",
    asa_ps_incl = "PS",
    mort_n_percent = "N (%)",
    bar = md("0 - 100%"),
    rd_ci = "RD (95% CI)"
  ) |> 
  fmt_markdown(columns = c(study_l, bar, age_table)) |>
  tab_spanner(label = "Mortality", columns = c(mort_n_percent, bar)) |> 
  tab_spanner(label = "ASA", columns = c(asa_ps_incl)) |> 
  fmt_integer(use_seps = TRUE, sep_mark = ",") |>
  gt_theme_mg() |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(study, arm, surgs_single_f))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c(age_table, asa_ps_incl, rd_ci))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(study, arm, surgs_single_f, bar))) |>
  tab_style(style = cell_text(align = "center"), locations = cells_body(columns = c(rd_ci))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_column_labels(columns = c(arm_n, mort_n_percent))) |>
  tab_style(style = cell_text(align = "right"),  locations = cells_body(columns = c(mort_n_percent))) |>
  tab_style(style = cell_text(align = "center",  font = "IBM Plex Mono"), locations = cells_body(columns = c(asa_ps_incl))) |> 
  tab_style(style = list(cell_text(color = "#A93226")), locations = cells_body(columns = c(arm_n, arm, age_table, mort_n_percent), rows = str_detect(arm, "TIVA"))) |> 
  sub_missing(columns = everything(), rows = everything(), missing_text = "") |> 
  cols_width(
    study_l ~ px(140),
    arm_n ~ px(65),
    arm ~ px(70),
    surgs_single_f ~ px(95),
    age_table ~ px(100),
    asa_ps_incl ~ px(60),
    mort_n_percent ~ px(80),
    bar ~ px(100),
    rd_ci ~ px(145)
  ) |> 
  # opt_css(css = "#one .gt_column_spanner {border-bottom-style: hidden;}") |>
  tab_footnote("ASA PS: American Society of Anesthesiologists Physical Status; RD: risk difference; GI: gastrointestinal; Abd: abdominal (includes hepatic); Various: more that one procedure category.") |> 
  tab_footnote(md("Mean <u>Med</u> (SD)[Range]{IQR}."), locations = cells_column_labels(columns = c(age_table)))  
  # tab_footnote("Different lengths of follow-up from the same trial.", locations = cells_body(columns = study_l, rows = study %in% c("Su 2016", "Zhang 2019b"))) 

```

### *Pooled*

```{r mortality_hosp_30d_meta}
#| eval: true
mortality_rct_meta_dat <- mortality_dat |>
  filter(str_detect(design_f_lab, "Rand")) |> 
  filter(mort_period %in% c("Hospital", "30-day")) |>
  # exclude Dai 2021 hospital 30-day; retain 30-day
  filter(!(study == "Dai 2021" & mort_period == "Hospital")) |> 
  select(refid, study, arm, mort_n, arm_n, mort_period)

mortality_nrsi_meta_dat <- mortality_dat |>
  filter(!str_detect(design_f_lab, "Rand")) |> 
  filter(mort_period %in% c("Hospital", "30-day")) |>
  # exclude hospital retain 30-day
  filter(!(study %in% c("Jakobsen 2007", "Park 2020") & mort_period == "Hospital")) |> 
  select(refid, study, arm, mort_n, arm_n, mort_period)

pairwise_rct_mort_dat <- pairwise(
  treat = arm,
  event = mort_n,
  n = arm_n,
  studlab = study,
  allstudies = TRUE,
  data = mortality_rct_meta_dat,
  sm = "RR",
  keep.all.comparisons = TRUE
)

pairwise_nrsi_mort_dat <- pairwise(
  treat = arm,
  event = mort_n,
  n = arm_n,
  studlab = study,
  allstudies = TRUE,
  data = mortality_nrsi_meta_dat,
  sm = "RR",
  keep.all.comparisons = TRUE
)

```

<font size = 4> `r figure_ref()` Risk ratio for hospital or 30-day mortality (TIVA versus inhaled; randomized clinical trials). </font>

```{r mort_rct_meta}
#| echo: false
#| include: false

mort_meta_dat <- pairwise_rct_mort_dat |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  left_join(rob2_meta_dat, by = "refid") |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid") |> 
  select(study, year, event2, n2, event1, n1, surgs_single, D1:Overall, mort_period, refid)

# total_meta(mort_meta_dat)
# refid_meta_fun(mort_meta_dat)

mort_rct_meta <- metabin(event2, n2, event1, n1,
  data = mort_meta_dat,
  studlab = study,
  # cluster = refid,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  hakn = TRUE,
  prediction = FALSE,
  allstudies = FALSE,
)

# summary(plac_meta)

png("assets/kq4_mort_rct.png", width = 8.875, height = 3.4, units = "in", res = 300)
forest(mort_rct_meta,
  allstudies = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("RR", "(95% CI)", "Procedure"),
  just.addcols.right = "right",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  xlim = c(0.1, 20),
  xlab = "Favors: TIVA                       Inhaled       ",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  big.mark = ",",
)
dev.off()

```

![](assets/kq4_mort_rct.png){fig.align="left" width="66%"}

<br/>   

<font size = 4> `r figure_ref()` Risk ratio for hospital or 30-day mortality (TIVA versus inhaled; nonrandomized designs). </font>

```{r mort_nrsi_meta}
#| echo: false
#| include: false

mort_meta_dat <- pairwise_nrsi_mort_dat |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  left_join(robinsi_meta_dat, by = "refid") |> 
  left_join(surgs |> select(refid, surgs_single), by = "refid") |> 
  select(study, year, event2, n2, event1, n1, surgs_single, D1:Overall, mort_period, refid)

# total_meta(mort_meta_dat)
# refid_meta_fun(mort_meta_dat)

mort_nrsi_meta <- metabin(event2, n2, event1, n1,
  data = mort_meta_dat,
  studlab = study,
  # cluster = refid,
  sm = "RR",
  method = "MH",
  method.tau = "REML",
  hakn = TRUE,
  prediction = TRUE,
  allstudies = FALSE,
)

# summary(plac_meta)

png("assets/kq4_mort_nrsi.png", width = 9.1, height = 3.6, units = "in", res = 300)
forest(mort_nrsi_meta,
  allstudies = TRUE,
  label.e = "TIVA   ",
  label.c = "Inhaled   ",
  rightcols = c("effect", "ci", "surgs_single"),
  rightlabs = c("RR", "(95% CI)  ", "Procedure"),
  just.addcols.right = "right",
  digits.TE = 3,
  digits.tau2 = 1,
  overall.hetstat = TRUE,
  print.I2.ci = TRUE,
  prediction = TRUE,
  fs.xlab = 11,
  pooled.events = TRUE,
  digits = 2, 
  print.pval.Q = FALSE,
  xlim = c(0.1, 10),
  xlab = "Favors: TIVA                                     Inhaled       ",
  addrows.below.overall = 4,
  fs.hetstat = 10,
  big.mark = ",",
  text.addline1 = "Yoshimura 2022 naïve risk ratio, but identical to odds ratio reported respecting propensity matching."
)
dev.off()

```

![](assets/kq4_mort_nrsi.png){fig.align="left" width="66%"}

## **Risk of Bias**

### Randomized

<font size = 4> `r figure_ref()` Summary risk of bias assessment for randomized clinical trials. </font>

```{r rob2_summary_overall, fig.height = 3, out.width = "60%"}
rob_temp_dat <- rob2_dat |>
  filter(!is.na(Study) & refid %in% kq4_refid) |> 
  select(-refid)

rob_summary(rob_temp_dat, tool = "ROB2", colour = "colourblind", weighted = FALSE)
```

<font size = 4> `r figure_ref()` Risk of bias assessments for randomized clinical trials. </font>

```{r rob_overall_study, out.width = "55%", fig.height = 7}
rob_traffic_light(rob_temp_dat, psize = 4, tool = "ROB2", colour = "colourblind")
```

### Nonrandomized

<font size = 4> `r figure_ref()` Summary risk of bias assessment for nonrandomized studies. </font>

```{r nrsi_summary_overall, fig.height = 3, out.width = "60%"}
robinsi_temp_dat <- robinsi_dat |>
  filter(!is.na(Study) & refid %in% kq4_refid) |> 
  select(-refid)

rob_summary(robinsi_temp_dat, tool = "ROBINS-I", colour = "colourblind", weighted = FALSE)
```

<font size = 4> `r figure_ref()` Risk of bias assessments for nonrandomized studies. </font>

```{r nrsi_overall_study, out.width = "55%", fig.height = 4.5}
rob_traffic_light(robinsi_temp_dat, psize = 4, tool = "ROBINS-I", colour = "colourblind")
```

## **References** {#references}
