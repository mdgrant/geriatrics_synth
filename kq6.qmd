---
title: "K6: Delirium Prophylaxis"
editor: source
toc-title: "Delirium Prophylaxis"
toc-location: "left"
toc-depth: 4
toc_float: 
  collapsed: true
tbl-cap-location: "top"
page-layout: full
css: styles.css
tables:
      style: Table
      caption:
        pre: "Table "
        sep: " -- "
bibliography: "bib/kq6.bib"
csl: jama.csl
link-citations: no
nocite: '@*'
---

## Key Question

Among \[geriatric\] patients 65 years or older undergoing surgery and anesthesia, do dexmedetomidine, ketamine, ramelteon, or melatonin administered during the perioperative period decrease the risk of postoperative delirium or other adverse cognitive outcomes?

<!-- setup -------------------------------------------- (2022-12-24 16:56) @ --->

```{r read_data}
#| include: false
source("code/readfiles_geri_2022-11-16.R")
study_char_dat <- data_kq(study_char_dat, kq6_refid)
study_arm_dat <- data_kq(study_arm_dat, kq6_refid)
contin_dat <- data_kq(contin_dat, kq6_refid)
dichot_dat <- data_kq(dichot_dat, kq6_refid)
likert_dat <- data_kq(likert_dat, kq6_refid)
```

<!-- ## Outcome Importance Rankings -->

<!-- <font size = 4> `r table_ref()` Rankings of the 5 most important outcomes (11 respondents). </font> -->

```{r, outcome_priority}
#| include: true
#| eval: false
outcome_dat <- rankings("KQ6")
outcome_tab(outcome_dat, 11)
```

### Reporting Frequency

<font size = 4> `r table_ref()` Dichotomous outcomes. </font>

```{r dichot_outcome_freq}
dichot_freq_fun(dichot_dat)
```

<font size = 4> `r table_ref()` Continuous outcomes. </font>

```{r cont_outcome_freq}
contin_freq_fun(contin_dat)
```

<font size = 4> `r table_ref()` Likert-type outcomes. </font>

```{r likert_outcome_freq}
likert_freq_fun(likert_dat)
```

## Included Studies

<font size = 4> `r table_ref()` Number of studies by design. </font>

<!-- Number of studies by design ----------------------- (2022-12-28 10:44) @ --->

```{r}
study_char_dat |>
  filter(refid %in% kq6_refid) |>
  select(refid, study, design_f_lab) |>
  group_by(design_f_lab, .drop = TRUE) |>
  summarise(total = n()) |>
  adorn_totals("row") |>
  gt(id = "one") |>
  cols_label(design_f_lab = "Design", total = "Studies") |>
  cols_width(
    # design_f_lab ~ px(200),
    design_f_lab ~ "1.8in",
    total ~ ".5in"
  ) |>
  gt_theme_mg() |> 
  tab_style(
    style = list(
      cell_fill(color = "#E4F3FE"),
      cell_text(weight = "bold"),
      cell_borders(sides = c("top", "bottom"), color = "#9A9EA1", style = "solid", weight = px(1.3))
    ),
    locations = cells_body(
      rows = design_f_lab == "Total"
    )
  )
```

### Design, centers, country, surgery

<font size = 4> `r table_ref()` Study design, enrollment, centers, country, and surgery (see [References](#references) for citations). </font>

<!-- design, enrollment, centers ... ------------------- (2022-12-28 10:44) @ --->

```{r drugs_by_arm}
#| message: false
# DATA: drugs_dat <- study_arm_dat include drug arm data; adds kq5/6 arms
## drugs; from kq6, add kq5 arm drugs ----------------- (2023-01-16 13:46) @----
# drugs for kq5 studies; needed to fill in "missings" for kq6 arms coded as kq5 arms
kq5_drug_by_arm <- read_csv("data/kq5_drug_by_arm.csv") |> 
  rename(drug = drug_f) |> 
  mutate(drug = as.character(drug)) |> 
  select(refid, arm_id, drug, control_desc)

drugs_dat <- study_arm_dat |>
  select(refid, design_f_lab, study, study_l, study_id, arm_id, arm_n, arm_kq6_proph_meds, kq6_control_desc:kq6_notes, multiple_kq) |>
  rename_with(~ str_replace(., "kq6_", ""), everything()) |>
  rename_with(~ str_replace(., "dex_", "dexmed_"), everything()) |>
  mutate(
    drug = case_when(
      !is.na(dexmed) ~ dexmed,
      !is.na(ketamine) ~ ketamine,
      !is.na(melatonin) ~ melatonin,
      !is.na(ramelteon) ~ ramelteon,
      # !is.na(gabapentin) ~ gabapentin, # all missubg
      !is.na(none) ~ none
    ),
    drug = str_replace(drug, "kq6_", ""),
    drug = firstup(drug)
  ) |>
  relocate(drug, .after = arm_n) |>
  # update drug and control description for "kq5" arms
  left_join(kq5_drug_by_arm, by = c("refid", "arm_id")) |>
  mutate(drug = coalesce(drug.x, drug.y),
         control_desc = coalesce(control_desc.x, control_desc.y),
         control_desc = firstup(control_desc)) |>
  select(-matches("\\.x|\\.y")) |> 
  mutate(
    drug_f = fct(drug,
      levels = c(
        "Dexmedetomidine",
        "Ketamine",
        "Melatonin",
        "Ramelteon",
        "Midazolam",
        "Haloperidol",
        "None",
        "Placebo",
        "Other"
      )
    ),
    drug_f = fct_collapse(drug_f, "Control" = c("None", "Placebo", "Other")),
  ) |>
  group_by(refid) |>
  mutate(
    drug_study = case_when( # study drug
      if_any(drug_f, ~ . == "Dexmedetomidine") ~ "Dexmedetomidine",
      if_any(drug_f, ~ . == "Ketamine") ~ "Ketamine",
      if_any(drug_f, ~ . == "Melatonin") ~ "Melatonin",
      if_any(drug_f, ~ . == "Ramelteon") ~ "Ramelteon"
      # TRUE ~ NA_character_ for verification
    ),
    drug_study = fct(drug_study, levels = c("Dexmedetomidine", "Ketamine", "Melatonin", "Ramelteon"))
  ) |>
  ungroup() |>
  relocate(c(drug, drug_f, drug_study), .after = arm_id) |>
  relocate(c(other_spec, interv_desc, control_desc), .after = last_col()) |> 
  arrange(refid, drug_study) |>
  fill(drug_study) |>
  arrange(refid, arm_id)

```

```{r included_table}
#| echo: false
included_dat <- study_char_dat |>
  select(refid, starts_with("design"), study_l, year, n_enroll, n_analyze, centers, country, non_vh_hdi, starts_with("surg")) |>
  # select(refid, study, starts_with("surg")) |> # compile surgeries
  rename_with(~ gsub("surg_", "", .x, fixed = TRUE)) |>
  mutate(across(various:other, ~ gsub("surg_", "", .x, fixed = TRUE)),
    ortho_any = ifelse(if_any(contains("ortho"), ~ !is.na(.x)), "ortho", NA),
    opth = ifelse(str_detect(other_desc, "[Cc]ataract") | !is.na(opth), "optho", opth),
    gi = ifelse(!is.na(colorectal) | !is.na(gi_other) | !is.na(abdominal), "GI/Abdominal", NA),
    across(c(various, cardiac, gyn, general, headneck, hepatic, neuro, opth, oralmax, ortho_any, ent, plastic, thoracic, urol, vasc, other), ~ firstup(.x)),
  ) |>
  unite("surgs", various, cardiac, gyn, gi, general, headneck, hepatic, neuro, opth, oralmax, ortho_any, ent, plastic, thoracic, urol, vasc, other, sep = "|", remove = FALSE, na.rm = TRUE) |>
  select(-c(various, abdominal, cardiac, colorectal, gyn, gi, general, headneck, hepatic, neuro, opth, oralmax, ortho_any, ent, plastic, thoracic, urol, vasc, other, design_other, gi_other, starts_with("ortho"), list, other_desc, starts_with("hip"))) |>
  mutate(
    surgs = ifelse(str_count(surgs, "\\|") > 3, "Various", surgs)
  ) |>
  left_join(drugs_dat |> group_by(refid) |> slice(1) |> ungroup() |> select(refid, drug_study), by = "refid") |>
  # create new factor for table as gt not arranging properly
  mutate(
    drug_design = fct(paste0(drug_study, " - ", design_f_lab),
      levels = c(
        "Dexmedetomidine - Randomized Clinical Trial",
        "Ketamine - Randomized Clinical Trial",
        "Ketamine - Prospective Cohort",
        "Melatonin - Randomized Clinical Trial",
        "Ramelteon - Randomized Clinical Trial",
        "Ramelteon - Before-After/Time Series"
      )
    )
  ) |>
  arrange(drug_design, surgs, study_l) |>
  select(refid, study_l, centers, n_enroll, country, drug_design, surgs, non_vh_hdi)

included_dat |>
  group_by(drug_design) |>
  gt(id = "one") |>
  cols_label(
    refid = "ID",
    study_l = "Study",
    n_enroll = "Enrolled",
    country = "Country",
    centers = "Centers",
    surgs = "Surgery"
   ) |>
  cols_hide(non_vh_hdi) |>
    fmt_markdown(columns = c(study_l)) |> 
  cols_width(
    refid ~ px(60),
    study_l ~ px(165),
    centers ~ px(40),
    n_enroll ~ px(55),
    country ~ px(100),
    surgs ~ px(220)
  ) |> 
  # opt_horizontal_padding(scale = 2) |>
  tab_footnote(
    footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    locations = cells_column_labels(columns = country)
  ) |>
  tab_footnote(
    footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."),
    locations = cells_body(columns = country, rows = !is.na(non_vh_hdi))
  ) |>
  tab_footnote(
        footnote = md("Various indicates more than 4 different types of surgery."),
        locations = cells_column_labels(columns = surgs)
      ) |>
  gt_theme_mg() |>
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_column_labels(
      columns = c("refid")
    )
  ) |> 
  opt_footnote_marks(marks = "letters") |> 
  tab_footnote("GI: gastrointestinal; Ortho: orthopedic; Neuro: neurological; Oralmax: oral maxillofacial; Vasc: vascular.")

```

### Interventions and Comparators

#### Dexmedetomidine

<font size = 4> `r table_ref()` Dosing and comparators in dexmedetomidine randomized clinical trials. </font>

```{r dex_compare}
#| eval: true
# dex studies
dex_refid <- drugs_dat |> 
  filter(drug == "Dexmedetomidine") |> 
  pull(refid)

# by arm
dex_by_arm <- drugs_dat |>
  filter(refid %in% dex_refid) |>
  mutate(year = str_extract(study, "\\d{4}")) |>
  select(refid:arm_proph_meds, matches("^proph_|dexmed"), year, interv_desc, control_desc, other_spec) |>
  # timing
  rename_with(~ gsub("proph_med_", "", .x, fixed = TRUE)) |>
  rename_with(~ gsub("dexmed_", "", .x, fixed = TRUE)) |>
  mutate(
    across(pre:unspec, ~ gsub("proph_med_", "", .x, fixed = TRUE)),
    across(pre:unspec, ~ firstup(.x)),
    pre = ifelse(!is.na(pre), "Preop", NA),
    intra = ifelse(!is.na(intra), "Intraop", NA),
    # to order drugs
    drug = fct(drug, levels = c("Dexmedetomidine", "Midazolam", "Placebo", "Other", "None"))
  ) |>
  unite("time_admin", c(pre:unspec), sep = "|", na.rm = TRUE, remove = FALSE) |>
  relocate(time_admin, .after = arm_n) |>
  # dosing
  mutate(
    maintain_range = ifelse(!is.na(maintain_low + maintain_up), paste0(maintain, " (", maintain_low, "–", maintain_up, ")"), maintain),
    maintain_range = str_replace(maintain_range, "NA ", ""),
    loading = ifelse(loading == "0", "", loading),
    loading = ifelse(loading == "1", "1.0", loading),
    loading = ifelse(loading == "1000", "1.0", loading),
    loading = str_replace(loading, "-1$", "-1.0")
  ) |>
  arrange(year, refid, desc(drug)) |>
  select(study_l, arm_n, drug, loading, maintain_range, postdose, time_admin, year, refid, design_f_lab)

```

```{r dex_table}
dex_by_arm |>
  group_by(refid) |>
  mutate(study_l = ifelse(row_number() > 1, "", study_l)) |>
  ungroup() |>
  group_by(design_f_lab) |> 
  gt(id = "one") |>
  cols_hide(c(year, refid)) |>
  cols_label(
    study_l = "Study",
    arm_n = "N",
    drug = "Comparator",
    loading = "Loading",
    maintain_range = md("  Maintenance<br/>(range) per hr"),
    postdose = md("Postop"),
    time_admin = "Timing"
    # drug_f = md("Comparator <br/> Detail")
  ) |>
  tab_spanner(
    label = "Dexmedetomidine Dose mcg/kg",
    columns = c(
      loading, maintain_range, postdose
    )
  ) |>
  fmt_markdown(columns = c(study_l)) |>
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_column_labels(
      columns = c(drug:time_admin)
    )
  ) |>
  tab_style(
    style = cell_text(align = "center"),
    locations = cells_body(
      columns = c(loading, maintain_range, postdose)
    )
    ) |> 
    tab_style(
    style = cell_text(align = "left"),
    locations = cells_body(
      columns = c(study_l, arm_n, drug, time_admin)
    )
  ) |>
  tab_style(
    style = list(
      cell_text(color = "maroon")
    ),
    locations = cells_body(
      columns = c(arm_n:time_admin),
      rows = drug == "Dexmedetomidine"
    )
  ) |>
  sub_missing(
  columns = everything(),
  rows = everything(),
  missing_text = ""
) |> 
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(40),
    drug ~ px(130),
    loading ~ px(100),
    maintain_range ~ px(120),
    postdose ~ px(100),
    time_admin ~ px(160)
  ) |> 
  tab_footnote("Preop: preoperative; Induct: induction; Intraop: intraoperative; Postop: postoperative.")
  # |>  tab_info()

```

#### Ketamine

<font size = 4> `r table_ref()` Dosing and comparators in ketamine studies. </font>

```{r ket_compare}
#| eval: true
# ketamine studies
ket_refid <- drugs_dat |> 
  filter(drug == "Ketamine") |> 
  pull(refid)

# by arm
ket_by_arm <- drugs_dat |>
  filter(refid %in% ket_refid) |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  select(refid:arm_proph_meds, matches("^proph_|keta"), year, interv_desc, control_desc, other_spec) |>
  # timing
  rename_with(~ gsub("proph_med_", "", .x, fixed = TRUE)) |>
  rename_with(~ gsub("ketamine_", "", .x, fixed = TRUE)) |>
  mutate(
    across(pre:unspec, ~ gsub("proph_med_", "", .x, fixed = TRUE)),
    across(pre:unspec, ~ firstup(.x)),
    pre = ifelse(!is.na(pre), "Preop", NA),
    intra = ifelse(!is.na(intra), "Intraop", NA),
   # to order drugs
   drug = fct(drug, levels = c("Ketamine", "Haloperidol", "Placebo", "Other", "None"))
  ) |>
  unite("time_admin", c(pre:unspec), sep = "|", na.rm = TRUE, remove = FALSE) |> 
  relocate(time_admin, .after = arm_n) |> 
  # dosing
 arrange(year, refid, desc(drug)) |> 
    select(study_l, arm_n, drug, dose, dose_iv, time_admin, year, refid, design_f_lab)

```

```{r ket_table}
ket_by_arm |>
  group_by(refid) |>
  mutate(study_l = ifelse(row_number() > 1, "", study_l)) |>
  ungroup() |>
  group_by(design_f_lab) |> 
  gt(id = "one") |>
  cols_hide(c(year, refid)) |>
  cols_label(
    study_l = "Study",
    arm_n = "N",
    drug = "Comparator",
    dose = md("  Dose <br/> (mg/kg)"),
    dose_iv = md("Maintenance <br/>   (mg/kg)"),
    time_admin = "Timing"
  ) |>
  fmt_markdown(columns = c(study_l)) |>
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_column_labels(
      columns = c(drug:time_admin)
    )
  ) |>
  tab_style(
    style = cell_text(align = "right"),
    locations = cells_body(
      columns = c(arm_n)
    )
  ) |>
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_body(
      columns = c(study_l, drug, dose, dose_iv, time_admin)
    )
  ) |>
  tab_style(
    style = list(
      cell_text(color = "maroon")
    ),
    locations = cells_body(
      columns = c(arm_n:time_admin),
      rows = drug == "Ketamine"
    )
  ) |>
  sub_missing(
    columns = everything(),
    rows = everything(),
    missing_text = ""
  ) |>
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(40),
    drug ~ px(130),
    dose ~ px(100),
    dose_iv ~ px(120),
    time_admin ~ px(160)
  ) |>
  fmt_number(
    columns = dose,
    drop_trailing_zeros = TRUE,
  ) |>
  tab_footnote(
    footnote = md("S-Ketamine"),
    locations = cells_body(
      columns = drug,
      rows = arm_n %in% c(223, 227)
    )
  ) |>
  tab_footnote("Preop: preoperative; Induct: induction; Intraop: intraoperative; Postop: postoperative; Unspec: unspecified.")

# |>  tab_info()
# tab_source_note(footnote)

```

#### Melatonin and Ramelteon

<font size = 4> `r table_ref()` Melatonin and ramelteon studies comparators and dosing. </font>

```{r melatonin_ramelteon_compare}
#| eval: true
# melatonin ramelteon studies
mel_ram_refid <- drugs_dat |> 
  filter(drug %in% c("Melatonin", "Ramelteon")) |> 
  pull(refid)

# by arm
mel_ram_by_arm <- drugs_dat |>
  filter(refid %in% mel_ram_refid) |> 
  mutate(year = str_extract(study, "\\d{4}")) |> 
  select(refid:arm_proph_meds, matches("^proph_|mela|ramel"), year, interv_desc, control_desc, other_spec, study_id) |>
  # timing
  rename_with(~ gsub("proph_med_", "", .x, fixed = TRUE)) |>
  mutate(
    across(pre:unspec, ~ gsub("proph_med_", "", .x, fixed = TRUE)),
    across(pre:unspec, ~ firstup(.x)),
    pre = ifelse(!is.na(pre), "Preop", NA),
    intra = ifelse(!is.na(intra), "Intraop", NA),
    dose = coalesce(melatonin_dose, ramelteon_dose),
    days = coalesce(melatonin_days, as.character(ramelteon_numberdoses)),
    dose = ifelse(!is.na(dose), paste0(dose, "mg × ", days), dose),
   # to order drugs
   drug = fct(drug, levels = c("Melatonin", "Ramelteon", "Midazolam", "Placebo", "Other", "None"))
  ) |>
  unite("time_admin", c(pre:unspec), sep = "|", na.rm = TRUE, remove = FALSE) |> 
  relocate(time_admin, .after = arm_n) |> 
  # dosing
 arrange(year, refid, desc(drug)) |> 
    select(study_l, arm_n, drug, drug_f, drug_study, dose, time_admin, year, refid, study_id, design_f_lab, interv_desc, control_desc)

```

```{r melatonin_ramelteon_table}
mel_ram_by_arm |>
  mutate(groups = paste0(drug_study, " - ", design_f_lab)) |> 
  group_by(refid) |>
  mutate(study_l = ifelse(row_number() > 1, "", study_l)) |>
  ungroup() |>
  group_by(groups) |> 
  gt(id = "one") |>
  row_group_order(groups = c("Melatonin - Randomized Clinical Trial", "Ramelteon - Randomized Clinical Trial", "Ramelteon - Before-After/Time Series")) |> 
  cols_hide(c(year, refid, drug_f, design_f_lab, drug_study, study_id, interv_desc, control_desc)) |>
  cols_label(
    study_l = "Study",
    arm_n = "N",
    drug = "Comparator",
    dose = md("Dosing"),
    time_admin = "Timing"
  ) |>
  fmt_markdown(columns = c(study_l)) |>
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_column_labels(
      columns = c(drug:time_admin)
    )
  ) |>
  tab_style(
    style = cell_text(align = "right"),
    locations = cells_body(
      columns = c(arm_n)
    )
  ) |>
  tab_style(
    style = cell_text(align = "left"),
    locations = cells_body(
      columns = c(study_l, drug, dose, time_admin)
    )
  ) |>
  tab_style(
    style = list(
      cell_text(color = "maroon")
    ),
    locations = cells_body(
      columns = c(arm_n:time_admin),
      rows = drug %in% c("Melatonin", "Ramelteon")
    )
  ) |>
  sub_missing(
    columns = everything(),
    rows = everything(),
    missing_text = ""
  ) |>
  gt_theme_mg() |>
  cols_width(
    study_l ~ px(165),
    arm_n ~ px(40),
    drug ~ px(130),
    dose ~ px(100),
    time_admin ~ px(120)
  ) |>
  # fmt_number(
  #   columns = dose,
  #   drop_trailing_zeros = TRUE,
  # ) |>
  # tab_footnote(
  #   footnote = md("Test"),
  #   locations = cells_body(
  #     columns = drug,
  #     rows = study_id == "Gupta 2019-2"
  #   )
  # ) |>
  tab_footnote("NS: not stated; Preop: preoperative; Postop: postoperative.")

# |>  tab_info()
# tab_source_note(footnote)

```


## Outcomes

### Delirium 

```{r delirium_incidence}
#| eval: false
# reported on days vs incidence proportion
dichot_dat |>
  select(refid, study, matches("^deli.*time")) |>
  filter(if_any(starts_with("deli"), ~ !is.na(.))) |>
  mutate(
    deli_times = ifelse(if_any(starts_with("delirium"), ~ !is.na(.)), "Yes", "No"),
    deli_total = ifelse(!is.na(delitotal_time), "Reported", "Not Reported")
  ) |>
  select(refid, study, deli_times, deli_total) |>
  group_by(refid) |>
  slice(1) |>
  ungroup() |>
  # use gt summary
  select(-refid, -study) |>
  tbl_cross(
    percent = "col",
    label = list(deli_times ~ "At Days", deli_total ~ "Incidence Proportion")
  ) |>
   modify_column_alignment(columns = everything(), align = "right") |> 
  as_gt(id = "one") |>
  gt_theme_mg()
  # use tabyl
  # tabyl(deli_times, deli_total) |> 
  # adorn_totals(c("row", "col")) |> 
  # adorn_percentages("row") |> 
  # adorn_pct_formatting(rounding = "half up", digits = 1) |> 
  # adorn_ns()

```


## References {#references}
