---
title: "Expanded Preoperative Evaluation & <br/> Postoperative Delirium Screening"
editor: source
toc-title: "Expanded Preoperative Evaluation and Postoperative Delirium Screening"
toc-location: "left"
cap-location: "top"
toc-depth: 4
page-layout: full
css: styles.css
tables:
      style: Table
      caption:
        pre: "Table "
        sep: " -- "
bibliography: "bib/kq18.bib"
csl: jama.csl
link-citations: false
nocite: '@*'
---

## Key Questions

Among older patients anticipating surgery and anesthesia, does expanded preoperative evaluation (e.g., for frailty, cognitive impairment, functional status, or psychosocial issues) lead to improved postoperative outcomes?

Does screening older patients for delirium in the post anesthesia care unit improve postoperative outcomes?

```{r, read_data}
#| include: false
source("code/load_data.R")
```

```{r, data}
# note working file not renamed
study_char_dat <- study_char_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)

study_arm_dat <- study_arm_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)

dichot_dat <- dichot_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)

contin_dat <- contin_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)

likert_dat <- likert_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)


```

## **Outcome Importance Rankings**

### Expanded Preoperative Evaluation

<font size = 4> `r table_ref()` Rankings of the 5 most important outcomes (11 respondents). </font>

```{r, outcome_priority_kq1}
#| include: true
#| eval: true
outcome_dat <- rankings("KQ1")
outcome_tab(outcome_dat, 11)
```

### Postoperative Delirium Screening

<font size = 4> `r table_ref()` Rankings of the 5 most important outcomes (11 respondents). </font>

```{r, outcome_priority_kq8}
#| include: true
#| eval: true
outcome_dat <- rankings("KQ8")
outcome_tab(outcome_dat, 11)
```

## **Outcomes Reported**

<font size = 4> `r table_ref()` Dichotomous or count outcomes. </font>

```{r dichot_outcome_freq}
dichot_freq_fun(dichot_dat, "ADL: activities of daily living; NCR: neurocognitive recovery; NCD: neurocognitive disorder; QoR: quality of recovery; ")
```

<font size = 4> `r table_ref()` Continuous outcomes. </font>

```{r cont_outcome_freq}
contin_freq_fun(contin_dat)
```

<font size = 4> `r table_ref()` Likert or ordinal outcomes. </font>

```{r likert_outcome_freq}
likert_freq_fun(likert_dat, "ADL: activities of daily living; NCR: neurocognitive recovery; NCD: neurocognitive disorder; QoR: quality of recovery; ")
```

## **Included Studies ⦁**

<font size = 4> `r table_ref()` Number of studies by design. </font>

```{r studies_design}
# CODE: study design table — design and number; no duplicate counting
study_char_dat |>
  arrange(year) |> 
  group_by(linked_references_all_refid) |> # count 1 for multiple pubs from single study
  slice(1) |> 
  ungroup() |> 
  # select(refid, study, linked_references_all_refid, design_f_lab) |> # to check studies > 1 report
  select(refid, study, design_f_lab) |>
  group_by(design_f_lab, .drop = TRUE) |>
  summarise(total = n()) |>
  adorn_totals("row") |>
  gt(id = "one") |>
  cols_label(design_f_lab = "Design", total = "Studies") |>
  cols_width(
    # design_f_lab ~ px(200),
    design_f_lab ~ "1.8in",
    total ~ ".5in"
  ) |>
  gt_theme_mg() |> 
  tab_style(
    style = list(
      cell_fill(color = "#E4F3FE"),
      cell_text(weight = "bold"),
      cell_borders(sides = c("top", "bottom"), color = "#9A9EA1", style = "solid", weight = px(1.3))
    ),
    locations = cells_body(
      rows = design_f_lab == "Total"
    )
  ) |> 
  tab_style(
    style = list(
      cell_text(align = "left")),
      locations = cells_body(
        columns = design_f_lab
      )
    )  |> 
  tab_footnote("Studies with multiple publications counted only once (applied to 2 studies with 2 publications).")
```

### Design, centers, country, and surgery

<font size = 4> `r table_ref()` Study design, enrollment, centers, country, and surgery (see [References](#references) for citations). </font>

```{r included_studies_table}
#| echo: false
included_dat <- study_char_dat |>
  mutate(study_l = study_l_w_linked) |>
  select(refid, starts_with("design"), study_l, year, n_enroll, n_analyze, centers, country, non_vh_hdi) |>
  left_join(surgs |> select(refid, surgs), by = "refid") |>
  mutate(
    surgs = ifelse(str_count(surgs, "\\|") > 3, "Various", surgs),
    # edit levels by kq
    surgs = factor(surgs, levels = c("Ortho", "Urol", "GI/Abdominal", "Neuro", "Neuro|Vasc", "Cardiac", "Gyn", "Gyn|Ortho|Urol|Vasc", "Headneck", "Ophtho", "Other", "Spine", "Various", "Vasc"))
  ) |>
  arrange(design_f, surgs, study_l) |>
  select(refid, design_f, study_l, centers, n_enroll, country, surgs, non_vh_hdi)

included_dat |>
  gt(id = "one") |>
  cols_label(
    refid = "ID",
    study_l = "Study",
    n_enroll = "Enrolled",
    country = "Country",
    centers = "Centers",
    surgs = "Surgery"
   ) |>
  cols_hide(c(non_vh_hdi, design_f)) |>
    fmt_markdown(columns = c(study_l)) |> 
  cols_width(
    refid ~ px(60),
    study_l ~ px(220),
    centers ~ px(60),
    n_enroll ~ px(60),
    country ~ px(100),
    surgs ~ px(150)
  ) |> 
  # opt_horizontal_padding(scale = 2) |>
  sub_missing(columns = everything(), missing_text = " — ") |>
  gt_theme_mg() |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c("refid"))) |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(surgs))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(surgs))) |>
  opt_footnote_marks(marks = "letters") |> 
  tab_footnote(footnote = md("Various indicates more than 4 different types of surgery."), locations = cells_column_labels(columns = surgs)) |>
  tab_footnote(footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."), 
               locations = cells_column_labels(columns = country)) |>
  tab_footnote(footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."), 
               locations = cells_body(columns = country, rows = !is.na(non_vh_hdi))) |>
  # tab_footnote(footnote = "Studies examining drugs not directly relevant to recommendations but potentially relevant to the evidence space (eg, a connected network) were included.",  locations = cells_row_groups(groups = )) |> 
  tab_footnote("GI: gastrointestinal; Ortho: orthopedic; Neuro: neurological; Oralmax: oral maxillofacial; Vasc: vascular.")

```

#### Country Summary

<font size = 4> `r table_ref()` Summary of studies by country where conducted. </font>

```{r country}
#| echo: false
study_char_dat |>
  mutate(linked_references = ifelse(is.na(linked_references), refid, linked_references)) |> 
  slice(1, .by = linked_references) |>
  select(country) |>
  tbl_summary(
    sort = everything() ~ "frequency",
    label = list(country ~ "Country")
  ) |>
  modify_header(label ~ "") |> 
  as_gt(id = "one") |> 
  gt_theme_mg()

```

## **Comparators**

```{r}
#| eval: false
expanded_dat <- study_arm_dat |>
  filter(refid %in% kq1_refid) |>
  select(refid, year, study, study_l, arm_id, kq1_eras, gen_blood, gen_comp, gen_multi, gen_comorbid, gen_nutrition, gen_other, gen_unspec, kq1_frail, kq1_cog, kq1_phys_func, kq1_psych, pt_nutr, pt_mobility, pt_surgery, pt_social, pt_other, staff_comorbid, staff_inappmed, staff_geriatrician, staff_multidisc, staff_supplement, staff_treatplan, staff_other) |>
  mutate(
    across(gen_blood:gen_unspec, ~ notna_to_x(.x, symbol = "\U2713")),
    across(kq1_frail:kq1_psych, ~ notna_to_x(.x, symbol = "\U25CF")),
    across(pt_nutr:pt_other, ~ notna_to_x(.x, symbol = "\U25CB")),
    across(staff_comorbid:staff_other, ~ notna_to_x(.x, symbol = "\UFFED")),
    kq1_eras = notna_to_x(kq1_eras, symbol = "x")
  )

complicate_data <- readxl::read_xlsx("data/CHOComplicationList_012521.xlsx", range = "A5:P35") %>% 
  clean_names() %>% 
  mutate(across(c(ssi:pulm, rena:anastomotic_leak, bleed:oth_infect), ~ recode(., X = "\U00D7")))

compl_names <- c("SSI", "GU", "CV", "GI", "Pulm", "Anes", "Renal", "Meds", "Leak", "Op", "Bleed", "TE", "CVD", "Infect")
cats <-  c("Surgical Site Infection", "Genitourinary", "Cardiovascular", "Gastrointestinal", "Respiratory", "Anesthesia", "Fluid/electrolyte/renal", "Medication", "Anastomotic leak", "Intraoperative", "Bleeding", "Thromboembolic", "Cerebrovascular", "Other infection")
compl_foot <- paste0(compl_names, ": ", tolower(cats), collapse = "; ")
compl_foot <- paste0(compl_foot, ".")


library(kableExtra)
opt_font <-  c("Source Sans Pro")
opt_boot <- c("striped", "hover", "condensed")


dt <- mtcars[1:5, 1:6]

kbl(dt, booktabs = T, align = "c") %>%
kable_styling(latex_options = "striped", full_width = F) %>%
row_spec(0, angle = -45)

dt <- mtcars[1:5, 1:6]

kbl(expanded_dat, booktabs = T, align = "c") %>%
kable_styling(latex_options = "striped", full_width = F) |> 
row_spec(0, angle = -45) |> 
# kable_styling(bootstrap_options = opt_boot) |> 
kable_classic(full_width = FALSE, html_font = opt_font) 


expanded_dat |>
  select(study, kq1_eras:gen_unspec) |>
  kbl(booktabs = T, align =  c("l", rep("c", 8)), escape = FALSE, col.names = c(rep(" ", 9))) |> 
  column_spec(1, width = "12em") |> 
  column_spec(2:9, width = "5em") |> 
  # row_spec(0, angle = -90) |> 
  add_header_above(c("Study", "kq1_eras", "gen_blood", "gen_comp", "gen_multi", "gen_como", "gen_nutri", "gen_other", "gen_unspe"),  line = FALSE, angle = -90, line_sep = 1,
                   extra_css =  "padding-top: 60px; line-height: 5; text-align: center;") |> 
  kable_styling(bootstrap_options = opt_boot) |> 
  kable_classic(full_width = FALSE, html_font = opt_font) 


, position = "right", "hover")


kable_styling(latex_options = "striped", full_width = F) %>%
  

  #add_header_above(c(" " = 1, "Surgical Site Infection" = 1, "Genitourinary" = 1, "Cardiovascular" = 1, "Gastrointestinal" = 1, "Respiratory" = 1, "Anesthesia" = 1, "Fluid/electrolyte/renal" = 1, "Medication" = 1, "Anastomotic leak" = 1, "Intraoperative" = 1, "Bleeding" =1, "Thromboembolic" = 1, "Cerebrovascular" = 1, 	"Other infection" = 1), line = FALSE, angle = -90, align = "initial", line_sep = 20) %>% 
  # add_header_above(c(" " = 1, compl_names), line = FALSE, angle = -45, align = "c", line_sep = 1) %>% 
  # kable_classic(full_width = TRUE, html_font = opt_font, position = "right", "hover") %>% 

column_spec(1, width = "9em") %>%  
  column_spec(2:15, width = "2em") %>% 
  pack_top(., "Adult, Surgical", 1, 30) %>% 
  pack_sub(., "RCT", 1, 26) %>%
  pack_sub(., "Nonrandomized Trial", 27, 28) %>%
  pack_sub(., "Prospective Cohort", 29, 29) %>%
  pack_sub(., "Case-Control", 30, 30) %>%
  footnote(general = compl_foot,
           # alphabet = c(""),
           general_title = "",  
           footnote_as_chunk = FALSE)
table_n <- tab_inc()

expanded_dat |>
  select(study, kq1_eras:gen_unspec) |>
  gt(id = "one") |>
  gt_theme_mg() |>
  rm_stubhead() |> 
  tab_options(
    column_labels.padding = px(20),
    column_labels.padding.horizontal = px(0)
  ) |>
  cols_align("center", everything()) |>
  cols_width(
    study ~ px(165),
    everything() ~ px(45)
  ) 




  opt_css(
    css = "
    #one .gt_col_heading {
      text-align: center;
      transform: rotate(-90deg);
      font-weight: bold;
      vertical-align: bottom;
      line-height: 40px;
    }
    "
  )

th.rotate {
  /* Something you can count on */
  height: 140px;
  white-space: nowrap;
}




<th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1" scope="col" id="study">study</th>

study_arm_dat |> select(starts_with("gen_"))

writexl::write_xlsx(expanded_dat, "/Users/mgrant/Desktop/expanded_dat.xlsx")
```

::: panel-tabset
## General

```{r general}
x <- 1
x

```

## Targeted

```{r specific}
x <- 2
x

```
:::

## **References** {#references}

<body>

::: vertical-text
```         
doggys
```
:::

</body>


<vertical-text>mark  </vertical-text> 

change


```{r}
#| eval: false
library(flextable)

iris |> 
  slice(1:5) |> 
  rename()
  gt() |> 
  gt_theme_mg()

ft <- flextable(iris)
ft <- rotate(ft, rotation = "tbrl", part = "header", align = "center")
ft <- align(ft, align = "right")
max_width <- max(dim_pretty(ft, part = "header")$widths)
ft <- height(ft, height = max_width, part = "header")

print(ft, preview = "html")


```
