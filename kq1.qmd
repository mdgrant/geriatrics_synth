---
title: "Expanded Preoperative Evaluation & <br/> Postoperative Delirium Screening"
editor: source
toc-title: "Expanded Preoperative Evaluation and Postoperative Delirium Screening"
toc-location: "left"
cap-location: "top"
toc-depth: 4
page-layout: full
css: styles.css
tables:
      style: Table
      caption:
        pre: "Table "
        sep: " -- "
bibliography: "bib/kq18.bib"
csl: jama.csl
link-citations: false
nocite: '@*'
---

## Key Questions

Among older patients anticipating surgery and anesthesia, does expanded preoperative evaluation (e.g., for frailty, cognitive impairment, functional status, or psychosocial issues) lead to improved postoperative outcomes?

Does screening older patients for delirium in the post anesthesia care unit improve postoperative outcomes?

```{r, read_data}
#| include: false
source("code/load_data.R")
```

```{r, data}
# note working file not renamed
study_char_dat <- study_char_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)

study_arm_dat <- study_arm_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)

dichot_dat <- dichot_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)

contin_dat <- contin_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)

likert_dat <- likert_dat |> 
  filter(refid %in% c(kq1_refid, kq8_refid)) |> 
  arrange(design_f)


```

## **Outcome Importance Rankings**

### Expanded Preoperative Evaluation

<font size = 4> `r table_ref()` Rankings of the 5 most important outcomes (11 respondents). </font>

```{r, outcome_priority_kq1}
#| include: true
#| eval: true
outcome_dat <- rankings("KQ1")
outcome_tab(outcome_dat, 11)
```

### Postoperative Delirium Screening

<font size = 4> `r table_ref()` Rankings of the 5 most important outcomes (11 respondents). </font>

```{r, outcome_priority_kq8}
#| include: true
#| eval: true
outcome_dat <- rankings("KQ8")
outcome_tab(outcome_dat, 11)
```

## **Outcomes Reported**

<font size = 4> `r table_ref()` Dichotomous or count outcomes. </font>

```{r dichot_outcome_freq}
dichot_freq_fun(dichot_dat, "ADL: activities of daily living; NCR: neurocognitive recovery; NCD: neurocognitive disorder; QoR: quality of recovery; ")
```

<font size = 4> `r table_ref()` Continuous outcomes. </font>

```{r cont_outcome_freq}
contin_freq_fun(contin_dat)
```

<font size = 4> `r table_ref()` Likert or ordinal outcomes. </font>

```{r likert_outcome_freq}
likert_freq_fun(likert_dat, "ADL: activities of daily living; NCR: neurocognitive recovery; NCD: neurocognitive disorder; QoR: quality of recovery; ")
```

## **Included Studies ⦁**

<font size = 4> `r table_ref()` Number of studies by design. </font>

```{r studies_design}
# CODE: study design table — design and number; no duplicate counting
study_char_dat |>
  arrange(year) |> 
  group_by(linked_references_all_refid) |> # count 1 for multiple pubs from single study
  slice(1) |> 
  ungroup() |> 
  # select(refid, study, linked_references_all_refid, design_f_lab) |> # to check studies > 1 report
  select(refid, study, design_f_lab) |>
  group_by(design_f_lab, .drop = TRUE) |>
  summarise(total = n()) |>
  adorn_totals("row") |>
  gt(id = "one") |>
  cols_label(design_f_lab = "Design", total = "Studies") |>
  cols_width(
    # design_f_lab ~ px(200),
    design_f_lab ~ "1.8in",
    total ~ ".5in"
  ) |>
  gt_theme_mg() |> 
  tab_style(
    style = list(
      cell_fill(color = "#E4F3FE"),
      cell_text(weight = "bold"),
      cell_borders(sides = c("top", "bottom"), color = "#9A9EA1", style = "solid", weight = px(1.3))
    ),
    locations = cells_body(
      rows = design_f_lab == "Total"
    )
  ) |> 
  tab_style(
    style = list(
      cell_text(align = "left")),
      locations = cells_body(
        columns = design_f_lab
      )
    )  |> 
  tab_footnote("Studies with multiple publications counted only once (applied to 2 studies with 2 publications).")
```

### Design, centers, country, and surgery

<font size = 4> `r table_ref()` Study design, enrollment, centers, country, and surgery (see [References](#references) for citations). </font>

```{r included_studies_table}
#| echo: false
included_dat <- study_char_dat |>
  mutate(study_l = study_l_w_linked) |>
  select(refid, starts_with("design"), study_l, year, n_enroll, n_analyze, centers, country, non_vh_hdi) |>
  left_join(surgs |> select(refid, surgs), by = "refid") |>
  mutate(
    surgs = ifelse(str_count(surgs, "\\|") > 3, "Various", surgs),
    # edit levels by kq
    surgs = factor(surgs, levels = c("Ortho", "Urol", "GI/Abdominal", "Neuro", "Neuro|Vasc", "Cardiac", "Gyn", "Gyn|Ortho|Urol|Vasc", "Headneck", "Ophtho", "Other", "Spine", "Various", "Vasc"))
  ) |>
  arrange(design_f, surgs, study_l) |>
  select(refid, design_f, study_l, centers, n_enroll, country, surgs, non_vh_hdi)

included_dat |>
  gt(id = "one") |>
  cols_label(
    refid = "ID",
    study_l = "Study",
    n_enroll = "Enrolled",
    country = "Country",
    centers = "Centers",
    surgs = "Surgery"
   ) |>
  cols_hide(c(non_vh_hdi, design_f)) |>
    fmt_markdown(columns = c(study_l)) |> 
  cols_width(
    refid ~ px(60),
    study_l ~ px(220),
    centers ~ px(60),
    n_enroll ~ px(60),
    country ~ px(100),
    surgs ~ px(150)
  ) |> 
  # opt_horizontal_padding(scale = 2) |>
  sub_missing(columns = everything(), missing_text = " — ") |>
  gt_theme_mg() |>
  tab_style(style = cell_text(align = "center"), locations = cells_column_labels(columns = c("refid"))) |> 
  tab_style(style = cell_text(align = "left"),   locations = cells_body(columns = c(surgs))) |>
  tab_style(style = cell_text(align = "left"),   locations = cells_column_labels(columns = c(surgs))) |>
  opt_footnote_marks(marks = "letters") |> 
  tab_footnote(footnote = md("Various indicates more than 4 different types of surgery."), locations = cells_column_labels(columns = surgs)) |>
  tab_footnote(footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."), 
               locations = cells_column_labels(columns = country)) |>
  tab_footnote(footnote = md("Non very-high [Human Development Index](https://en.wikipedia.org/wiki/List_of_countries_by_Human_Development_Index) country."), 
               locations = cells_body(columns = country, rows = !is.na(non_vh_hdi))) |>
  # tab_footnote(footnote = "Studies examining drugs not directly relevant to recommendations but potentially relevant to the evidence space (eg, a connected network) were included.",  locations = cells_row_groups(groups = )) |> 
  tab_footnote("GI: gastrointestinal; Ortho: orthopedic; Neuro: neurological; Oralmax: oral maxillofacial; Vasc: vascular.")

```

#### Country Summary

<font size = 4> `r table_ref()` Summary of studies by country where conducted. </font>

```{r country}
#| echo: false
study_char_dat |>
  mutate(linked_references = ifelse(is.na(linked_references), refid, linked_references)) |> 
  slice(1, .by = linked_references) |>
  select(country) |>
  tbl_summary(
    sort = everything() ~ "frequency",
    label = list(country ~ "Country")
  ) |>
  modify_header(label ~ "") |> 
  as_gt(id = "one") |> 
  gt_theme_mg()

```

## **Expanded Evaluation**

<font size = 4> `r table_ref()` Components of expanded preoperative evaluation and interventions prompted. </font>

```{r comparators}
#| eval: true
expanded_dat <- study_arm_dat |>
  filter(refid %in% kq1_refid) |>
  select(refid, year, study, study_l, arm_id, arm_kq1_eval, kq1_eras, gen_blood, gen_comp, gen_multi, gen_comorbid, gen_nutrition, gen_other, gen_unspec, kq1_frail, kq1_cog, kq1_phys_func, kq1_psych, pt_nutr, pt_mobility, pt_surgery, pt_social, pt_other, staff_comorbid, staff_inappmed, staff_geriatrician, staff_multidisc, staff_supplement, staff_treatplan, staff_other) |>
  left_join(surgs |> select(refid, surgs_single), by = "refid") |> 
  left_join(study_char_dat |> select(refid, design_f_lab, design_f_abbrev), by = "refid") |> 
  mutate(
    arm = ifelse(arm_kq1_eval == "eval_expand", "Exp", "Std"),
    across(gen_blood:gen_unspec, ~ notna_to_x(.x, symbol = " \U2713")),
    across(kq1_frail:kq1_psych, ~ notna_to_x(.x, symbol = " \U25CF")),
    across(pt_nutr:pt_other, ~ notna_to_x(.x, symbol = " \U25CB")),
    across(staff_comorbid:staff_other, ~ notna_to_x(.x, symbol = " \UFFED")),
    kq1_eras = ifelse(kq1_eras == "eras_yes", "  x", NA),
    surg_design = paste0(surgs_single, " — ", design_f_lab)
  ) 

groups_kq1 <- c("Cardiac — Randomized Clinical Trial", "Cardiac — Before-After/Time Series", "GI/Abd — Randomized Clinical Trial", "GI/Abd — Before-After/Time Series", "GI/Abd — Retrospective Cohort", "Ortho — Before-After/Time Series", "Ortho — Randomized Clinical Trial", "Various — Randomized Clinical Trial", "Various — Before-After/Time Series", "Neuro — Before-After/Time Series", "Urol — Before-After/Time Series") 

expanded_dat |> 
  # filter(refid == 12826) |>
  arrange(study, arm_id) |> 
  select(refid, study, study_l, arm_id, arm, surg_design, kq1_eras:staff_other) |> 
  mutate(study = ifelse(study == "Tarazona-Santabalbina 2019", "T-Santabalbina 2019", study),
         study_l = str_replace(study_l, "Tarazona-", "T-")) |> 
  # mutate(study_l = ifelse(row_number() > 1, "", study_l),
  #        .by = study) |>
  filter(if_any(kq1_eras:kq1_psych, ~ !is.na(.x))) |>
  select(-arm_id) |> 
  distinct() |>
  group_by(surg_design) |> 
  gt(id = "one") |>
  row_group_order(groups = groups_kq1) |>
  gt_theme_mg() |>
  sub_missing(columns = everything(), missing_text = "") |>
  cols_hide(c(refid, study, gen_unspec, arm)) |>
  fmt_markdown(columns = c(study_l)) |>
  cols_label(
    study_l              = md("Study"),
    # arm                  = "Arm",
    # kq1_eras             = md(vert_lab_fun("ERAS")),
    kq1_eras             = md("<vertical-text>ERAS</vertical-text>"),
    gen_blood            = md(vert_lab_fun("Blood work")),
    gen_comp             = md(vert_lab_fun("CGA")),
    gen_multi            = md(vert_lab_fun("Multidisciplinary")),
    gen_comorbid         = md(vert_lab_fun("Meds/Comorbidity")),
    gen_nutrition        = md(vert_lab_fun("Nutrition")),
    gen_other            = md(vert_lab_fun("Other")),
    # gen_unspec           = md(vert_lab_fun("No detail")),
    kq1_frail            = md(vert_lab_fun("Frailty")), 
    kq1_cog              = md(vert_lab_fun("Cognitive")), 
    kq1_phys_func        = md(vert_lab_fun("Physical Function")), 
    kq1_psych            = md(vert_lab_fun("Psychosocial")),
    pt_nutr              = md(vert_lab_fun("Nutrition")),
    pt_mobility          = md(vert_lab_fun("Physical activity")),
    pt_surgery           = md(vert_lab_fun("Procedure")),
    pt_social            = md(vert_lab_fun("Social ties")),
    pt_other             = md(vert_lab_fun("Other")),
    staff_comorbid       = md(vert_lab_fun("Rx comorbidities")),
    staff_inappmed       = md(vert_lab_fun("Deprescribing")),
    staff_geriatrician   = md(vert_lab_fun("Geriatric visits")),
    staff_multidisc      = md(vert_lab_fun("Multidisciplinary")),
    staff_supplement     = md(vert_lab_fun("Nutritional suppl")),
    staff_treatplan      = md(vert_lab_fun("Treatment plan")),  
    staff_other          = md(vert_lab_fun("Other")),
  ) |> 
  cols_width(
    study_l        ~ px(165),
    kq1_eras:staff_other ~ px(25),
  ) |> 
  tab_spanner(label = "General", columns = c(gen_blood:gen_unspec), level = 1) |>
  tab_spanner(label = "Targeted", columns = c(kq1_frail:kq1_psych), level = 1) |>
  tab_spanner(label = "Assessments", columns = c(gen_blood:kq1_psych), level = 2) |>
  tab_spanner(label = "Patient Education", columns = c(pt_nutr:pt_other), level = 1) |>
  tab_spanner(label = "Staff Interventions", columns = c(staff_comorbid:staff_other), level = 1) |>
  tab_spanner(label = "Interventions", columns = c(pt_nutr:staff_other), level = 2) |>
  tab_style(style = cell_text(align = "right"), locations = cells_column_labels(columns = c(kq1_eras:staff_other))) |> 
  tab_style(style = cell_text(align = "right"), locations = cells_body(columns = c(kq1_psych:staff_other))) |> 
  tab_style(style = list(cell_text(color = color_1)), locations = cells_column_labels(columns = c(gen_blood:gen_other))) |> 
  tab_style(style = list(cell_text(color = color_2)), locations = cells_column_labels(columns = c(kq1_frail:kq1_psych))) |> 
  tab_style(style = list(cell_text(color = color_3)), locations = cells_column_labels(columns = c(pt_nutr:pt_other))) |> 
  tab_style(style = list(cell_text(color = color_4)), locations = cells_column_labels(columns = c(staff_comorbid:staff_other))) |> 
  tab_style(style = list(cell_text(color = color_1)), locations = cells_body(columns = c(gen_blood:gen_other), rows = everything())) |> 
  tab_style(style = list(cell_text(color = color_2)), locations = cells_body(columns = c(kq1_frail:kq1_psych), rows = everything())) |> 
  tab_style(style = list(cell_text(color = color_3)), locations = cells_body(columns = c(pt_nutr:pt_other), rows = everything())) |> 
  tab_style(style = list(cell_text(color = color_4)), locations = cells_body(columns = c(staff_comorbid:staff_other), rows = everything())) |> 
  tab_style(style = list(cell_text(color = color_1)), locations = cells_column_spanners(spanners = "General")) |> 
  tab_style(style = list(cell_text(color = color_2)), locations = cells_column_spanners(spanners = "Targeted")) |> 
  tab_style(style = list(cell_text(color = color_3)), locations = cells_column_spanners(spanners = "Patient Education")) |> 
  tab_style(style = list(cell_text(color = color_4)), locations = cells_column_spanners(spanners = "Staff Interventions"))

```

<!-- ::: panel-tabset -->
<!-- ## General -->

<!-- ```{r general} -->
<!-- x <- 1 -->
<!-- x -->

<!-- ``` -->

<!-- ## Targeted -->

<!-- ```{r specific} -->
<!-- x <- 2 -->
<!-- x -->

<!-- ``` -->
<!-- ::: -->

## **References** {#references}

